(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{11:function(e,t){e.exports={adds:[],add:function(e){this.adds.forEach(function(t){return t(e)})},onAdd:function(e){this.adds.push(e)}}},43:function(e,t,r){e.exports=r(93)},48:function(e,t,r){},52:function(e,t,r){},60:function(e,t,r){},93:function(e,t,r){"use strict";r.r(t);var n=r(0),i=r.n(n),a=r(38),s=r.n(a),o=(r(48),r(50),r(2)),c=r(3),u=r(6),l=r(4),p=r(7),h=(r(52),r(5)),d=r(10),f=r(8),v=r(42);function y(e){var t=document.location;t.search&&t.search.substring(1).split("&").forEach(function(t){var r=t.split("=");e[r[0]]=r[1]});return e}var g=function(e,t,r){return e.addEventListener(t,r)};function m(e){return JSON.stringify(e)}function b(e,t){return{x:e,y:t,minus:function(e){return b(this.x-e.x,this.y-e.y)},add:function(e){return b(this.x+e.x,this.y+e.y)},divide:function(e){return b(this.x/e,this.y/e)},multiply:function(e){return b(this.x*e,this.y*e)},idivide:function(e){return b(Math.floor(this.x/e),Math.floor(this.y/e))},floor:function(){return b(Math.floor(this.x),Math.floor(this.y))},distance:function(e){var t=e.x-this.x,r=e.y-this.y;return Math.sqrt(t*t+r*r)},equals:function(e){return e.x===this.x&&e.y===this.y},toString:function(){return"(".concat(e,",").concat(t,")")}}}function w(e){var t=y({}),r={};Object.keys(t).forEach(function(e){return r[e]=t[e]}),Object.keys(e).forEach(function(t){return r[t]=e[t]});var n=Object.keys(r).map(function(e){return"".concat(e,"=").concat(r[e])}).join("&");window.history.pushState(e,"a title","?"+n)}function k(e){return Object.keys(e).map(function(t){return"".concat(t,"=").concat(e[t])}).join("&")}var O=function(e){var t="grid fill",r=e.leftWidth,n=e.rightWidth;e.showLeft||(t+=" hide-left",r=0),e.showRight||(t+=" hide-right",n=0);var a={gridTemplateColumns:"\n    [left] ".concat(r,"px\n    [left-resize] 2px\n    [center] auto\n    [right-resize] 2px\n    [right] ").concat(n,"px\n    ")};return i.a.createElement("div",{className:t,style:a},e.children)},S=function(e){var t="toolbar";return e.left&&(t+=" left"),e.right&&(t+=" right"),e.bottom&&(t+=" bottom"),e.top&&(t+=" top"),e.center&&(t+=" center"),e.middle&&(t+=" middle"),e.scroll&&(t+=" scroll"),i.a.createElement("div",{className:t},e.children)},x=function(e){var t="panel";return e.left&&(t+=" left"),e.right&&(t+=" right"),e.bottom&&(t+=" bottom"),e.top&&(t+=" top"),e.center&&(t+=" center"),e.middle&&(t+=" middle"),e.scroll&&(t+=" scroll"),e.transparent&&(t+=" transparent"),i.a.createElement("div",{className:t},e.children)},C=function(e){return i.a.createElement("span",{className:"spacer"})},M=function(e){var t=e.selected,r=Object(v.a)(e,["selected"]),n=t?"selected":"";return i.a.createElement("button",Object.assign({className:n},r))},j=function(e){return i.a.createElement(h.g,{className:"popup-menu"},e.actions.map(function(e,t){return e.divider?i.a.createElement("div",{className:"divider",key:t}):i.a.createElement("button",{key:t,onClick:function(){h.f.hide(),e.fun&&e.fun()}},i.a.createElement("i",{className:"fa fa-"+e.icon})," ",e.title)}))},E=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).toggleLeftPane=function(e){return r.setState({showLeft:!r.state.showLeft})},r.toggleRightPane=function(e){return r.setState({showRight:!r.state.showRight})},r.onMouseDownLeft=function(e){e.preventDefault(),e.stopPropagation(),r.setState({dragSide:"left"}),window.addEventListener("mousemove",r.onMouseMove),window.addEventListener("mouseup",r.onMouseUp)},r.onMouseDownRight=function(e){e.preventDefault(),e.stopPropagation(),r.setState({dragSide:"right"}),window.addEventListener("mousemove",r.onMouseMove),window.addEventListener("mouseup",r.onMouseUp)},r.onMouseMove=function(e){e.preventDefault(),e.stopPropagation();var t=b(e.clientX,e.clientY);"left"===r.state.dragSide&&r.setState({leftWidth:t.x}),"right"===r.state.dragSide&&r.setState({rightWidth:window.innerWidth-t.x})},r.onMouseUp=function(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("mousemove",r.onMouseMove),window.removeEventListener("mouseup",r.onMouseUp)},r.state={showLeft:!0,showRight:!0,leftWidth:250,rightWidth:250,dragSide:"none"},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(O,{showLeft:this.state.showLeft,showRight:this.state.showRight,leftWidth:this.state.leftWidth,rightWidth:this.state.rightWidth},i.a.createElement(S,{center:!0,bottom:!0},i.a.createElement("button",{className:"fa"+(this.state.showLeft?" fa-caret-left":" fa-caret-right"),onClick:this.toggleLeftPane}),i.a.createElement(C,null),this.props.bottomText,i.a.createElement(C,null),i.a.createElement("button",{className:"fa"+(this.state.showRight?" fa-caret-right":" fa-caret-left"),onClick:this.toggleRightPane})),i.a.createElement("div",{className:"left-resize",onMouseDown:this.onMouseDownLeft}),i.a.createElement("div",{className:"right-resize",onMouseDown:this.onMouseDownRight}),this.props.children)}}]),t}(n.Component),A="CHANGED",P="DROP_TARGET",D=new(function(){function e(t){Object(o.a)(this,e),this.listeners={},this.selected=[],this.dropTarget=null,this.clip=null}return Object(c.a)(e,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"off",value:function(e,t){var r=this.listeners[e].indexOf(t);r>=0&&this.listeners[e].splice(r,1)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"setSelection",value:function(e){this.selected=[e],this.fire(A,this)}},{key:"addToSelection",value:function(e){this.selected.push(e),this.fire(A,this)}},{key:"clearSelection",value:function(){this.selected=[],this.fire(A,this)}},{key:"isSelected",value:function(e){return this.selected.indexOf(e)>=0}},{key:"getSelection",value:function(){return 0===this.selected.length?null:this.selected[0]}},{key:"isEmpty",value:function(){return 0===this.selected.length}},{key:"getFullSelection",value:function(){return this.selected}},{key:"setDropTarget",value:function(e){this.dropTarget!==e&&(this.dropTarget=e,this.fire(P,this.dropTarget))}},{key:"getDropTarget",value:function(){return this.dropTarget}},{key:"setDropType",value:function(e){this.dropType=e}},{key:"getDropType",value:function(){return this.dropType}},{key:"setClipboard",value:function(e){this.clip=e}},{key:"getClipboard",value:function(){return this.clip}}]),e}()),L=r(16),I=r.n(L),T=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).mousePress=function(e){var t=r.canvasToPoint(e);r.setState({lightness:t.x,value:t.y}),r.redraw(),r.pressed=!0},r.mouseMove=function(e){if(r.pressed){var t=r.canvasToPoint(e);r.setState({lightness:t.x,value:t.y}),r.redraw()}},r.mouseUp=function(e){r.pressed=!1,r.redraw()},r.redraw=function(){r.drawPicker(),r.drawSlider(),r.drawIndicator()},r.livalToCanvas=function(e,t){return b(e/100*100,t/100*100)},r.mouseToCanvas=function(e){var t=e.target.getBoundingClientRect();return b(e.clientX,e.clientY).minus(b(t.x,t.y))},r.mousePressSlider=function(e){r.sliderPressed=!0;var t=r.mouseToCanvas(e),n=r.canvasToHue(t);r.setState({hue:n}),setTimeout(r.redraw,100)},r.mouseMoveSlider=function(e){if(r.sliderPressed){var t=r.mouseToCanvas(e),n=r.canvasToHue(t);r.setState({hue:n}),setTimeout(r.redraw,100)}},r.mouseUpSlider=function(){r.sliderPressed=!1},r.close=function(){var e=I.a.hsluvToHex([Math.floor(r.state.hue),Math.floor(r.state.lightness),Math.floor(r.state.value)]);e.length>7&&(e="#000000"),r.props.onSelect(e),h.f.hide()};var n=I.a.hexToHsluv(e.value);return r.state={hue:n[0],lightness:n[1],value:n[2]},console.log("the current value is",e.value,I.a.hexToHsluv(e.value)),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.redraw()}},{key:"canvasToPoint",value:function(e){var t=this.canvas.getBoundingClientRect(),r=b(e.clientX,e.clientY).minus(b(t.x,t.y)),n=this.canvas.height,i=this.canvas.width;return b(r.x/i*100,r.y/n*100)}},{key:"drawPicker",value:function(){if(this.canvas){for(var e=this.canvas.getContext("2d"),t=Math.floor(this.state.hue),r=0;r<=4;r++)for(var n=0;n<=4;n++){var i=I.a.hsluvToHex([t,25*r,25*n]);i.length>7&&(i="#000000"),e.fillStyle=i,e.fillRect(20*r,20*n,20,20)}var a=20,s=this.livalToCanvas(this.state.lightness,this.state.value);e.strokeStyle="white",e.strokeRect(Math.floor(s.x/a)*a,Math.floor(s.y/a)*a,a,a),e.strokeStyle="black",e.strokeRect(Math.floor(s.x/a)*a+1,Math.floor(s.y/a)*a+1,18,18),e.strokeStyle="black",e.lineWidth=1,e.strokeRect(0,0,100,100)}}},{key:"canvasToHue",value:function(e){return Math.floor(e.x/this.slider.width*360)}},{key:"hueToCanvas",value:function(e){return e/360*this.slider.width}},{key:"drawSlider",value:function(){var e=this.slider.getContext("2d"),t=this.slider.width,r=this.slider.height;e.fillStyle="red",e.fillRect(0,0,t,r);for(var n=0;n<t;n+=10){var i=this.canvasToHue(b(n,0)),a=I.a.hsluvToHex([i,100,50]);a.length>7&&(a="#000000"),e.fillStyle=a,e.fillRect(n,0,10,r)}e.strokeStyle="black",e.lineWidth=1;var s=10*Math.floor(this.hueToCanvas(this.state.hue)/10);e.strokeRect(s,0,10,r),e.strokeRect(0,0,t,r)}},{key:"drawIndicator",value:function(){var e=this.indicator.getContext("2d"),t=this.indicator.width,r=this.indicator.height,n=I.a.hsluvToHex([Math.floor(this.state.hue),Math.floor(this.state.lightness),Math.floor(this.state.value)]);n.length>7&&(n="#000000"),e.fillStyle=n,e.fillRect(0,0,t,r),e.strokeStyle="black",e.lineWidth=1,e.strokeRect(0,0,t,r)}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"}},i.a.createElement("canvas",{ref:function(t){return e.canvas=t},width:100,height:100,onMouseDown:this.mousePress,onMouseMove:this.mouseMove,onMouseUp:this.mouseUp}),i.a.createElement("canvas",{ref:function(t){return e.slider=t},width:100,height:30,onMouseDown:this.mousePressSlider,onMouseMove:this.mouseMoveSlider,onMouseUp:this.mouseUpSlider}),i.a.createElement("canvas",{ref:function(t){return e.indicator=t},width:32,height:32,onClick:this.close}))}}]),t}(n.Component),R=r(11),B="USER_CHANGE",N=new(function(){function e(){var t=this;Object(o.a)(this,e),this.login=function(e){t.win=window.open(e.url,"_blank"),window.addEventListener("message",t.authCallback),t.win&&t.win.focus()},this.logout=function(){localStorage.clear(),t.doclistSupported=!1,t.fire(B)},this.authCallback=function(e){t.setUserData(e.data.payload),t.win.close(),window.removeEventListener("message",t.authCallback),t.doclistSupported=!0,t.fire(B),R.add("login succeeded")},this.listeners={},this.supported=!1,this.doclistSupported=!1,this.docDeleteSupported=!1,this.assetUploadSupported=!1,this.scriptEditingSupported=!1,this.passwordSupported=!1,this.connected=!1}return Object(c.a)(e,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"init",value:function(){var e=this;this.isLoggedIn()&&(this.doclistSupported=!0),fetch(G.BASE+"info").then(function(e){return e.json()}).then(function(t){console.info("Server Info:",t),!0===t.authentication&&(e.supported=!0),!0===t.passwordSupported&&(e.passwordSupported=!0),!0===t.assetUpload&&(e.assetUploadSupported=!0),!0===t.scriptEditing&&(e.scriptEditingSupported=!0),!0===t.docDeleteSupported&&(e.docDeleteSupported=!0),e.getJSON(V()).then(function(t){t.success?(e.fire(B),e.doclistSupported=!0):e.logout()}).then(function(){e.connected=!0,e.fire("CONNECTED")})})}},{key:"isConnected",value:function(){return this.connected}},{key:"isLoggedIn",value:function(){return!!localStorage.getItem("access-token")}},{key:"supportsPassword",value:function(){return this.passwordSupported}},{key:"supportsAuth",value:function(){return this.supported}},{key:"supportsDocList",value:function(){return this.doclistSupported}},{key:"supportsAssetUpload",value:function(){return this.assetUploadSupported}},{key:"supportsScriptEdit",value:function(){return this.scriptEditingSupported}},{key:"supportsDocDelete",value:function(){return this.docDeleteSupported}},{key:"doPasswordLogin",value:function(e){var t=this;return localStorage.setItem("access-token",e),this.getJSON(V()).then(function(e){!0===e.success?(console.log("the logged in response is",e),t.doclistSupported=!0,R.add("login succeeded"),t.fire(B)):(R.add("login failed"),t.fire(B))})}},{key:"setUserData",value:function(e){localStorage.setItem("access-token",e.accessToken)}},{key:"getAccessToken",value:function(){return localStorage.getItem("access-token")}},{key:"getUsername",value:function(){return this.getAccessToken()}},{key:"fetch",value:function(e){function t(t,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.mode="cors",t.cache="no-cache",t.headers||(t.headers={}),t.headers["access-key"]=N.getAccessToken(),console.log("fetching",e,"with options",t),fetch(e,t)})},{key:"getJSON",value:function(e){return this.fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()})}}]),e}()),F={EXPANDED_CHANGED:"EXPANDED_CHANGED",STRUCTURE_CHANGED:"STRUCTURE_CHANGED",STRUCTURE_ADDED:"STRUCTURE_ADDED",STRUCTURE_REMOVED:"STRUCTURE_REMOVED",PROPERTY_CHANGED:"PROPERTY_CHANGED",CLEAR_DIRTY:"CLEAR_DIRTY",SAVED:"SAVED",DOCUMENT_SWAPPED:"DOCUMENT_SWAPPED"},G={BASE:"https://vr.josh.earth/generaled/api/"};function U(){return G.BASE+"doc/"}function z(){return G.BASE+"asset/"}function H(){return G.BASE+"scripts/"}function V(){return G.BASE+"userinfo"}var W=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).genID=function(e){return"".concat(e,"_").concat(Math.floor(1e3*Math.random()*1e3*1e3))},r.save=function(){console.info("saving",r.getSceneRoot());var e={doc:r.getSceneRoot(),type:r.getDocType(),id:r.getDocId()},t=JSON.stringify(e,function(e,t){if("parent"!==e)return t});return console.info("doc is",t),N.fetch(U()+r.docid,{method:"POST",body:t,headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){console.log("Success result is",e),w({mode:"edit",doc:r.docid,doctype:r.getDocType()}),r.fire(F.SAVED,!0)}).catch(function(e){return console.log("error",e)})},r.hasChildren=function(e){return e&&e.children&&e.children.length},r.getChildren=function(e){return e.children},r.listeners={},r.expanded_map={},r.docid=null,e.SERVER_URL&&(G.BASE="https://".concat(e.SERVER_URL,"/")),console.log("using server",G.BASE),N.init(),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"off",value:function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(function(e){return e!==t}))}},{key:"isExpanded",value:function(e){return e.id||(e.id=""+Math.random()),"undefined"===typeof this.expanded_map[e.id]&&(this.expanded_map[e.id]=!0),this.expanded_map[e.id]}},{key:"toggleItemCollapsed",value:function(e){var t=this.isExpanded(e);this.expanded_map[e.id]=!t,this.fire(F.EXPANDED_CHANGED,e)}},{key:"setPropertyValue",value:function(e,t,r){throw new Error("subclass of TreeItemProvider must implement setPropertyValue")}},{key:"setDocument",value:function(e,t){this.root=e,this.docid=t,this.fire(F.STRUCTURE_CHANGED,{provider:this})}},{key:"getDocId",value:function(){return this.docid}},{key:"loadDoc",value:function(e){var t=this;console.log("need to load the doc",e),N.getJSON(U()+e).then(function(e){if(console.log("got the doc",e),e.type!==t.getDocType())throw new Error("incorrect doctype for this provider",e.type);t.setDocument(e.doc,e.id)}).catch(function(e){console.warn("missing doc",e),t.setDocument(t.makeEmptyRoot(),t.genID("doc")),w({mode:"edit",doc:t.docid,doctype:t.getDocType()})})}},{key:"reloadDocument",value:function(){var e=this,t=this.generateSelectionPath(D.getSelection());console.log("got the path",t),N.getJSON(U()+this.docid).then(function(r){if(r.type!==e.getDocType())throw new Error("incorrect doctype for this provider",r.type);e.setDocument(r.doc,r.id),e.fire(F.CLEAR_DIRTY,!0);var n=e.findNodeFromSelectionPath(e.getSceneRoot(),t);console.log("set new selection to ",n),D.setSelection(n)}).catch(function(e){console.warn("couldn't reload the doc",e)})}},{key:"generateSelectionPath",value:function(){throw new Error("generateSelectionPath not implemented")}},{key:"findNodeFromSelectionPath",value:function(){throw new Error("findNodeFromSelectionPath not implemented")}},{key:"makeEmptyRoot",value:function(){throw new Error("makeEmptyRoot() not implemented")}},{key:"getSceneRoot",value:function(){return this.root}},{key:"uploadFile",value:function(e){return new Promise(function(t,r){(new FormData).append("file",e),console.info("filesize is",e.size,e.name);var n=new XMLHttpRequest;n.onreadystatechange=function(){return console.log("ready state = ".concat(n.readyState," status ").concat(n.status))},n.addEventListener("progress",function(e){return console.log("progress")}),n.addEventListener("load",function(e){return t(n.response)}),n.addEventListener("error",function(e){return console.log("error")}),n.addEventListener("abort",function(e){return console.log("abort")});var i=z()+e.name;console.info("uploading to ",i),n.responseType="json",n.open("POST",i),n.setRequestHeader("access-key",N.getAccessToken()),n.send(e)})}}]),t}(function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"on",value:function(e,t){throw new Error("interface 'on' not implemented")}},{key:"off",value:function(e,t){throw new Error("interface 'off' not implemented")}},{key:"fire",value:function(e,t){throw new Error("interface 'fire' not implemented")}},{key:"getSceneRoot",value:function(){throw new Error("interface 'getSceneRoot' not implemented")}},{key:"deleteChild",value:function(e){throw new Error("deleteChild not implemented yet")}},{key:"appendChild",value:function(e,t){throw new Error("appendChild not implemented yet")}},{key:"insertNodeBefore",value:function(e,t){throw new Error("insertNodeBefore() not implemented yet")}},{key:"findNodeById",value:function(e){throw new Error("findNodeById() not implemented yet")}},{key:"findParent",value:function(e){throw new Error("findParent() not implemented yet")}},{key:"hasChildren",value:function(e){throw new Error("hasChildren() not implemented yet")}},{key:"getChildren",value:function(e){throw new Error("getChildren() not implemented yet")}},{key:"isExpanded",value:function(e){throw new Error("interface 'isExpanded' not implemented")}},{key:"calculateContextMenu",value:function(e){throw new Error("calculateContextMenu() not implemented yet")}},{key:"toggleItemCollapsed",value:function(e){throw new Error("toggleItemCollapsed() not implemented yet")}},{key:"getRendererForItem",value:function(e){throw new Error("getRendererForItem() not implemented yet")}},{key:"setPropertyValue",value:function(e,t,r){throw new Error("interface setPropertyValue not implemented")}},{key:"setPropertyValueByName",value:function(e,t,r){throw new Error("interface 'setPropertyValueByName() not implemented'")}},{key:"getProperties",value:function(e){throw new Error("interface 'getProperties()' not implemented")}},{key:"getDocId",value:function(){throw new Error("getDocId() not implemented")}},{key:"getDocType",value:function(){throw new Error("getDocType() not implemented")}},{key:"getApp",value:function(){throw new Error("getApp() not implemented")}},{key:"getTitle",value:function(){throw new Error("getTitle() not implemented")}}]),e}()),K=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).keypressed=function(e){13===e.charCode&&r.props.onCommit()},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this.props.def;if(e.hasHints()&&e.getHints().multiline)return i.a.createElement("textarea",{value:this.props.value,onChange:this.props.onChange,onBlur:this.props.onBlur});return i.a.createElement("input",{type:"string",value:this.props.value,onChange:this.props.onChange,onKeyPress:this.keypressed,onBlur:this.props.onBlur})}}]),t}(n.Component),Y=function(e){var t=e.renderer,r=e.values.map(function(r){return i.a.createElement(h.d,{key:r,onClick:function(t){return e.onSelect(r)}},i.a.createElement(t,{value:r,def:e.def,obj:e.obj,provider:e.provider}))});return i.a.createElement(h.g,{className:"popup-menu"},r)},Z=function(e){var t="";return"undefined"!==typeof e.value&&null!==e.value&&(t=e.value.toString()),i.a.createElement("span",null,t)},Q=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(a)))).open=function(e){h.f.show(i.a.createElement(Y,{values:r.calculateValues(),renderer:r.calculateRenderer(),onSelect:r.selectValue,provider:r.props.provider}),e.target)},r.selectValue=function(e){h.f.hide(),r.props.onChange(e)},r.renderValue=function(e){var t=r.props.def,n=r.props.obj,a=r.calculateRenderer();return i.a.createElement(a,{value:e,def:t,obj:n,provider:r.props.provider})},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"calculateRenderer",value:function(){var e=this.props.def,t=this.props.obj;if(!this.props.provider.getRendererForEnum)return Z;var r=this.props.provider.getRendererForEnum(e.getKey(),t);return r||Z}},{key:"calculateValues",value:function(){var e=this.props.provider.getValuesForEnum(this.props.def.getKey(),this.props.obj,this.props.def);return e||(console.log("no values for enum ".concat(this.props.def.getKey())),[])}},{key:"render",value:function(){return i.a.createElement("button",{onClick:this.open},this.renderValue(this.props.value))}}]),t}(n.Component),J=function(e){var t="";return"undefined"!==typeof e.value&&(t=e.value.toString()),i.a.createElement("span",null,t)},q=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).addValue=function(){r.setState({showEditor:!0})},r.enumChanged=function(e){var t=r.props.value.slice();t.push(e),r.props.onChange(t)},r.state={showEditor:!1,value:""},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"calculateRenderer",value:function(){var e=this.props.def,t=this.props.obj;if(!this.props.provider.getRendererForEnum)return J;var r=this.props.provider.getRendererForEnum(e.key,t);return r||J}},{key:"render",value:function(){var e=this.props.value;return e||(e=[]),i.a.createElement("div",null,this.renderValues(),i.a.createElement("button",{onClick:this.addValue,className:"fa fa-plus"}),this.renderEditor())}},{key:"deleteItem",value:function(e){var t=this.props.value.slice();t=t.filter(function(t){return t!==e}),this.props.onChange(t)}},{key:"renderValues",value:function(){var e=this,t=this.calculateRenderer();return i.a.createElement(h.g,null,this.props.value.map(function(r,n){return i.a.createElement("div",{key:n},i.a.createElement("button",{className:"fa fa-minus",onClick:function(){return e.deleteItem(r)}}),i.a.createElement(t,{value:r,provider:e.props.provider}))}))}},{key:"renderEditor",value:function(){if(!this.state.showEditor)return"";var e=this.props.def,t=this.props.obj;return i.a.createElement(Q,{value:this.state.value,onChange:this.enumChanged,def:e,obj:t,provider:this.props.provider})}}]),t}(n.Component),$={STRING:"string",NUMBER:"number",BOOLEAN:"boolean",ENUM:"enum",COLOR:"color",GROUP:"group"},X=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).changed=function(e){r.props.def.isType($.STRING)&&(r.setState({value:e.target.value}),r.props.def.isLive()&&r.props.def.setValue(e.target.value)),r.props.def.isType($.NUMBER)&&r.updateNum(e.target.value),r.props.def.isType($.BOOLEAN)&&r.setState({value:e.target.checked})},r.customChanged=function(e){if(r.props.def.isType($.COLOR))return r.colorChanged(e);r.setState({value:e}),r.props.def.setValue(e)},r.keypressed=function(e){13===e.charCode&&r.commit()},r.updateNum=function(e){var t=r.props.def;t.hasHints()&&(t.getHints().hasOwnProperty("min")&&e<t.getHints().min&&(e=t.getHints().min),t.getHints().hasOwnProperty("max")&&e>t.getHints().max&&(e=t.getHints().max)),r.setState({value:e}),isNaN(parseFloat(e))||t.setValue(parseFloat(e))},r.numberKeyDown=function(e){"ArrowUp"===e.key&&e.shiftKey&&(e.preventDefault(),r.updateNum(r.state.value+10)),"ArrowDown"===e.key&&e.shiftKey&&(e.preventDefault(),r.updateNum(r.state.value-10))},r.booleanChanged=function(e){r.setState({value:e.target.checked}),r.props.def.setValue(e.target.checked)},r.enumChanged=function(e){r.setState({value:e}),r.props.def.setValue(e)},r.arrayChanged=function(e){r.setState({value:e}),r.props.def.setValue(e)},r.colorChanged=function(e){r.setState({value:e}),r.props.def.setValue(e)},r.commit=function(){r.props.def.setValue(r.state.value)},r.openColorEditor=function(e){h.f.show(i.a.createElement(T,{onSelect:r.colorChanged,value:r.state.value}),e.target)},r.state={value:e.def.getValue()},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentWillReceiveProps",value:function(e){this.props.def!==e.def&&this.setState({value:e.def.getValue()})}},{key:"shouldComponentUpdate",value:function(e,t){return"group"===e.def.getType()||(this.state.value!==t.value||(this.props.def.getKey()!==e.def.getKey()||this.props.def.getValue()!==e.def.getValue()))}},{key:"render",value:function(){var e=this.props.def,t=D.getSelection(),r=this.props.provider;if(e.isCustom())return this.props.provider.createCustomEditor(this.props.item,e,r,this.state.value,this.customChanged);if(e.isLocked())return i.a.createElement("i",null,e.getValue());if(e.isType($.STRING))return i.a.createElement(K,{value:this.state.value,onChange:this.changed,onBlur:this.commit,onCommit:this.commit,def:e,obj:t,provider:this.props.provider});if(e.isType($.NUMBER)){var n=1;if(e.hasHints()){var a=e.getHints();a.incrementValue&&(n=a.incrementValue)}return i.a.createElement("input",{type:"number",value:this.state.value,onChange:this.changed,onKeyPress:this.keypressed,onKeyDown:this.numberKeyDown,onBlur:this.commit,step:n})}return e.isType($.BOOLEAN)?i.a.createElement("input",{type:"checkbox",checked:this.state.value,onChange:this.booleanChanged}):e.isType($.ENUM)?i.a.createElement(Q,{value:this.state.value,onChange:this.enumChanged,def:e,obj:t,provider:this.props.provider}):e.isType($.COLOR)?i.a.createElement("button",{style:{backgroundColor:this.state.value},onClick:this.openColorEditor},this.state.value):e.isType("array")?i.a.createElement(q,{value:this.state.value,onChange:this.arrayChanged,def:e,obj:t,provider:this.props.provider}):i.a.createElement("b",null,e.getType(),":",e.getValue())}}]),t}(n.Component),_=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).state={selection:null},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.h2=function(){return e.setState({selection:D.getSelection()})},this.props.provider.on(F.PROPERTY_CHANGED,this.h2),this.hand=function(t){return e.setState({selection:D.getSelection()})},D.on(A,this.hand)}},{key:"componentWillUnmount",value:function(){D.off(A,this.hand),this.props.provider.off(F.PROPERTY_CHANGED,this.h2)}},{key:"render",value:function(){var e=this,t=this.calculateGroups(this.calculateProps()),r=D.getSelection();return i.a.createElement("ul",{className:"prop-sheet"},t.map(function(t,n){return[i.a.createElement("label",{key:t.getKey()+"-label"},t.getName()),e.renderIndeterminate(t,n),i.a.createElement(X,{key:t.getKey()+"-editor",def:t,provider:e.props.provider,item:r})]}))}},{key:"renderIndeterminate",value:function(e,t){return e.isIndeterminate()?i.a.createElement("i",{key:e.getKey()+"-indeterminate",className:"icon fa fa-exclamation-circle"}):""}},{key:"calculateProps",value:function(){var e=D.getFullSelection(),t=e[0],r=this.props.provider,n=r.getProperties(t);return e.forEach(function(e){var t,i;t=n,i=r.getProperties(e),n=t.filter(function(e){return i.find(function(t){return e.key===t.key})})}),n.map(function(t){var n=new ee(r,t.key);return e.forEach(function(e){var i=r.getProperties(e).find(function(e){return e.key===t.key});n.addSubProxy(new te(r,e,i))}),n})}},{key:"calculateGroups",value:function(e){return e.filter(function(e){return e.getType()===$.GROUP}).forEach(function(t){var r=t.getGroupKeys();e=e.filter(function(e){return r.indexOf(e.getKey())<0})}),e}}]),t}(n.Component);var ee=function(){function e(t,r){Object(o.a)(this,e),this.provider=t,this.key=r,this.subs=[]}return Object(c.a)(e,[{key:"addSubProxy",value:function(e){this.subs.push(e)}},{key:"first",value:function(){return this.subs[0]}},{key:"getName",value:function(){return this.first().getName()}},{key:"getValue",value:function(){return this.first().getValue()}},{key:"isCustom",value:function(){return this.first().isCustom()}},{key:"hasHints",value:function(){return this.first().hasHints()}},{key:"getHints",value:function(){return this.first().getHints()}},{key:"isLocked",value:function(){return this.first().isLocked()}},{key:"getType",value:function(){return this.first().getType()}},{key:"isType",value:function(e){return this.first().isType(e)}},{key:"isLive",value:function(){return this.first().isLive()}},{key:"getKey",value:function(){return this.key}},{key:"getGroupKeys",value:function(){return this.first().getGroupKeys()}},{key:"setValue",value:function(e){this.subs.forEach(function(t){return t.setValue(e)})}},{key:"isIndeterminate",value:function(){var e=!0,t=this.first().getValue();return this.subs.forEach(function(r){r.getValue()!==t&&(e=!1)}),!e}}]),e}(),te=function(){function e(t,r,n){Object(o.a)(this,e),this.provider=t,this.item=r,this.def=n}return Object(c.a)(e,[{key:"getKey",value:function(){return this.def.key}},{key:"getName",value:function(){return this.def.name}},{key:"isCustom",value:function(){return this.def.custom}},{key:"isLocked",value:function(){return this.def.locked}},{key:"getType",value:function(){return this.def.type}},{key:"getValue",value:function(){return this.def.value}},{key:"isLive",value:function(){return this.def.live}},{key:"isType",value:function(e){return this.def.type===e}},{key:"setValue",value:function(e){return this.provider.setPropertyValue(this.item,this.def,e)}},{key:"hasHints",value:function(){return this.def.hints}},{key:"getHints",value:function(){return this.def.hints}},{key:"getGroupKeys",value:function(){return this.def.group}},{key:"isIndeterminate",value:function(){return!1}}]),e}();function re(e){return Array.prototype.slice.call(e)}function ne(e,t){return e.createObject(t)}function ie(e,t){var r={};return e.getPropertiesForObject(t).forEach(function(n){r[n]=e.getPropertyValue(t,n)}),r.id=t,r}function ae(e,t){for(var r=e.getArrayLength(t),n=[],i=0;i<r;i++)n.push(e.getElementAt(t,i));return n}function se(e,t,r){e.setProperty(r.id,"parent",t.id);var n=e.getPropertyValue(t.id,"children");e.insertAfter(n,null,r.id)}function oe(e,t,r){e.setProperty(r.id,"parent",t.id);var n=e.getPropertyValue(t.id,"children"),i=e.getArrayLength(n),a=e.getElementAt(n,i-1);e.insertAfter(n,a,r.id)}function ce(e,t){var r=ie(e,t.parent),n=function(e,t,r){return ae(e,t).findIndex(function(e){return e===r})}(e,r.children,t.id);n>=0?e.removeElement(r.children,n):console.error("could not find index for child",t,"in children",r.children)}var ue=function(e){return i.a.createElement(h.g,{className:"popup-menu"},e.menu.map(function(e,t){return e.divider?i.a.createElement("div",{className:"divider",key:t}):i.a.createElement("button",{key:t,onClick:function(){h.f.hide(),e.fun&&e.fun()}},i.a.createElement("i",{className:"fa fa-"+e.icon})," ",e.title)}))},le=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(a)))).onSelect=function(e){e.shiftKey?D.addToSelection(r.props.node):D.setSelection(r.props.node)},r.onContextMenu=function(e){if(e.preventDefault(),e.stopPropagation(),r.props.provider.calculateContextMenu){var t=r.props.provider.calculateContextMenu(r.props.node);h.f.show(i.a.createElement(ue,{menu:t}),e.target)}},r.toggleItemCollapsed=function(e){e.preventDefault(),e.stopPropagation(),r.props.provider.toggleItemCollapsed(r.props.node)},r.onDragStart=function(e){r.props.onDragStart(e,r.props.node)},r.onDragOver=function(e){r.props.onDragOver(e,r.props.node)},r.onDragEnd=function(e){r.props.onDragEnd(e,r.props.node)},r.onDrop=function(e){r.props.onDrop(e,r.props.node)},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e="tree-node",t=this.props.node;D.isSelected(t)&&(e+=" selected"),D.getDropTarget()===t&&(e+=" drop-target","parent"===D.getDropType()&&(e+=" drop-parent"));var r="",n=this.props.provider;n.hasChildren(t)?r=n.isExpanded(t)?i.a.createElement("button",{className:"fa fa-caret-down fa-fw borderless",onClick:this.toggleItemCollapsed}):i.a.createElement("button",{className:"fa fa-caret-right fa-fw borderless",onClick:this.toggleItemCollapsed}):r=i.a.createElement("span",{className:"fa fa-fw borderless"});return i.a.createElement("div",{className:e,onClick:this.onSelect,onContextMenu:this.onContextMenu,"data-nodeid":t.id,onDragOver:this.onDragOver,onDrop:this.onDrop},i.a.createElement("span",{style:{width:1.5*this.props.depth+"em"}}),r,n.getRendererForItem(t),i.a.createElement(C,null),this.renderDragBars())}},{key:"renderDragBars",value:function(){return this.props.provider.canBeMoved&&!this.props.provider.canBeMoved(this.props.node)?"":i.a.createElement("span",{className:"drag fa fa-bars",draggable:!0,onDragStart:this.onDragStart,onDragEnd:this.onDragEnd})}}]),t}(n.Component),pe=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).onDragStart=function(e,t){console.log("starting to drag the item",t),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.parentNode),e.dataTransfer.setDragImage(e.target.parentNode,20,20),e.dataTransfer.dropEffect="move",r.setState({dragTarget:t,internalDrag:!0})},r.onDragOver=function(e,t){if(!r.state.internalDrag)return e.preventDefault(),void(r.props.provider.canAddExternalChild(t,e.dataTransfer)?(D.setDropTarget(t),D.setDropType("parent")):(D.setDropType(null),D.setDropTarget(null)));var n=r.props.provider;if(n.canAddChild(t,r.state.dragTarget))return D.setDropTarget(t),void D.setDropType("parent");n.canBeSibling(t,r.state.dragTarget)?(D.setDropType("sibling"),D.setDropTarget(t)):(D.setDropType(null),D.setDropTarget(null))},r.onDragEnd=function(e,t){if(!r.state.internalDrag)return r.setState({dragTarget:null,internalDrag:!1}),e.preventDefault(),void e.stopPropagation();var n=r.props.provider.getDataGraph(),i=ie(n,r.state.dragTarget),a=ie(n,r.state.dropTarget);if(a.id===i.id)return r.setState({dragTarget:null,internalDrag:!1}),void D.setDropTarget(null);if(ce(n,i),"parent"===D.getDropType())n.setProperty(i.id,"parent",a.id),n.insertAfter(a.children,null,i.id);else{var s=ie(n,a.parent);n.setProperty(i.id,"parent",s.id),n.insertAfter(s.children,a.id,i.id)}r.setState({dragTarget:null}),D.setDropTarget(null)},r.onDrop=function(e,t){r.state.internalDrag||(e.stopPropagation(),e.preventDefault(),r.props.provider.acceptDrop(e,t),r.setState({internalDrag:!1,dragTarget:null}))},r.generateChildren=function(e,t,n){var i=r.props.provider;t.push({node:e,depth:n}),i.hasChildren(e)&&i.isExpanded(e)&&i.getChildren(e).forEach(function(e){r.generateChildren(e,t,n+1)})},r.state={root:r.props.root,dropTarget:null,selection:null,dragTarget:null,internalDrag:!1},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.listener=this.props.provider.on(F.EXPANDED_CHANGED,function(t){return e.setState({root:e.props.provider.getSceneRoot()})}),this.props.provider.on(F.STRUCTURE_ADDED,function(t){return e.setState({root:e.props.provider.getSceneRoot()})}),this.props.provider.on(F.STRUCTURE_CHANGED,function(t){return e.setState({root:e.props.provider.getSceneRoot()})}),this.other_listener=D.on(A,function(t){return e.setState({selection:t})}),D.on(P,function(t){return e.setState({dropTarget:D.getDropTarget()})})}},{key:"componentWillUnmount",value:function(){this.props.provider.off(F.EXPANDED_CHANGED,this.listener),D.off(A,this.other_listener)}},{key:"componentWillReceiveProps",value:function(e){e.root&&this.setState({root:e.root})}},{key:"render",value:function(){var e=this;if(!this.state.root)return i.a.createElement("ul",null,"no root yet");var t=[];return this.generateChildren(this.state.root,t,0),i.a.createElement("ul",{className:"tree-table"},t.map(function(t,r){return i.a.createElement(le,{key:r,node:t.node,depth:t.depth,provider:e.props.provider,selection:e.state.selection,onDragStart:e.onDragStart,onDragOver:e.onDragOver,onDragEnd:e.onDragEnd,onDrop:e.onDrop})}))}}]),t}(n.Component),he={PIXEL:{name:"pixel",matches:["pixel","pixels","px"],short:"px"},MILLIMETER:{name:"millimeter",matches:["mm"],short:"mm"}},de=72;var fe=function(){function e(t,r,n){Object(o.a)(this,e),this.width=t,this.height=r,this.unit=n}return Object(c.a)(e,[{key:"as",value:function(t,r,n){if(this.unit.name===he.MILLIMETER.name&&t.name===he.PIXEL.name){var i=n;return new e(.0393701*this.width*i*r*1,.0393701*this.height*i*r*1,t)}return new e(this.width*r,this.height*r,t)}}]),e}(),ve=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).selectionChanged=function(e){return r.setState({selection:e})},r.redraw=function(){if(r.canvas){var e=r.canvas.getContext("2d"),t=r.props.prov.getPageSize(r.props.prov.getSelectedPage()).as(he.PIXEL,r.props.scale,de);r.canvas.width=t.width,r.canvas.height=t.height,e.fillStyle="white",e.fillRect(0,0,r.canvas.width,r.canvas.height),e.save(),e.scale(r.props.scale,r.props.scale);var n=r.props.prov.getRawGraph(),i=r.props.prov.getSelectedPage();i&&r.drawPage(e,n,i),e.fillStyle="rgba(0,255,255,0.5)",r.state.hsnap&&e.fillRect(r.state.hsnap.value-1,0,2,r.canvas.height),r.state.vsnap&&e.fillRect(0,r.state.vsnap.value-1,r.canvas.width,2),e.restore()}},r.onClick=function(e){var t=r.toCanvas(e),n=r.findShape(t);n&&r.props.onSelect(n)},r.mouseDown=function(e){r.props.prov.pauseQueue();var t=r.toCanvas(e),n=r.findShape(t);if(n){var i=ie(r.props.prov.getRawGraph(),n);r.setState({pressed:!0,initial:b(i.x,i.y).minus(t),start:t,shape:n})}else{var a=r.props.prov.getSelectedLayer();a&&D.setSelection(a.id)}},r.mouseMove=function(e){if(r.state.pressed){var t=r.toCanvas(e).add(r.state.initial);t=r.snap(t);var n=r.props.prov.getRawGraph();n.process(r.props.prov.cmd.setProperty(r.state.shape,"x",t.x)),n.process(r.props.prov.cmd.setProperty(r.state.shape,"y",t.y))}},r.mouseUp=function(e){r.setState({pressed:!1,hsnap:null,vsnap:null}),r.props.prov.unpauseQueue()},r.state={pressed:!1,selection:null,shape:null,hsnap:null,vsnap:null},e.prov.onRawChange(function(e){-1!==r.props.list&&r.redraw()}),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){D.on(A,this.selectionChanged),this.props.prov.on(F.STRUCTURE_CHANGED,this.redraw)}},{key:"componentWillUnmount",value:function(){D.off(A,this.selectionChanged),this.props.prov.off(F.STRUCTURE_CHANGED,this.redraw)}},{key:"toCanvas",value:function(e){var t=e.target.getBoundingClientRect();return b(Math.floor((e.clientX-t.left)/this.props.scale),Math.floor((e.clientY-t.top)/this.props.scale))}},{key:"componentDidUpdate",value:function(e){this.redraw()}},{key:"drawPage",value:function(e,t,r){var n=this;ae(t,r.children).forEach(function(r){return n.drawLayer(e,t,ie(t,r))})}},{key:"drawLayer",value:function(e,t,r){var n=this;ae(t,r.children).forEach(function(r){return n.drawShape(e,t,ie(t,r))})}},{key:"drawShape",value:function(e,t,r){var n=this.props.prov.getShapeDef(r.type);n&&n.draw(e,t,r,D.getSelection()===r.id,this.props.prov)}},{key:"isInside",value:function(e,t){var r=ie(this.props.prov.getRawGraph(),t),n=this.props.prov.getShapeDef(r.type);return!!n&&n.isInside(e,r,this.canvas)}},{key:"findShape",value:function(e){var t=this,r=this.props.prov,n=r.getSelectedLayer();if(!n)return null;var i=ae(r.getRawGraph(),n.children);return i.reverse(),i.find(function(r){return t.isInside(e,r)})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{className:"panel"},i.a.createElement("canvas",{style:{border:"0px solid red"},width:100,height:100,ref:function(t){return e.canvas=t},onClick:this.onClick,onMouseDown:this.mouseDown,onMouseUp:this.mouseUp,onMouseMove:this.mouseMove}))}},{key:"snap",value:function(e){var t={LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER",TOP:"TOP",MIDDLE:"MIDDLE",BOTTOM:"BOTTOM",NONE:"NONE"},r=[{value:0,type:t.LEFT},{value:320,type:t.CENTER},{value:640,type:t.RIGHT},{value:0,type:t.TOP},{value:240,type:t.MIDDLE},{value:480,type:t.BOTTOM}],n=20;function i(e,r){return r.type===t.LEFT&&Math.abs(e.x-r.value)<n?t.LEFT:r.type===t.CENTER&&Math.abs(e.x+e.width/2-r.value)<n?t.CENTER:r.type===t.RIGHT&&Math.abs(e.x+e.width-r.value)<n?t.RIGHT:t.NONE}function a(e,r){return r.type===t.TOP&&Math.abs(e.y-r.value)<n?t.TOP:r.type===t.MIDDLE&&Math.abs(e.y+e.height/2-r.value)<n?t.MIDDLE:r.type===t.BOTTOM&&Math.abs(e.y+e.height-r.value)<n?t.BOTTOM:t.NONE}var s=ie(this.props.prov.getRawGraph(),this.state.shape),o=this.props.prov.getShapeDef(s.type),c=null,u=null;if(o)for(var l=o.getBounds(e,s,this.canvas),p=0;p<r.length;p++){var h=r[p],d=i(l,h);d===t.LEFT&&(e.x=h.value),d===t.CENTER&&(e.x=h.value-l.width/2),d===t.RIGHT&&(e.x=h.value-l.width);var f=a(l,h);f===t.TOP&&(e.y=h.value),f===t.MIDDLE&&(e.y=h.value-l.height/2),f===t.BOTTOM&&(e.y=h.value-l.height),d!==t.NONE&&(c=h),f!==t.NONE&&(u=h)}return this.setState({hsnap:c,vsnap:u}),e}}]),t}(n.Component),ye=r(19),ge=ye.SET_PROPERTY,me=ye.CREATE_PROPERTY,be=ye.DELETE_PROPERTY,we=ye.CREATE_OBJECT,ke=ye.DELETE_OBJECT,Oe=ye.INSERT_ELEMENT,Se=ye.DELETE_ELEMENT,xe=function(){function e(t){Object(o.a)(this,e),this.graph=t,this.history=[],this.current=-1}return Object(c.a)(e,[{key:"submit",value:function(e){this.history.push(e),this.current=this.history.length-1}},{key:"canUndo",value:function(){return this.current>=0}},{key:"canRedo",value:function(){return this.current<this.history.length-1}},{key:"undo",value:function(){var e=this.history[this.current];if(this.current--,e.type!==ge)if(e.type!==me)if(e.type!==we){if(e.type!==Oe)throw new Error("undo for type not supported: ".concat(e.type));var t={type:Se,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),array:e.array,entry:e.entryid};this.graph.process(t)}else{var r={type:ke,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),id:e.id};this.graph.process(r)}else{var n={type:be,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name};this.graph.process(n)}else{if(!e.prevValue)return void console.warn("undoing set property without a previous value!",e);var i={type:ge,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.prevValue};this.graph.process(i)}}},{key:"redo",value:function(){this.current++;var e=this.history[this.current];if(e.type!==ge)if(e.type!==me)if(e.type!==we){if(e.type!==Oe)throw new Error("redo for type not supported: ".concat(e.type));console.log("redoing",e);var t={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),array:e.array,value:e.value,entryid:this.graph.makeGUID(),prev:-1};this.graph.process(t)}else{var r={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),id:e.id};this.graph.process(r)}else{var n={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.value};this.graph.process(n)}else{var i={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.value};this.graph.process(i)}}},{key:"dump",value:function(){return this.history.map(function(e,t){return t+" "+e.type+" "+e.name+" => "+e.value})}}]),e}(),Ce=r(19).SET_PROPERTY,Me=function(){function e(t){var r=this;Object(o.a)(this,e),this.onChange=function(e){return r.listeners.push(e)},this.onRawChange=function(e){return r.rawlisteners.push(e)},this.fire=function(e){return r.listeners.forEach(function(t){return t(e)})},this.fireRaw=function(e){return r.rawlisteners.forEach(function(t){return t(e)})},this.getPropertiesForObject=function(e){return r.graph.getPropertiesForObject(e)},this.getArrayLength=function(e){return r.graph.getArrayLength(e)},this.getElementAt=function(e,t){return r.graph.getElementAt(e,t)},this.getHostId=function(){return r.graph.getHostId()},this.graph=t,this.listeners=[],this.rawlisteners=[],this.paused=!1,this.buffer=[],this.first={},this.last={}}return Object(c.a)(e,[{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var e=this;this.paused=!1,this.buffer=[],Object.keys(this.last).forEach(function(t){Object.keys(e.last[t]).forEach(function(r){var n=e.last[t][r];n.prevValue=e.first[t][r].value,e.fire(n),e.graph.process(n)})}),this.first={},this.last={}}},{key:"getPropertyValue",value:function(e,t){return this.paused&&this.last[e]&&this.last[e][t]?this.last[e][t].value:this.graph.getPropertyValue(e,t)}},{key:"bufferOp",value:function(e){this.first[e.object]||(this.first[e.object]={}),this.first[e.object][e.name]||(this.first[e.object][e.name]=e),this.last[e.object]||(this.last[e.object]={}),this.last[e.object][e.name]=e,this.buffer.push(e),this.fireRaw(e)}},{key:"process",value:function(e){e.type===Ce&&this.paused?this.bufferOp(e):(this.fire(e),this.graph.process(e))}}]),e}(),je=r(22),Ee=r(27),Ae=r.n(Ee);var Pe={publishKey:"pub-c-1cba58da-c59a-4b8b-b756-09e9b33b1edd",subscribeKey:"sub-c-39263f3a-f6fb-11e7-847e-5ef6eb1f4733"},De=function(){function e(t,r){var n=this;if(Object(o.a)(this,e),!t)throw new Error("created PubnubSyncWrapper without a provider");if(!r)throw new Error("created PubnubSyncWrapper without a graph");this.paused=!1,this.buffer=[],this.provider=t,r.onChange(function(e){return n.handleGraphChange(e)}),this.pubnub=new Ae.a(Pe)}return Object(c.a)(e,[{key:"calculateChannelName",value:function(){return"metadoc-docupdate-"+this.provider.getDocId()}},{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.provider.getDocId()}},{key:"start",value:function(){var e=this;this.pubnub.addListener({status:function(t){"PNSubscribeOperation"===t.operation&&"PNConnectedCategory"===t.category&&e.sendHistoryRequest()},message:function(t){return e.handleMessage(t)}}),this.pubnub.subscribe({channels:[this.calculateChannelName(),this.calculateLoggerChannelName()]})}},{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var e=this;this.paused=!1,this.buffer.forEach(function(t){return e.sendMessage(t)}),this.buffer=[]}},{key:"shutdown",value:function(){this.pubnub.unsubscribe({channels:[this.calculateChannelName()]}),this.pubnub.stop()}},{key:"sendMessage",value:function(e){var t,r;console.log("PN_SEND:",(r="".concat((t=e).type," ").concat(t.uuid," |  "),t.name&&(r+="".concat(t.name," = ").concat(t.value,"  prev = ").concat(t.prevValue)),r)),this.pubnub.publish({channel:this.calculateChannelName(),message:e},function(e,t){})}},{key:"handleGraphChange",value:function(e){var t=this.provider.getDataGraph().getHostId();if(e.host===t)return this.paused?this.buffer.push(e):void this.sendMessage(e)}},{key:"sendHistoryRequest",value:function(){this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"GET_HISTORY",host:this.provider.getDataGraph().getHostId()}})}},{key:"handleGetHistory",value:function(){var e=this.provider.getDataGraph(),t=e.getHistory().slice();console.log(t);for(var r=0;t.length>0;){if(r>100){console.log("breaking out. possible infinite loop");break}r++;var n=t.splice(0,30);console.log("sending",n.length,n),this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"SEND_HISTORY",host:e.getHostId(),history:n}},function(e,t){console.log("published",e,t)})}}},{key:"handleReceiveHistory",value:function(e){var t=this;e.history.forEach(function(e){return t.provider.getDataGraph().process(e)})}},{key:"handleMessage",value:function(e){if(!this.paused){if(e.channel!==this.calculateLoggerChannelName()){var t=this.provider.getDataGraph();if("GET_HISTORY"===e.message.type)return e.message.host!==t.getHostId()?this.handleGetHistory():void 0;if("SEND_HISTORY"===e.message.type)return e.message.host!==t.getHostId()?this.handleReceiveHistory(e.message):void 0;var r=e.message;return r.host?r.timestamp?void(r.host&&r.host===t.getHostId()||(console.log("REMOTE",r),t.process(r))):console.error("received a message without a timestamp",r):console.log("received a message without a host",r)}var n;e.publisher!==this.pubnub.getUUID()&&(e.message.length?(n=console).log.apply(n,["REMOTE LOGGER"].concat(Object(je.a)(e.message))):console.log("REMOTE LOGGER",e.message))}}},{key:"getLogger",value:function(){var e=this;return{log:function(t){console.log("LOGGER",t),e.pubnub.publish({channel:e.calculateLoggerChannelName(),message:t})},error:function(t){console.error("LOGGER ERROR",t),e.pubnub.publish({channel:e.calculateLoggerChannelName(),message:t})}}}}]),e}(),Le=function(){function e(t){Object(o.a)(this,e),this.docid=t,this.pubnub=new Ae.a(Pe)}return Object(c.a)(e,[{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.docid}},{key:"log",value:function(){var e;(e=console).log.apply(e,["LOGGER"].concat(Array.prototype.slice.call(arguments))),this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:Array.from(arguments)})}},{key:"error",value:function(){var e;(e=console).log.apply(e,["LOGGER ERROR"].concat(Array.prototype.slice.call(arguments))),this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:Array.from(arguments)})}}]),e}(),Ie=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){h.c.hide()},r.okay=function(){h.c.hide(),r.props.provider.createNewDocument(r.props.docid)},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,'Document "',i.a.createElement("b",null,this.props.docid),'" not found'),i.a.createElement(h.g,{grow:!0},"Create a new document?"),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(n.Component),Te=r(19),Re=Te.DocGraph,Be=Te.CommandGenerator;var Ne=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).getDocTitle=function(){return"untitled"},r.getDocHistory=function(){return r.getDataGraph().getHistory()},r.getDocGraph=function(){var e=r.getDataGraph().getObjectByProperty("type","root");return function e(t,r){var n=t.getPropertiesForObject(r),i={};return n.forEach(function(n){i[n]=t.getPropertyValue(r,n),"children"===n&&(i.children=ae(t,i[n]).map(function(r){return e(t,r)}))}),i.id=r,i}(r.getDataGraph(),e)},r.onRawChange=function(e){return r.rawlisteners.push(e)},r.getRawGraph=function(){return r.coalescer},r.getDataGraph=function(){return r.syncdoc},r.getSceneRoot=function(){return r.getDataGraph().getObjectByProperty("type","root")},r.hasChildren=function(e){return e&&r.getDataGraph().hasPropertyValue(e,"children")},r.getChildren=function(e){var t=r.getDataGraph();return ae(t,t.getPropertyValue(e,"children"))},r.isExpanded=function(e){return"undefined"===typeof r.expanded[e]&&(r.expanded[e]=!0),r.expanded[e]},r.save=function(e){e&&e.preventDefault();var t={history:r.getDocHistory(),type:r.getDocType(),id:r.getDocId(),graph:r.getDocGraph(),title:r.getDocTitle()},n=JSON.stringify(t);R.add("saving");var i={type:r.getDocType(),title:r.getDocTitle()},a=U()+r.getDocId()+"?"+k(i);return console.log("saving ".concat(n.length," chars to ").concat(a),t),N.fetch(a,{method:"POST",body:n,headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){console.log("got back result",e),w({mode:r.mode,doc:r.getDocId(),doctype:r.getDocType()}),R.add(e.message),r.fire(F.SAVED,!0)}).catch(function(e){return console.log("error",e)})},r.docLoaded=function(){},r.toggleConnected=function(){r.connected=!r.connected,r.pubnub&&(r.connected?r.pubnub.unpause():r.pubnub.pause()),r.fire("CONNECTED",r.connected)},r.isConnected=function(){return r.connected},r.pauseQueue=function(){return r.coalescer.pause()},r.unpauseQueue=function(){return r.coalescer.unpause()},r.performUndo=function(e){e&&e.preventDefault&&e.preventDefault(),r.undoqueue.canUndo()?r.undoqueue.undo():console.warn("at beginnning of the undo queue")},r.performRedo=function(e){e&&e.preventDefault&&e.preventDefault(),r.undoqueue.canRedo()&&r.undoqueue.redo()},r.options=e||{},r.mode=e.mode||"edit",r.datalisteners=[],r.rawlisteners=[],r.expanded={};var n=new Re;return r.makeEmptyRoot(n),r.setupDocFlow(n,r.genID("doc")),e.doc&&r.loadDoc(e.doc),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"toggleItemCollapsed",value:function(e){var t=this.isExpanded(e);this.expanded[e]=!t,this.fire(F.EXPANDED_CHANGED,e)}},{key:"setPropertyValue",value:function(e,t,r){var n=this.cmd.setProperty(e,t.key,r);n.prevValue=t.value,this.getRawGraph().process(n),this.fire(F.PROPERTY_CHANGED,{provider:this,child:e,propKey:t.key,oldValue:t.value,newValue:r})}},{key:"loadDoc",value:function(e){var t=this;return N.getJSON(U()+e).then(function(r){if(console.log("got the payload",r),!r.id)return t.showMissingDocDialog(e);var n=t.makeDocFromServerHistory(r.history);t.setupDocFlow(n,e)}).catch(function(t){console.error("there was an error loading doc",e,t)})}},{key:"createNewDocument",value:function(e){var t=new Re;this.makeEmptyRoot(t),this.setupDocFlow(t,e)}},{key:"setupDocFlow",value:function(e,t){var r=this;this.pubnub&&this.pubnub.shutdown(),this.pubnub=null,this.syncdoc=e,this.cmd=new Be(this.syncdoc),this.root=this.getSceneRoot(),this.docid=t,this.undoqueue=new xe(e),this.coalescer=new Me(this.syncdoc),this.coalescer.onChange(function(e){return r.undoqueue.submit(e)}),this.coalescer.onRawChange(function(e){return r.rawlisteners.forEach(function(t){return t(e)})}),this.syncdoc.onChange(function(e){return r.rawlisteners.forEach(function(t){return t(e)})}),this.syncdoc.onChange(function(e){r.fire(F.STRUCTURE_CHANGED,{provider:r}),r.fire(F.PROPERTY_CHANGED,{provider:r})}),this.fire(F.STRUCTURE_CHANGED,{provider:this}),this.fire(F.CLEAR_DIRTY,!0),D.clearSelection(),this.pubnub=new De(this,this.syncdoc),this.pubnub.unpause(),this.pubnub.start(),this.connected=!0,this.fire("CONNECTED",this.connected),this.fire(F.DOCUMENT_SWAPPED,{provider:this}),w({mode:this.mode,doc:this.getDocId(),doctype:this.getDocType()}),this.docLoaded()}},{key:"reloadDocument",value:function(){var e=this;return N.getJSON(U()+this.docid).then(function(t){if(t.type!==e.getDocType())throw new Error("incorrect doctype for this provider",t.type);var r=e.makeDocFromServerHistory(t.history);e.setupDocFlow(r,e.docid)}).catch(function(e){console.log("couldn't reload the doc",e)})}},{key:"makeDocFromServerHistory",value:function(e){var t=new Re;return e.forEach(function(e){return t.process(e)}),t}},{key:"showMissingDocDialog",value:function(e){h.c.show(i.a.createElement(Ie,{docid:e,provider:this}))}}]),t}(W),Fe=function(){function e(){var t=this;Object(o.a)(this,e),this.keyDown=function(r){var n=t.bindings.filter(function(e){return e.key===r.keyCode}).filter(function(t){var n=!0;return t.modifiers.forEach(function(t){t!==e.MODIFIERS.COMMAND||r.metaKey||(n=!1),t!==e.MODIFIERS.SHIFT||r.shiftKey||(n=!1)}),r.shiftKey&&!t.modifiers.some(function(t){return t===e.MODIFIERS.SHIFT})&&(n=!1),n});n.length>0&&t.dispatchEvents(n,r)},this.bindings=[],this.listeners={}}return Object(c.a)(e,[{key:"addKeyBinding",value:function(e){this.bindings.push(e)}},{key:"addListener",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"attachKeyEvents",value:function(e){e.addEventListener("keydown",this.keyDown)}},{key:"dispatchEvents",value:function(e,t){var r=this;e.forEach(function(e){r.listeners[e.id]&&r.listeners[e.id].forEach(function(e){return e?e(t):null})})}}]),e}();Fe.KEYS={S:83,Z:90,C:67,V:86,X:88,LEFT_ARROW:37,RIGHT_ARROW:39},Fe.MODIFIERS={COMMAND:"COMMAND",SHIFT:"SHIFT"};var Ge=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ie(e,e.createObject({type:"rect",title:"second rect",x:100,y:100,rx:20,ry:20,width:100,height:100,fillColor:"#ff00ff",parent:t.id}))}},{key:"draw",value:function(e,t,r,n){if(e.fillStyle="gray",e.fillStyle=r.fillColor,r.rx>0||r.ry>0){var i={x:r.x,y:r.y},a={x:r.x+r.width,y:r.y},s={x:r.x+r.width,y:r.y+r.height},o={x:r.x,y:r.y+r.height};e.beginPath(),e.moveTo(i.x+r.rx,i.y),e.lineTo(a.x-r.rx,a.y),e.quadraticCurveTo(a.x,a.y,a.x,a.y+r.ry),e.lineTo(s.x,s.y-r.ry),e.quadraticCurveTo(s.x,s.y,s.x-r.rx,s.y),e.lineTo(o.x+r.rx,o.y),e.quadraticCurveTo(o.x,o.y,o.x,o.y-r.ry),e.lineTo(i.x,i.y+r.ry),e.quadraticCurveTo(i.x,i.y,i.x+r.rx,i.y),e.closePath(),e.fill()}else e.fillRect(r.x,r.y,r.width,r.height);n&&(e.strokeStyle="red",e.strokeRect(r.x+.5,r.y+.5,r.width,r.height))}},{key:"isInside",value:function(e,t){return!(e.x<t.x)&&(!(e.x>t.x+t.width)&&(!(e.y<t.y)&&!(e.y>t.y+t.height)))}},{key:"getBounds",value:function(e,t){return{x:e.x,y:e.y,width:t.width,height:t.height}}},{key:"toSVGString",value:function(e){return'<rect x="'.concat(e.x,'" y="').concat(e.y,'" width="').concat(e.width,'" height="').concat(e.height,'" fill="').concat(e.fillColor,'"/>')}}]),e}(),Ue=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ie(e,ne(e,{type:"circle",title:"circle",x:100,y:100,radius:50,fillColor:"#ffff00",parent:t.id}))}},{key:"draw",value:function(e,t,r,n){e.fillStyle="gray",e.fillStyle=r.fillColor,e.beginPath(),e.arc(r.x,r.y,r.radius,0,2*Math.PI),e.fill(),n&&(e.strokeStyle="red",e.strokeRect(r.x-r.radius+.5,r.y-r.radius+.5,2*r.radius,2*r.radius))}},{key:"isInside",value:function(e,t){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)<Math.pow(t.radius,2)}},{key:"getBounds",value:function(e,t,r){return{x:e.x,y:e.y,width:2*t.radius,height:2*t.radius}}},{key:"toSVGString",value:function(e){return'<circle cx="'.concat(e.x,'" cy="').concat(e.y,'" r="').concat(e.radius,'" fill="').concat(e.fillColor,'"/>')}}]),e}(),ze=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ie(e,e.createObject({type:"text",title:"text",text:"title text",horizontalAlign:Ze.CENTER,verticalAlign:Ye.BASELINE,autoFit:!0,fontSize:30,fontFamily:Qe.SANSSERIF,fontWeight:Je.NORMAL,fontStyle:qe.NORMAL,x:100,y:100,width:200,height:120,fillColor:"#ff00ff",parent:t.id}))}},{key:"draw",value:function(e,t,r,n){var i=this.calculateLines(r,e),a=i.lines,s=i.size_px,o=i.total_height,c=i.total_width;a.forEach(function(e,t){var n=a.length*s;e.xoff=0,r.horizontalAlign===Ze.LEFT&&(e.xoff=0),r.horizontalAlign===Ze.CENTER&&(e.xoff=(c-e.width)/2),r.horizontalAlign===Ze.RIGHT&&(e.xoff=c-e.width),r.verticalAlign===Ye.TOP&&(e.yoff=0),r.verticalAlign===Ye.CENTER&&(e.yoff=(o-n)/2),r.verticalAlign===Ye.BASELINE&&(e.yoff=o-n),r.verticalAlign===Ye.BOTTOM&&(e.yoff=o-n),e.yoff+=(t+1)*e.height}),e.fillStyle=r.fillColor,a.forEach(function(t,n){return e.fillText(t.text,r.x+t.xoff,r.y+t.yoff)}),n&&(e.strokeStyle="red",e.strokeRect(r.x+.5,r.y+.5,c,o))}},{key:"calculateLines",value:function(e,t){var r=parseFloat(e.fontSize);t.font="normal ".concat(r,"px sans-serif");var n=e.text.split("\n").map(function(e){return{text:e,width:t.measureText(e).width,height:r}}),i=0,a=0;return e.autoFit?(i=n.reduce(function(e,t){return Math.max(e,t.width)},0),a=n.reduce(function(e,t){return e+t.height},0)):(i=e.width,a=e.height),{total_width:i,total_height:a,lines:n,size_px:r}}},{key:"insideRect",value:function(e,t,r,n,i){return!(e.x<t)&&(!(e.x>t+n)&&(!(e.y<r)&&!(e.y>r+i)))}},{key:"isInside",value:function(e,t,r){var n=r.getContext("2d"),i=this.calculateLines(t,n),a=i.total_width,s=i.total_height;return this.insideRect(e,t.x,t.y,a,s)}},{key:"getBounds",value:function(e,t,r){var n=r.getContext("2d"),i=this.calculateLines(t,n),a=i.total_width,s=i.total_height;return{x:e.x,y:e.y,width:a,height:s}}},{key:"toSVGString",value:function(e){return'<text x="'.concat(e.x,'" y="').concat(e.y,'"\n                     fill="').concat(e.fillColor,'" fontSize="').concat(e.fontSize,'"\n                     fontFamily="').concat(e.fontFamily,'"\n                >').concat(e.text,"</text>")}}]),e}(),He=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ie(e,e.createObject({type:"image",title:"image",x:100,y:100,width:50,height:50,asset:0,parent:t.id}))}},{key:"draw",value:function(e,t,r,n,i){if(r.asset){var a=t.getPropertyValue(r.asset,"src");i.isImageCached(a)?e.drawImage(i.getCachedImage(a),r.x,r.y,r.width,r.height):(i.requestImageCache(a),e.fillStyle="aqua",e.fillRect(r.x,r.y,r.width,r.height))}else e.fillStyle="aqua",e.fillRect(r.x,r.y,r.width,r.height);n&&(e.strokeStyle="red",e.strokeRect(r.x+.5,r.y+.5,r.width,r.height))}},{key:"isInside",value:function(e,t){return!(e.x<t.x)&&(!(e.x>t.x+t.width)&&(!(e.y<t.y)&&!(e.y>t.y+t.height)))}},{key:"toSVGString",value:function(e,t){console.log("serializing",e,t);var r=ie(t.getDataGraph(),e.asset);return console.log("asset is",r),'<image xlinkHref="'.concat(r.src,'"\n                      width="').concat(e.width,'" height="').concat(e.height,'"\n        />')}}]),e}(),Ve={title:{key:"title",name:"Title",type:$.STRING},x:{key:"x",name:"X",type:$.NUMBER},y:{key:"y",name:"Y",type:$.NUMBER},rx:{key:"rx",name:"RX",type:$.NUMBER},ry:{key:"ry",name:"RY",type:$.NUMBER},fillColor:{key:"fillColor",name:"color",type:$.COLOR,custom:!0},width:{key:"width",name:"Width",type:$.NUMBER},height:{key:"height",name:"Height",type:$.NUMBER},radius:{key:"radius",name:"Radius",type:$.NUMBER},text:{key:"text",name:"text",type:$.STRING,hints:{multiline:!0}},src:{key:"src",name:"src",type:$.STRING},asset:{key:"asset",name:"asset",type:$.ENUM},subtype:{key:"subtype",name:"kind",type:$.STRING,locked:!0},format:{key:"format",name:"format",type:$.STRING,locked:!0},autoFit:{key:"autoFit",name:"Size to Fit",type:$.BOOLEAN,locked:!1},fontSize:{key:"fontSize",name:"Font Size",type:$.STRING,locked:!1},fontFamily:{key:"fontFamily",name:"Font Family",type:$.ENUM,locked:!0},fontWeight:{key:"fontWeight",name:"Font Weight",type:$.ENUM,locked:!0},fontStyle:{key:"fontStyle",name:"Font Style",type:$.ENUM,locked:!0},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:$.ENUM,locked:!1},verticalAlign:{key:"verticalAlign",name:"V Align",type:$.ENUM,locked:!1},pageSize:{key:"pageSize",name:"Size",type:$.STRING,locked:!1,custom:!0}},We={rect:new Ge,circle:new Ue,text:new ze,image:new He},Ke={page:"file",layer:"sticky-note",rect:"square",circle:"circle",text:"font",plane:"plane",image:"image",model:"cube",cut:"cut",copy:"copy",paste:"paste",delete:"close"},Ye={TOP:"TOP",BASELINE:"BASELINE",CENTER:"CENTER",BOTTOM:"BOTTOM"},Ze={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"},Qe={SERIF:"serif",SANSSERIF:"sans-serif",MONOSPACE:"monospace"},Je={NORMAL:"normal",BOLD:"bold"},qe={NORMAL:"normal",ITALIC:"italic",OBLIQUE:"oblique"};function $e(e){return"rect"===e||("circle"===e||("text"===e||"image"===e))}var Xe=r(1),_e=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"updateProperty",value:function(e,t,r,n){if("tx"===r.name&&(e.position.x=parseFloat(r.value)),"ty"===r.name&&(e.position.y=parseFloat(r.value)),"tz"===r.name&&(e.position.z=parseFloat(r.value)),"rx"===r.name&&(e.rotation.x=parseFloat(r.value)),"ry"===r.name&&(e.rotation.y=parseFloat(r.value)),"rz"===r.name&&(e.rotation.z=parseFloat(r.value)),"sx"===r.name&&(e.scale.x=parseFloat(r.value)),"sy"===r.name&&(e.scale.y=parseFloat(r.value)),"sz"===r.name&&(e.scale.z=parseFloat(r.value)),"visible"===r.name&&(e.visible=r.value),"color"===r.name){var i=r.value;return 0===i.indexOf("#")&&(i=i.substring(1)),void e.material.color.set(parseInt(i,16))}}},{key:"reset",value:function(e,t){e.position.set(t.tx,t.ty,t.tz),e.visible=t.visible}}]),e}(),et=0,tt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return ie(e,e.createObject({type:jt.cube,title:"cube "+et++,visible:!0,width:1,height:1,depth:1,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Mesh(new Xe.BoxGeometry(e.width,e.height,e.depth),new Xe.MeshLambertMaterial({color:e.color}));return t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t}},{key:"updateProperty",value:function(e,r,n,i){if("width"!==n.name&&"height"!==n.name&&"depth"!==n.name)return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i);e.geometry=new Xe.BoxGeometry(r.width,r.height,r.depth)}}]),t}(_e),rt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return ie(e,e.createObject({type:"sphere",title:"a sphere",visible:!0,radius:.5,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#0000ff",children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Mesh(new Xe.SphereBufferGeometry(e.radius),new Xe.MeshLambertMaterial({color:e.color}));return t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t}},{key:"updateProperty",value:function(e,r,n,i){return"radius"===n.name&&(e.geometry=new Xe.SphereGeometry(n.value)),Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(_e),nt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create plane w/ missing parent");return ie(e,e.createObject({type:"plane",title:"a plane",visible:!0,width:3,height:3,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:e.createArray(),asset:0,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Xe.Mesh(new Xe.PlaneBufferGeometry(e.width,e.height),new Xe.MeshLambertMaterial({color:e.color,side:Xe.DoubleSide})),n=t.accessObject(e.asset);return console.log("asset is",n),n.exists()&&this.attachAsset(n,e,r,t),r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r}},{key:"updateProperty",value:function(e,r,n,i){if("width"===n.name&&(e.geometry=new Xe.PlaneBufferGeometry(n.value,r.height)),"height"===n.name&&(e.geometry=new Xe.PlaneBufferGeometry(r.width,n.value)),n.name===Ct.asset.key){var a=i.accessObject(r.asset);a.exists()&&this.attachAsset(a,r,e,i)}return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}},{key:"attachAsset",value:function(e,t,r,n){if(e.subtype===Bt.IMAGE){var i=(new Xe.TextureLoader).load(e.src);r.material=new Xe.MeshLambertMaterial({color:t.color,side:Xe.DoubleSide,map:i})}if(e.subtype===Bt.VIDEO){var a;n.videocache[e.src]?a=n.videocache[e.src]:((a=document.createElement("video")).crossOrigin="anonymous",a.src=e.src,n.videocache[e.src]=a);var s=new Xe.VideoTexture(a);r.material=new Xe.MeshLambertMaterial({color:t.color,side:Xe.DoubleSide,map:s})}}}]),t}(_e),it=r(1),at=function(){function e(e){this.manager=void 0!==e?e:it.DefaultLoadingManager}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype={constructor:e,crossOrigin:"Anonymous",load:function(e,t,r,n){var i=this,a=void 0!==this.path?this.path:it.LoaderUtils.extractUrlBase(e),s=new it.FileLoader(i.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){try{i.parse(e,a,t,n)}catch(r){if(void 0===n)throw r;n(r)}},r,n)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},parse:function(e,t,s,o){var l,p={};if("string"===typeof e)l=e;else if(it.LoaderUtils.decodeText(new Uint8Array(e,0,4))===a){try{p[r.KHR_BINARY_GLTF]=new c(e)}catch(d){return void(o&&o(d))}l=p[r.KHR_BINARY_GLTF].content}else l=it.LoaderUtils.decodeText(new Uint8Array(e));var h=JSON.parse(l);void 0===h.asset||h.asset.version[0]<2?o&&o(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead.")):(h.extensionsUsed&&(h.extensionsUsed.indexOf(r.KHR_LIGHTS)>=0&&(p[r.KHR_LIGHTS]=new n(h)),h.extensionsUsed.indexOf(r.KHR_MATERIALS_COMMON)>=0&&(p[r.KHR_MATERIALS_COMMON]=new i(h)),h.extensionsUsed.indexOf(r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS)>=0&&(p[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]=new u)),console.time("GLTFLoader"),new L(h,p,{path:t||this.path||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(function(e,t,r,n,i){console.timeEnd("GLTFLoader"),s({scene:e,scenes:t,cameras:r,animations:n,asset:i})},o))}};var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_LIGHTS:"KHR_lights",KHR_MATERIALS_COMMON:"KHR_materials_common",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness"};function n(e){this.name=r.KHR_LIGHTS,this.lights={};var t=(e.extensions&&e.extensions[r.KHR_LIGHTS]||{}).lights||{};for(var n in t){var i,a=t[n],s=(new it.Color).fromArray(a.color);switch(a.type){case"directional":(i=new it.DirectionalLight(s)).position.set(0,0,1);break;case"point":i=new it.PointLight(s);break;case"spot":(i=new it.SpotLight(s)).position.set(0,0,1);break;case"ambient":i=new it.AmbientLight(s)}i&&(void 0!==a.constantAttenuation&&(i.intensity=a.constantAttenuation),void 0!==a.linearAttenuation&&(i.distance=1/a.linearAttenuation),void 0!==a.quadraticAttenuation&&(i.decay=a.quadraticAttenuation),void 0!==a.fallOffAngle&&(i.angle=a.fallOffAngle),void 0!==a.fallOffExponent&&console.warn("THREE.GLTFLoader:: light.fallOffExponent not currently supported."),i.name=a.name||"light_"+n,this.lights[n]=i)}}function i(e){this.name=r.KHR_MATERIALS_COMMON}i.prototype.getMaterialType=function(e){switch(e.extensions[this.name].type){case"commonBlinn":case"commonPhong":return it.MeshPhongMaterial;case"commonLambert":return it.MeshLambertMaterial;case"commonConstant":default:return it.MeshBasicMaterial}},i.prototype.extendParams=function(e,t,r){var n=t.extensions[this.name],i=[],a=[];switch(n.type){case"commonBlinn":case"commonPhong":a.push("diffuseFactor","diffuseTexture","specularFactor","specularTexture","shininessFactor");break;case"commonLambert":a.push("diffuseFactor","diffuseTexture")}var s={};return a.forEach(function(e){void 0!==n[e]&&(s[e]=n[e])}),void 0!==s.diffuseFactor&&(e.color=(new it.Color).fromArray(s.diffuseFactor),e.opacity=s.diffuseFactor[3]),void 0!==s.diffuseTexture&&i.push(r.assignTexture(e,"map",s.diffuseTexture.index)),void 0!==s.specularFactor&&(e.specular=(new it.Color).fromArray(s.specularFactor)),void 0!==s.specularTexture&&i.push(r.assignTexture(e,"specularMap",s.specularTexture.index)),void 0!==s.shininessFactor&&(e.shininess=s.shininessFactor),Promise.all(i)};var a="glTF",s=12,o={JSON:1313821514,BIN:5130562};function c(e){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,s);if(this.header={magic:it.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==a)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var n=new DataView(e,s),i=0;i<n.byteLength;){var c=n.getUint32(i,!0);i+=4;var u=n.getUint32(i,!0);if(i+=4,u===o.JSON){var l=new Uint8Array(e,s+i,c);this.content=it.LoaderUtils.decodeText(l)}else if(u===o.BIN){var p=s+i;this.body=e.slice(p,p+c)}i+=c}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function u(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return it.ShaderMaterial},extendParams:function(e,t,r){var n=t.extensions[this.name],i=it.ShaderLib.standard,a=it.UniformsUtils.clone(i.uniforms),s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),c=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),l=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),p=i.fragmentShader.replace("#include <specularmap_fragment>","").replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",c).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",l);delete a.roughness,delete a.metalness,delete a.roughnessMap,delete a.metalnessMap,a.specular={value:(new it.Color).setHex(1118481)},a.glossiness={value:.5},a.specularMap={value:null},a.glossinessMap={value:null},e.vertexShader=i.vertexShader,e.fragmentShader=p,e.uniforms=a,e.defines={STANDARD:""},e.color=new it.Color(1,1,1),e.opacity=1;var h=[];if(Array.isArray(n.diffuseFactor)){var d=n.diffuseFactor;e.color.fromArray(d),e.opacity=d[3]}if(void 0!==n.diffuseTexture&&h.push(r.assignTexture(e,"map",n.diffuseTexture.index)),e.emissive=new it.Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new it.Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var f=n.specularGlossinessTexture.index;h.push(r.assignTexture(e,"glossinessMap",f)),h.push(r.assignTexture(e,"specularMap",f))}return Promise.all(h)},createMaterial:function(e){var t=new it.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var r=this.specularGlossinessParams,n=0,i=r.length;n<i;n++)t[r[n]]=e[r[n]];return t},refreshUniforms:function(e,t,r,n,i,a){var s,o,c,u=i.uniforms,l=i.defines;if(u.opacity.value=i.opacity,u.diffuse.value.copy(i.color),u.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),u.map.value=i.map,u.specularMap.value=i.specularMap,u.alphaMap.value=i.alphaMap,u.lightMap.value=i.lightMap,u.lightMapIntensity.value=i.lightMapIntensity,u.aoMap.value=i.aoMap,u.aoMapIntensity.value=i.aoMapIntensity,i.map?s=i.map:i.specularMap?s=i.specularMap:i.displacementMap?s=i.displacementMap:i.normalMap?s=i.normalMap:i.bumpMap?s=i.bumpMap:i.glossinessMap?s=i.glossinessMap:i.alphaMap?s=i.alphaMap:i.emissiveMap&&(s=i.emissiveMap),void 0!==s)if(s.isWebGLRenderTarget&&(s=s.texture),void 0!==s.matrix){if(!0===s.matrixAutoUpdate){o=s.offset,c=s.repeat;var p=s.rotation,h=s.center;s.matrix.setUvTransform(o.x,o.y,c.x,c.y,p,h.x,h.y)}u.uvTransform.value.copy(s.matrix)}else o=s.offset,c=s.repeat,u.offsetRepeat.value.set(o.x,o.y,c.x,c.y);u.envMap.value=i.envMap,u.envMapIntensity.value=i.envMapIntensity,u.flipEnvMap.value=i.envMap&&i.envMap.isCubeTexture?-1:1,u.refractionRatio.value=i.refractionRatio,u.specular.value.copy(i.specular),u.glossiness.value=i.glossiness,u.glossinessMap.value=i.glossinessMap,u.emissiveMap.value=i.emissiveMap,u.bumpMap.value=i.bumpMap,u.normalMap.value=i.normalMap,u.displacementMap.value=i.displacementMap,u.displacementScale.value=i.displacementScale,u.displacementBias.value=i.displacementBias,null!==u.glossinessMap.value&&void 0===l.USE_GLOSSINESSMAP&&(l.USE_GLOSSINESSMAP="",l.USE_ROUGHNESSMAP=""),null===u.glossinessMap.value&&void 0!==l.USE_GLOSSINESSMAP&&(delete l.USE_GLOSSINESSMAP,delete l.USE_ROUGHNESSMAP)}}}var l=0,p=1,h=2,d=3,f=4,v=5,y=6,g=(Number,it.Matrix3,it.Matrix4,it.Vector2,it.Vector3,it.Vector4,it.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),m={9728:it.NearestFilter,9729:it.LinearFilter,9984:it.NearestMipMapNearestFilter,9985:it.LinearMipMapNearestFilter,9986:it.NearestMipMapLinearFilter,9987:it.LinearMipMapLinearFilter},b={33071:it.ClampToEdgeWrapping,33648:it.MirroredRepeatWrapping,10497:it.RepeatWrapping},w={6406:it.AlphaFormat,6407:it.RGBFormat,6408:it.RGBAFormat,6409:it.LuminanceFormat,6410:it.LuminanceAlphaFormat},k={5121:it.UnsignedByteType,32819:it.UnsignedShort4444Type,32820:it.UnsignedShort5551Type,33635:it.UnsignedShort565Type},O=(it.BackSide,it.FrontSide,it.NeverDepth,it.LessDepth,it.EqualDepth,it.LessEqualDepth,it.GreaterEqualDepth,it.NotEqualDepth,it.GreaterEqualDepth,it.AlwaysDepth,it.AddEquation,it.SubtractEquation,it.ReverseSubtractEquation,it.ZeroFactor,it.OneFactor,it.SrcColorFactor,it.OneMinusSrcColorFactor,it.SrcAlphaFactor,it.OneMinusSrcAlphaFactor,it.DstAlphaFactor,it.OneMinusDstAlphaFactor,it.DstColorFactor,it.OneMinusDstColorFactor,it.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),S={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},x={CUBICSPLINE:it.InterpolateSmooth,LINEAR:it.InterpolateLinear,STEP:it.InterpolateDiscrete},C="OPAQUE",M="MASK",j="BLEND";function E(e,t){return"string"!==typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e}function A(e,t,r,n){var i=e.geometry,a=e.material,s=r.targets,o=i.morphAttributes;o.position=[],o.normal=[],a.morphTargets=!0;for(var c=0,u=s.length;c<u;c++){var l,p,h=s[c],d="morphTarget"+c;if(void 0!==h.POSITION){l=n[h.POSITION].clone();for(var f=i.attributes.position,v=0,y=l.count;v<y;v++)l.setXYZ(v,l.getX(v)+f.getX(v),l.getY(v)+f.getY(v),l.getZ(v)+f.getZ(v))}else i.attributes.position&&(l=i.attributes.position.clone());if(void 0!==l&&(l.name=d,o.position.push(l)),void 0!==h.NORMAL){a.morphNormals=!0,p=n[h.NORMAL].clone();var g=i.attributes.normal;for(v=0,y=p.count;v<y;v++)p.setXYZ(v,p.getX(v)+g.getX(v),p.getY(v)+g.getY(v),p.getZ(v)+g.getZ(v))}else void 0!==i.attributes.normal&&(p=i.attributes.normal.clone());void 0!==p&&(p.name=d,o.normal.push(p))}if(e.updateMorphTargets(),void 0!==t.weights)for(c=0,u=t.weights.length;c<u;c++)e.morphTargetInfluences[c]=t.weights[c]}function P(e,t){if(e.indices!==t.indices)return!1;var r=e.attributes||{},n=t.attributes||{},i=Object.keys(r),a=Object.keys(n);if(i.length!==a.length)return!1;for(var s=0,o=i.length;s<o;s++){var c=i[s];if(r[c]!==n[c])return!1}return!0}function D(e,t){for(var r=0,n=e.length;r<n;r++){var i=e[r];if(P(i.primitive,t))return i.geometry}return null}function L(e,r,n){this.json=e||{},this.extensions=r||{},this.options=n||{},this.cache=new t,this.primitiveCache=[],this.textureLoader=new it.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new it.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}return L.prototype.parse=function(e,t){var r=this.json;this.cache.removeAll(),this.markDefs(),this.getMultiDependencies(["scene","animation","camera"]).then(function(t){var n=t.scenes||[],i=n[r.scene||0],a=t.animations||[],s=r.asset,o=t.cameras||[];e(i,n,o,a,s)}).catch(t)},L.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n={},i={},a=0,s=t.length;a<s;a++)for(var o=t[a].joints,c=0,u=o.length;c<u;c++)e[o[c]].isBone=!0;for(var l=0,p=e.length;l<p;l++){var h=e[l];void 0!==h.mesh&&(void 0===n[h.mesh]&&(n[h.mesh]=i[h.mesh]=0),n[h.mesh]++,void 0!==h.skin&&(r[h.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=i},L.prototype.getDependency=function(e,t){var r=e+":"+t,n=this.cache.get(r);n||(n=this["load"+e.charAt(0).toUpperCase()+e.slice(1)](t),this.cache.add(r,n));return n},L.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return r.getDependency(e,n)})),this.cache.add(e,t)}return t},L.prototype.getMultiDependencies=function(e){for(var t={},r=[],n=0,i=e.length;n<i;n++){var a=e[n],s=this.getDependencies(a);s=s.then(function(e,r){t[e]=r}.bind(this,a+("mesh"===a?"es":"s"))),r.push(s)}return Promise.all(r).then(function(){return t})},L.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var i=this.options;return new Promise(function(e,r){n.load(E(t.uri,i.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})},L.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)})},L.prototype.loadAccessor=function(e){var t=this.json,r=this.json.accessors[e],n=[];return void 0!==r.bufferView?n.push(this.getDependency("bufferView",r.bufferView)):n.push(null),void 0!==r.sparse&&(n.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(n).then(function(e){var n,i,a=e[0],s=O[r.type],o=g[r.componentType],c=o.BYTES_PER_ELEMENT,u=c*s,l=t.bufferViews[r.bufferView].byteStride,p=!0===r.normalized;if(l&&l!==u){n=new o(a);var h=new it.InterleavedBuffer(n,l/c);i=new it.InterleavedBufferAttribute(h,s,r.byteOffset/c,p)}else n=null===a?new o(r.count*s):new o(a,r.byteOffset,r.count*s),i=new it.BufferAttribute(n,s,p);if(void 0!==r.sparse){var d=O.SCALAR,f=g[r.sparse.indices.componentType],v=r.sparse.indices.byteOffset||0,y=r.sparse.values.byteOffset||0,m=new f(e[1],v,r.sparse.count*d),b=new o(e[2],y,r.sparse.count*s);null!==a&&i.setArray(i.array.slice());for(var w=0,k=m.length;w<k;w++){var S=m[w];if(i.setX(S,b[w*s]),s>=2&&i.setY(S,b[w*s+1]),s>=3&&i.setZ(S,b[w*s+2]),s>=4&&i.setW(S,b[w*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return i})},L.prototype.loadTexture=function(e){var t=this.json,r=this.options,n=this.textureLoader,i=window.URL||window.webkitURL,a=t.textures[e],s=t.images[a.source],o=s.uri,c=!1;return void 0!==s.bufferView&&(o=this.getDependency("bufferView",s.bufferView).then(function(e){c=!0;var t=new Blob([e],{type:s.mimeType});return o=i.createObjectURL(t)})),Promise.resolve(o).then(function(e){var t=it.Loader.Handlers.get(e)||n;return new Promise(function(n,i){t.load(E(e,r.path),n,void 0,i)})}).then(function(e){!0===c&&i.revokeObjectURL(o),e.flipY=!1,void 0!==a.name&&(e.name=a.name),e.format=void 0!==a.format?w[a.format]:it.RGBAFormat,void 0!==a.internalFormat&&e.format!==w[a.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js does not support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),e.type=void 0!==a.type?k[a.type]:it.UnsignedByteType;var r=(t.samplers||{})[a.sampler]||{};return e.magFilter=m[r.magFilter]||it.LinearFilter,e.minFilter=m[r.minFilter]||it.LinearMipMapLinearFilter,e.wrapS=b[r.wrapS]||it.RepeatWrapping,e.wrapT=b[r.wrapT]||it.RepeatWrapping,e})},L.prototype.assignTexture=function(e,t,r){return this.getDependency("texture",r).then(function(r){e[t]=r})},L.prototype.loadMaterial=function(e){this.json;var t,n=this.extensions,i=this.json.materials[e],a={},s=i.extensions||{},o=[];if(s[r.KHR_MATERIALS_COMMON]){var c=n[r.KHR_MATERIALS_COMMON];t=c.getMaterialType(i),o.push(c.extendParams(a,i,this))}else if(s[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var u=n[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=u.getMaterialType(i),o.push(u.extendParams(a,i,this))}else if(void 0!==i.pbrMetallicRoughness){t=it.MeshStandardMaterial;var l=i.pbrMetallicRoughness;if(a.color=new it.Color(1,1,1),a.opacity=1,Array.isArray(l.baseColorFactor)){var p=l.baseColorFactor;a.color.fromArray(p),a.opacity=p[3]}if(void 0!==l.baseColorTexture&&o.push(this.assignTexture(a,"map",l.baseColorTexture.index)),a.metalness=void 0!==l.metallicFactor?l.metallicFactor:1,a.roughness=void 0!==l.roughnessFactor?l.roughnessFactor:1,void 0!==l.metallicRoughnessTexture){var h=l.metallicRoughnessTexture.index;o.push(this.assignTexture(a,"metalnessMap",h)),o.push(this.assignTexture(a,"roughnessMap",h))}}else t=it.MeshPhongMaterial;!0===i.doubleSided&&(a.side=it.DoubleSide);var d=i.alphaMode||C;return d===j?a.transparent=!0:(a.transparent=!1,d===M&&(a.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&(o.push(this.assignTexture(a,"normalMap",i.normalTexture.index)),a.normalScale=new it.Vector2(1,1),void 0!==i.normalTexture.scale&&a.normalScale.set(i.normalTexture.scale,i.normalTexture.scale)),void 0!==i.occlusionTexture&&(o.push(this.assignTexture(a,"aoMap",i.occlusionTexture.index)),void 0!==i.occlusionTexture.strength&&(a.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&(t===it.MeshBasicMaterial?a.color=(new it.Color).fromArray(i.emissiveFactor):a.emissive=(new it.Color).fromArray(i.emissiveFactor)),void 0!==i.emissiveTexture&&(t===it.MeshBasicMaterial?o.push(this.assignTexture(a,"map",i.emissiveTexture.index)):o.push(this.assignTexture(a,"emissiveMap",i.emissiveTexture.index))),Promise.all(o).then(function(){var e;return e=t===it.ShaderMaterial?n[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new t(a),void 0!==i.name&&(e.name=i.name),e.normalScale&&(e.normalScale.x=-e.normalScale.x),e.map&&(e.map.encoding=it.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=it.sRGBEncoding),i.extras&&(e.userData=i.extras),e})},L.prototype.loadGeometries=function(e){var t=this.primitiveCache;return this.getDependencies("accessor").then(function(r){for(var n=[],i=0,a=e.length;i<a;i++){var s=e[i],o=D(t,s);if(o)n.push(o);else{var c=new it.BufferGeometry,u=s.attributes;for(var l in u){var p=r[u[l]];switch(l){case"POSITION":c.addAttribute("position",p);break;case"NORMAL":c.addAttribute("normal",p);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":c.addAttribute("uv",p);break;case"TEXCOORD_1":c.addAttribute("uv2",p);break;case"COLOR_0":case"COLOR0":case"COLOR":c.addAttribute("color",p);break;case"WEIGHTS_0":case"WEIGHT":c.addAttribute("skinWeight",p);break;case"JOINTS_0":case"JOINT":c.addAttribute("skinIndex",p)}}void 0!==s.indices&&c.setIndex(r[s.indices]),t.push({primitive:s,geometry:c}),n.push(c)}}return n})},L.prototype.loadMesh=function(e){var t=this,n=(this.json,this.extensions),i=this.json.meshes[e];return this.getMultiDependencies(["accessor","material"]).then(function(a){var s=new it.Group,o=i.primitives;return t.loadGeometries(o).then(function(t){for(var c=0,u=o.length;c<u;c++){var g=o[c],m=t[c],b=void 0===g.material?new it.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:it.FrontSide}):a.materials[g.material];b.aoMap&&void 0===m.attributes.uv2&&void 0!==m.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),m.addAttribute("uv2",new it.BufferAttribute(m.attributes.uv.array,2)));var w,k=void 0!==m.attributes.color,O=void 0===m.attributes.normal,S=!0===i.isSkinnedMesh,x=void 0!==g.targets;if(k||O||S||x)if(b.isGLTFSpecularGlossinessMaterial)b=n[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(b);else b=b.clone();if(k&&(b.vertexColors=it.VertexColors,b.needsUpdate=!0),O&&(b.flatShading=!0),g.mode===f||g.mode===v||g.mode===y||void 0===g.mode)S?(w=new it.SkinnedMesh(m,b),b.skinning=!0):w=new it.Mesh(m,b),g.mode===v?w.drawMode=it.TriangleStripDrawMode:g.mode===y&&(w.drawMode=it.TriangleFanDrawMode);else if(g.mode===p)w=new it.LineSegments(m,b);else if(g.mode===d)w=new it.Line(m,b);else if(g.mode===h)w=new it.LineLoop(m,b);else{if(g.mode!==l)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);w=new it.Points(m,b)}if(w.name=i.name||"mesh_"+e,x&&A(w,i,g,a.accessors),void 0!==i.extras&&(w.userData=i.extras),void 0!==g.extras&&(w.geometry.userData=g.extras),!0===b.isGLTFSpecularGlossinessMaterial&&(w.onBeforeRender=n[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),!(o.length>1))return w;w.name+="_"+c,s.add(w)}return s})})},L.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n){if("perspective"===r.type){var i=n.aspectRatio||1,a=n.yfov*i;t=new it.PerspectiveCamera(it.Math.radToDeg(a),i,n.znear||1,n.zfar||2e6)}else"orthographic"===r.type&&(t=new it.OrthographicCamera(n.xmag/-2,n.xmag/2,n.ymag/2,n.ymag/-2,n.znear,n.zfar));return void 0!==r.name&&(t.name=r.name),r.extras&&(t.userData=r.extras),Promise.resolve(t)}console.warn("THREE.GLTFLoader: Missing camera parameters.")},L.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return r.inverseBindMatrices=e,r})},L.prototype.loadAnimation=function(e){this.json;var t=this.json.animations[e];return this.getMultiDependencies(["accessor","node"]).then(function(r){for(var n=[],i=0,a=t.channels.length;i<a;i++){var s=t.channels[i],o=t.samplers[s.sampler];if(o){var c=s.target,u=void 0!==c.node?c.node:c.id,l=void 0!==t.parameters?t.parameters[o.input]:o.input,p=void 0!==t.parameters?t.parameters[o.output]:o.output,h=r.accessors[l],d=r.accessors[p],f=r.nodes[u];if(f){var v;switch(f.updateMatrix(),f.matrixAutoUpdate=!0,S[c.path]){case S.weights:v=it.NumberKeyframeTrack;break;case S.rotation:v=it.QuaternionKeyframeTrack;break;case S.position:case S.scale:default:v=it.VectorKeyframeTrack}var y=f.name?f.name:f.uuid;if("CUBICSPLINE"===o.interpolation){for(var g=d.itemSize,m=new(0,d.array.constructor)(d.count*g/3),b=0,w=d.count;b<w;b+=3)m[b*g/3]=d.getX(b+1),g>1&&(m[b*g/3+1]=d.getY(b+1)),g>2&&(m[b*g/3+2]=d.getZ(b+1)),g>3&&(m[b*g/3+3]=d.getW(b+1));d=new it.BufferAttribute(m,g/3,d.normalized)}var k=void 0!==o.interpolation?x[o.interpolation]:it.InterpolateLinear,O=[];S[c.path]===S.weights?f.traverse(function(e){!0===e.isMesh&&!0===e.material.morphTargets&&O.push(e.name?e.name:e.uuid)}):O.push(y);for(b=0,w=O.length;b<w;b++)n.push(new v(O[b]+"."+S[c.path],it.AnimationUtils.arraySlice(h.array,0),it.AnimationUtils.arraySlice(d.array,0),k))}}}u=void 0!==t.name?t.name:"animation_"+e;return new it.AnimationClip(u,void 0,n)})},L.prototype.loadNode=function(e){this.json;var t=this.extensions,n=this.json.meshReferences,i=this.json.meshUses,a=this.json.nodes[e];return this.getMultiDependencies(["mesh","skin","camera"]).then(function(e){var s;if(!0===a.isBone)s=new it.Bone;else if(void 0!==a.mesh){var o=e.meshes[a.mesh];if(s=o.clone(),!0===o.isGroup)for(var c=0,u=o.children.length;c<u;c++){var l=o.children[c];l.material&&!0===l.material.isGLTFSpecularGlossinessMaterial&&(s.children[c].onBeforeRender=l.onBeforeRender)}else o.material&&!0===o.material.isGLTFSpecularGlossinessMaterial&&(s.onBeforeRender=o.onBeforeRender);n[a.mesh]>1&&(s.name+="_instance_"+i[a.mesh]++)}else if(void 0!==a.camera)s=e.cameras[a.camera];else if(a.extensions&&a.extensions[r.KHR_LIGHTS]&&void 0!==a.extensions[r.KHR_LIGHTS].light){s=t[r.KHR_LIGHTS].lights[a.extensions[r.KHR_LIGHTS].light]}else s=new it.Object3D;if(void 0!==a.name&&(s.name=it.PropertyBinding.sanitizeNodeName(a.name)),a.extras&&(s.userData=a.extras),void 0!==a.matrix){var p=new it.Matrix4;p.fromArray(a.matrix),s.applyMatrix(p)}else void 0!==a.translation&&s.position.fromArray(a.translation),void 0!==a.rotation&&s.quaternion.fromArray(a.rotation),void 0!==a.scale&&s.scale.fromArray(a.scale);return s})},L.prototype.loadScene=function(){function e(t,r,n,i,a){var s=i[t],o=n.nodes[t];if(void 0!==o.skin)for(var c=!0===s.isGroup?s.children:[s],u=0,l=c.length;u<l;u++){for(var p=c[u],h=a[o.skin],d=[],f=[],v=0,y=h.joints.length;v<y;v++){var g=h.joints[v],m=i[g];if(m){d.push(m);var b=new it.Matrix4;void 0!==h.inverseBindMatrices&&b.fromArray(h.inverseBindMatrices.array,16*v),f.push(b)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',g)}p.bind(new it.Skeleton(d,f),p.matrixWorld)}if(r.add(s),o.children){var w=o.children;for(u=0,l=w.length;u<l;u++){e(w[u],s,n,i,a)}}}return function(t){var n=this.json,i=this.extensions,a=this.json.scenes[t];return this.getMultiDependencies(["node","skin"]).then(function(t){var s=new it.Scene;void 0!==a.name&&(s.name=a.name),a.extras&&(s.userData=a.extras);for(var o=a.nodes||[],c=0,u=o.length;c<u;c++)e(o[c],s,n,t.nodes,t.skins);if(a.extensions&&a.extensions[r.KHR_LIGHTS]&&void 0!==a.extensions[r.KHR_LIGHTS].light){var l=i[r.KHR_LIGHTS].lights;s.add(l[a.extensions[r.KHR_LIGHTS].light])}return s})}}(),e}(),st=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create model w/ missing parent");return ie(e,e.createObject({type:"model",title:"a model",visible:!0,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",asset:0,parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Group;t.name=e.title;var r=new Xe.Mesh(new Xe.SphereBufferGeometry(1),new Xe.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,t.userData.clicker=r,t.add(r),t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t}},{key:"updateProperty",value:function(e,r,n,i){if(n.name===Ct.asset.key){var a=ie(i.getDataGraph(),n.value);if(console.log("got the asset",a),a.src){var s=new at;console.log("loading the url",a.src),s.load(a.src,function(t){if(console.log("loaded",t),e.userData.model&&e.remove(e.userData.model),e.userData.model=t.scene.clone(),e.add(e.userData.model),e.userData.model.geometry){e.userData.model.geometry.computeBoundingSphere();var r=e.userData.model.geometry.boundingSphere,n=e.userData.model;n.position.x=-r.center.x,n.position.y=-r.center.y,n.position.z=-r.center.z,e.userData.clicker.geometry=new Xe.SphereBufferGeometry(r.radius)}})}}return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(_e);function ot(e,t,r){t.onBeforeCompile=function(t){t.uniforms.imageOffsetAngle={value:r.imageOffsetAngle},t.uniforms.imageCropStartAngle={value:r.imageCropStartAngle},t.uniforms.imageCropEndAngle={value:r.imageCropEndAngle},t.vertexShader="\n            uniform float imageOffsetAngle;\n            varying float vImageOffsetAngle;\n            uniform float imageCropStartAngle;            \n            varying float vImageCropStartAngle;            \n            uniform float imageCropEndAngle;            \n            varying float vImageCropEndAngle;            \n        "+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <begin_vertex>","\n            #include <begin_vertex>\n            vImageOffsetAngle = imageOffsetAngle;\n            vImageCropStartAngle = imageCropStartAngle;\n            vImageCropEndAngle = imageCropEndAngle;\n        "),t.fragmentShader="\n                varying float vImageOffsetAngle;\n                varying float vImageCropStartAngle;\n                varying float vImageCropEndAngle;\n            "+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>","\n            if(vUv.x < vImageCropStartAngle) discard;\n            if(vUv.x > vImageCropEndAngle)  discard;\n            // gl_FragColor.r = vUv.x;\n            // vec3 jv = vec3(cos(gl_FragCoord.x/50.0)); \n            // vec3 empty = vec3(0.0,0.0,0.0);//vec3(jv,jv,jv)\n            // gl_FragColor.rgb = mix(empty,diffuseColor.rgb,jv);\n        "),e.userData.matShader=t}}var ct=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return ie(e,e.createObject({type:jt.bg360,title:"background",visible:!0,asset:0,parent:t.id,imageOffsetAngle:0,imageCropStartAngle:0,imageCropEndAngle:1}))}},{key:"makeNode",value:function(e,t){var r=new Xe.MeshLambertMaterial({color:"white",side:Xe.BackSide}),n=new Xe.Mesh(new Xe.SphereBufferGeometry(20,50,50),r);ot(n,r,e),n.name=e.title,n.userData.clickable=!0;var i=t.accessObject(e.asset);return i.exists()&&this.attachAsset(i,e,n,t),n}},{key:"updateProperty",value:function(e,t,r,n){if(r.name===Ct.asset.key){var i=n.accessObject(t.asset);i.exists()&&this.attachAsset(i,t,e,n)}e.userData.matShader?("imageOffsetAngle"===r.name&&(e.userData.matShader.uniforms.imageOffsetAngle.value=r.value),"imageCropStartAngle"===r.name&&(e.userData.matShader.uniforms.imageCropStartAngle.value=r.value),"imageCropEndAngle"===r.name&&(e.userData.matShader.uniforms.imageCropEndAngle.value=r.value)):console.warn("BG360: no shader reference?!")}},{key:"attachAsset",value:function(e,t,r,n){if(e.subtype===Bt.IMAGE){var i=(new Xe.TextureLoader).load(e.src);r.material=new Xe.MeshLambertMaterial({color:"white",side:Xe.BackSide,map:i}),ot(r,r.material,t)}if(e.subtype===Bt.VIDEO){var a=document.createElement("video");a.crossOrigin="anonymous",a.src=e.src;var s=new Xe.VideoTexture(a);r.material=new Xe.MeshLambertMaterial({color:"white",side:Xe.BackSide,map:s})}}}]),e}(),ut=r(39),lt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return ie(e,e.createObject({type:jt.text,title:"some text",visible:!0,text:"cool <b>formatted</b> <i>text</i>",cssStyle:"color:black;",tx:0,ty:0,tz:-.4,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=document.createElement("div");t.innerHTML=e.text,t.id="div_".concat(e.id),t.classList.add("weblayer-div"),e.cssStyle&&t.setAttribute("style",e.cssStyle);var r=new ut.a(t,{pixelRatio:window.devicePixelRatio,onLayerCreate:function(e){e.mesh.material.side=Xe.DoubleSide}});r.refresh(!0),r.userData.clickable=!0;var n=new Xe.Object3D;return n.previewUpdate=function(){r.update()},n.add(r),n.userData.divLayer=r,n.userData.div=t,n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),this.regenerateText(n,e),n}},{key:"updateProperty",value:function(e,r,n,i){return n.name===Ct.text.key&&this.regenerateText(e,r),n.name===Ct.cssStyle.key&&this.regenerateText(e,r),Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}},{key:"regenerateText",value:function(e,t){e.userData.div.innerHTML=t.text,t.cssStyle&&e.userData.div.setAttribute("style",t.cssStyle),e.userData.divLayer.refresh(!0)}}]),t}(_e),pt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create Image2D with missing parent");return ie(e,e.createObject({type:jt.img2d,title:"image",visible:!0,width:1,ratio:1,tx:0,ty:1.5,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,asset:0,parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Mesh(new Xe.PlaneBufferGeometry(e.width,e.width*e.ratio),new Xe.MeshLambertMaterial({color:"white",side:Xe.DoubleSide}));return t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t}},{key:"updateProperty",value:function(e,r,n,i){if(n.name!==Ct.asset.key){if(n.name!==Ct.width.key&&"ratio"!==n.name)return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i);e.geometry=new Xe.PlaneBufferGeometry(r.width,r.width*(1/r.ratio))}else{var a=i.accessObject(n.value);if(a.exists()){var s=(new Xe.TextureLoader).load(a.src);e.material=new Xe.MeshLambertMaterial({color:"white",side:Xe.DoubleSide,map:s}),a.set("ratio",a.width/a.height)}}}}]),t}(_e),ht=0,dt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return ie(e,e.createObject({type:jt.group,title:"group "+ht++,visible:!0,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Group;return t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t}},{key:"updateProperty",value:function(e,r,n,i){return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(_e),ft={vertexShader:"\n                uniform float uTime;\n                uniform float uScale;\n                uniform bool reverseTime;\n                uniform float fadeIn;\n                uniform float fadeOut;\n    \n                attribute vec3 positionStart;\n                attribute float startTime;\n                attribute vec3 velocity;\n                attribute vec3 acceleration;\n                attribute vec3 color;\n                attribute vec3 endColor;\n                attribute float size;\n                attribute float lifeTime;\n    \n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n    \n                void main() {\n                    vColor = vec4( color, 1.0 );\n                    vEndColor = vec4( endColor, 1.0);\n                    vec3 newPosition;\n                    float timeElapsed = uTime - startTime;\n                    if(reverseTime) timeElapsed = lifeTime - timeElapsed;\n                    if(timeElapsed < fadeIn) {\n                        alpha = timeElapsed/fadeIn;\n                    }\n                    if(timeElapsed >= fadeIn && timeElapsed <= (lifeTime - fadeOut)) {\n                        alpha = 1.0;\n                    }\n                    if(timeElapsed > (lifeTime - fadeOut)) {\n                        alpha = 1.0 - (timeElapsed - (lifeTime-fadeOut))/fadeOut;\n                    }\n                    \n                    lifeLeft = 1.0 - ( timeElapsed / lifeTime );\n                    gl_PointSize = ( uScale * size );// * lifeLeft;\n                    newPosition = positionStart \n                        + (velocity * timeElapsed)\n                        + (acceleration * 0.5 * timeElapsed * timeElapsed)\n                        ;\n                    if (lifeLeft < 0.0) { \n                        lifeLeft = 0.0; \n                        gl_PointSize = 0.;\n                    }\n                    //while active use the new position\n                    if( timeElapsed > 0.0 ) {\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );\n                    } else {\n                        //if dead use the initial position and set point size to 0\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                        lifeLeft = 0.0;\n                        gl_PointSize = 0.;\n                    }\n                }\n                ",fragmentShader:"\n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n                uniform sampler2D tSprite;\n                void main() {\n                    // color based on particle texture and the lifeLeft. \n                    // if lifeLeft is 0 then make invisible\n                    vec4 tex = texture2D( tSprite, gl_PointCoord );\n                    vec4 color = mix(vColor, vEndColor, 1.0-lifeLeft);\n                    gl_FragColor = vec4( color.rgb*tex.rgb, alpha * tex.a);\n                }\n    \n            "},vt=["positionStart","startTime","velocity","acceleration","color","endColor","size","lifeTime"],yt=function(e){function t(e){var r,n;for(Object(o.a)(this,t),e=e||{},(r=Object(u.a)(this,Object(l.a)(t).call(this))).blending=e.blending?e.blending:Xe.NormalBlending,r.PARTICLE_COUNT=e.maxParticles||1e6,r.PARTICLE_CURSOR=0,r.time=0,r.offset=0,r.count=0,r.DPR=window.devicePixelRatio,r.particleUpdate=!1,r.onTick=e.onTick,r.reverseTime=e.reverseTime,r.fadeIn=e.fadeIn||1,0===r.fadeIn&&(r.fadeIn=.001),r.fadeOut=e.fadeOut||1,0===r.fadeOut&&(r.fadeOut=.001),r.rand=[],n=1e5;n>0;n--)r.rand.push(Math.random()-.5);if(r.i=n,r.sprite=e.particleSpriteTex||null,!r.sprite){var i=document.createElement("canvas");i.width=16,i.height=16;var a=i.getContext("2d");a.fillStyle="black",a.fillRect(0,0,i.width,i.height),a.fillStyle="rgba(255,255,255,0.5)",a.beginPath(),a.arc(8,8,8,0,2*Math.PI),a.fill(),r.sprite=new Xe.CanvasTexture(i)}return r.sprite.wrapS=r.sprite.wrapT=Xe.RepeatWrapping,r.material=new Xe.ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uTime:{value:0},uScale:{value:1},tSprite:{value:r.sprite},reverseTime:{value:r.reverseTime},fadeIn:{value:r.fadeIn},fadeOut:{value:r.fadeOut}},blending:r.blending,vertexShader:ft.vertexShader,fragmentShader:ft.fragmentShader}),r.material.defaultAttributeValues.particlePositionsStartTime=[0,0,0,0],r.material.defaultAttributeValues.particleVelColSizeLife=[0,0,0,0],r.geometry=new Xe.BufferGeometry,r.geometry.addAttribute("position",new Xe.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("positionStart",new Xe.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("velocity",new Xe.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("acceleration",new Xe.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("color",new Xe.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("endColor",new Xe.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("startTime",new Xe.BufferAttribute(new Float32Array(r.PARTICLE_COUNT),1).setDynamic(!0)),r.geometry.addAttribute("size",new Xe.BufferAttribute(new Float32Array(r.PARTICLE_COUNT),1).setDynamic(!0)),r.geometry.addAttribute("lifeTime",new Xe.BufferAttribute(new Float32Array(r.PARTICLE_COUNT),1).setDynamic(!0)),r.particleSystem=new Xe.Points(r.geometry,r.material),r.particleSystem.frustumCulled=!1,r.add(r.particleSystem),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"geometryUpdate",value:function(){var e=this;!0===this.particleUpdate&&(this.particleUpdate=!1,vt.forEach(function(t){var r=e.geometry.getAttribute(t);e.offset+e.count<e.PARTICLE_COUNT?(r.updateRange.offset=e.offset*r.itemSize,r.updateRange.count=e.count*r.itemSize):(r.updateRange.offset=0,r.updateRange.count=-1),r.needsUpdate=!0}),this.offset=0,this.count=0)}},{key:"random",value:function(){return++this.i>=this.rand.length?this.rand[this.i=1]:this.rand[this.i]}},{key:"update",value:function(e){this.time=e/1e3,this.material.uniforms.uTime.value=this.time,this.onTick&&this.onTick(this,this.time),this.geometryUpdate()}},{key:"dispose",value:function(){this.material.dispose(),this.sprite.dispose(),this.geometry.dispose()}},{key:"updateSprite",value:function(e){if(e){var t=this.sprite;this.sprite=e,this.sprite.wrapS=this.sprite.wrapT=Xe.RepeatWrapping,this.material.uniforms.tSprite.value=e,t&&t.dispose()}}},{key:"spawnParticle",value:function(e){var t=new Xe.Vector3,r=new Xe.Vector3,n=new Xe.Vector3,i=new Xe.Color,a=new Xe.Color,s=this.geometry.getAttribute("positionStart"),o=this.geometry.getAttribute("startTime"),c=this.geometry.getAttribute("velocity"),u=this.geometry.getAttribute("acceleration"),l=this.geometry.getAttribute("color"),p=this.geometry.getAttribute("endColor"),h=this.geometry.getAttribute("size"),d=this.geometry.getAttribute("lifeTime");t=void 0!==(e=e||{}).position?t.copy(e.position):t.set(0,0,0),r=void 0!==e.velocity?r.copy(e.velocity):r.set(0,0,0),n=void 0!==e.acceleration?n.copy(e.acceleration):n.set(0,0,0),i=void 0!==e.color?i.copy(e.color):i.set(16777215),a=void 0!==e.endColor?a.copy(e.endColor):a.copy(i);var f=void 0!==e.lifetime?e.lifetime:5,v=void 0!==e.size?e.size:10,y=void 0!==e.sizeRandomness?e.sizeRandomness:0;void 0!==this.DPR&&(v*=this.DPR);var g=this.PARTICLE_CURSOR;s.array[3*g+0]=t.x,s.array[3*g+1]=t.y,s.array[3*g+2]=t.z,c.array[3*g+0]=r.x,c.array[3*g+1]=r.y,c.array[3*g+2]=r.z,u.array[3*g+0]=n.x,u.array[3*g+1]=n.y,u.array[3*g+2]=n.z,l.array[3*g+0]=i.r,l.array[3*g+1]=i.g,l.array[3*g+2]=i.b,p.array[3*g+0]=a.r,p.array[3*g+1]=a.g,p.array[3*g+2]=a.b,h.array[g]=v+this.random()*y,d.array[g]=f,o.array[g]=this.time+.02*this.random(),0===this.offset&&(this.offset=this.PARTICLE_CURSOR),this.count++,this.PARTICLE_CURSOR++,this.PARTICLE_CURSOR>=this.PARTICLE_COUNT&&(this.PARTICLE_CURSOR=0),this.particleUpdate=!0}}]),t}(Xe.Object3D),gt=function(e,t){return Math.random()*(t-e)+e},mt=0,bt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return ie(e,e.createObject({type:jt.particles,title:"particles "+mt++,visible:!0,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),pointSize:10,lifetime:3,startColor:"#ff0000",endColor:"#0000ff",parent:t.id,texture:null}))}},{key:"makeNode",value:function(e){var t=null;e.texture&&(t=(new Xe.TextureLoader).load(e.texture));var r={velocity:new Xe.Vector3(0,1,0),position:new Xe.Vector3(0,0,0),size:e.pointSize,lifetime:e.lifetime,color:new Xe.Color(1,0,1),endColor:new Xe.Color(0,1,1)},n=new yt({maxParticles:1e4,position:new Xe.Vector3(0,0,0),positionRandomness:0,baseVelocity:new Xe.Vector3(0,0,-1),velocity:new Xe.Vector3(0,0,0),velocityRandomness:1,acceleration:new Xe.Vector3(0,0,0),baseColor:new Xe.Color(1,1,.5),color:new Xe.Color(1,0,0),colorRandomness:.5,lifetime:3,size:10,sizeRandomness:1,particleSpriteTex:t,blending:Xe.AdditiveBlending,onTick:function(e,t){r.velocity.set(gt(-1,1),1,gt(-1,1)),e.spawnParticle(r)}});return n.userData.options=r,n.name=e.title,n.userData.clickable=!1,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n}},{key:"updateProperty",value:function(e,r,n,i){if(n.name===Ct.pointSize.key)return e.userData.options.size=r.pointSize;if(n.name===Ct.lifetime.key)return e.userData.options.lifetime=r.lifetime;if(n.name===Ct.startColor.key)return e.userData.options.color.set(r.startColor);if(n.name===Ct.endColor.key)return e.userData.options.endColor.set(r.endColor);if(n.name!==Ct.texture.key)return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i);var a=i.accessObject(r.texture);if(a){var s=(new Xe.TextureLoader).load(a.src);e.updateSprite(s)}}}]),t}(_e),wt=0,kt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't imageanchor w/ missing parent");return ie(e,e.createObject({type:jt.imageanchor,title:"image anchor "+wt++,visible:!0,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),targetImage:null,imageRealworldWidth:1,recType:Ut.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Group;t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz);var r=new Xe.Mesh(new Xe.SphereBufferGeometry(1),new Xe.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,t.userData.clicker=r,t.add(r),t.init=function(n){r.visible=!1,t.visible=!1,t.userData.info={image:n.system.getObjectById(e.targetImage),imageRealworldWidth:e.imageRealworldWidth,recType:e.recType,object:e,node:t,callback:function(r){n.system.fireEvent(e,"recognized",r),t.visible=!0}},n.system.startImageRecognizer(t.userData.info)},t.stop=function(e){r.visible=!0,e.system.stopImageRecognizer(t.userData.info)},t}},{key:"updateProperty",value:function(e,r,n,i){return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(_e),Ot=0,St=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create geo anchor w/ missing parent");return ie(e,e.createObject({type:jt.geoanchor,title:"geo anchor "+Ot++,visible:!0,tx:0,ty:0,tz:-5,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),targetGeoLocation:null,recType:Ut.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Xe.Group;t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz);var r=new Xe.Mesh(new Xe.SphereBufferGeometry(1),new Xe.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,t.userData.clicker=r,t.add(r),t.init=function(n){r.visible=!1,t.visible=!1,t.userData.info={location:n.system.getObjectById(e.targetGeoLocation),recType:e.recType,object:e,node:t,callback:function(r){n.system.fireEvent(e,"recognized",r),t.visible=!0}},n.system.startGeoRecognizer(t.userData.info)},t.stop=function(e){r.visible=!0,e.system.stopGeoRecognizer(t.userData.info)},t}}]),t}(_e),xt={incrementValue:.1},Ct={title:{key:"title",name:"Title",type:$.STRING},description:{key:"description",name:"Description",type:$.STRING},width:{key:"width",name:"Width",type:$.NUMBER,hints:xt},height:{key:"height",name:"Height",type:$.NUMBER,hints:xt},depth:{key:"depth",name:"Depth",type:$.NUMBER,hints:xt},radius:{key:"radius",name:"Radius",type:$.NUMBER,hints:xt},tx:{key:"tx",name:"TX",type:$.NUMBER,hints:xt},ty:{key:"ty",name:"TY",type:$.NUMBER,hints:xt},tz:{key:"tz",name:"TZ",type:$.NUMBER,hints:xt},rx:{key:"rx",name:"RX",type:$.NUMBER,hints:xt},ry:{key:"ry",name:"RY",type:$.NUMBER,hints:xt},rz:{key:"rz",name:"RZ",type:$.NUMBER,hints:xt},sx:{key:"sx",name:"SX",type:$.NUMBER,hints:xt},sy:{key:"sy",name:"SY",type:$.NUMBER,hints:xt},sz:{key:"sz",name:"SZ",type:$.NUMBER,hints:xt},color:{key:"color",name:"Color",type:$.COLOR,custom:!0},defaultFloor:{key:"defaultFloor",name:"Default Floor",type:$.BOOLEAN},src:{key:"src",name:"src",type:$.STRING,locked:!0},asset:{key:"asset",name:"asset",type:$.ENUM},subtype:{key:"subtype",name:"kind",type:$.STRING,locked:!0},format:{key:"format",name:"format",type:$.STRING,locked:!0},imageOffsetAngle:{key:"imageOffsetAngle",name:"Image Offset Angle",type:$.NUMBER,hints:{incrementValue:.05}},imageCropStartAngle:{key:"imageCropStartAngle",name:"Image Crop Start Angle",type:$.NUMBER,hints:{incrementValue:.05}},imageCropEndAngle:{key:"imageCropEndAngle",name:"Image Crop End Angle",type:$.NUMBER,hints:{incrementValue:.05}},imageRealworldWidth:{key:"imageRealworldWidth",name:"Image width in meters",type:$.NUMBER,hints:{incrementValue:.01}},recType:{key:"recType",name:"Recognition Type",type:$.ENUM},targetImage:{key:"targetImage",name:"Image to Recognize",type:$.ENUM},targetGeoLocation:{key:"targetGeoLocation",name:"Target Location",type:$.ENUM},text:{key:"text",name:"Text",type:$.STRING,hints:{multiline:!0}},fontSize:{key:"fontSize",name:"Font Size",type:$.NUMBER},padding:{key:"padding",name:"Padding",type:$.NUMBER},borderWidth:{key:"borderWidth",name:"Border width",type:$.NUMBER},borderRadius:{key:"borderRadius",name:"Corner Size",type:$.NUMBER},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:$.ENUM,locked:!1},textColor:{key:"textColor",name:"Text Color",type:$.COLOR,custom:!0},backgroundColor:{key:"backgroundColor",name:"BG Color",type:$.COLOR,custom:!0},borderColor:{key:"borderColor",name:"Border Color",type:$.COLOR,custom:!0},startColor:{key:"startColor",name:"Start",type:$.COLOR,custom:!0},endColor:{key:"endColor",name:"End",type:$.COLOR,custom:!0},drawBackground:{key:"drawBackground",name:"BG?",type:$.BOOLEAN},scriptBody:{key:"scriptBody",name:"code",type:$.STRING,hints:{multiline:!0}},defaultScene:{key:"defaultScene",name:"Start Scene",type:$.ENUM},visible:{key:"visible",name:"Visible",type:$.BOOLEAN},pointSize:{key:"pointSize",name:"Point Size",type:$.NUMBER},lifetime:{key:"lifetime",name:"Lifetime",type:$.NUMBER,hints:xt},texture:{key:"texture",name:"texture",type:$.ENUM},cssStyle:{key:"cssStyle",name:"Style",type:$.STRING,hints:{multiline:!0}},latitude:{key:"latitude",name:"Latitude",type:$.NUMBER},longitude:{key:"longitude",name:"Longitude",type:$.NUMBER},altitude:{key:"altitude",name:"altitude",type:$.NUMBER},useAltitude:{key:"useAltitude",name:"use altitude?",type:$.BOOLEAN}},Mt=["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"],jt={cube:"cube",sphere:"sphere",plane:"plane",model:"model",bg360:"bg360",text:"text",img2d:"img2d",group:"group",particles:"particles",imageanchor:"imageanchor",geoanchor:"geoanchor"},Et={SCENE:"scene",ASSET:"asset",BEHAVIOR:"behavior",BEHAVIOR_SCRIPT:"behavior_script",ASSETS_LIST:"assets",BEHAVIORS_LIST:"behaviors",ROOT:"root"},At={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"};function Pt(e){return e===jt.cube||(e===jt.sphere||(e===jt.plane||(e===jt.model||(e===jt.text||(e===jt.bg360||(e===jt.img2d||(e===jt.group||(e===jt.particles||(e===jt.imageanchor||e===jt.geoanchor)))))))))}function Dt(e){return e===jt.group||(e===jt.imageanchor||(e===jt.geoanchor||e===Et.SCENE))}function Lt(e){return!!Pt(e)||e===Et.SCENE}function It(e){return e!==Et.ROOT&&(e!==Et.ASSETS_LIST&&e!==Et.BEHAVIORS_LIST)}function Tt(e){if(e===jt.cube)return new tt;if(e===jt.sphere)return new rt;if(e===jt.plane)return new nt;if(e===jt.model)return new st;if(e===jt.bg360)return new ct;if(e===jt.text)return new lt;if(e===jt.img2d)return new pt;if(e===jt.group)return new dt;if(e===jt.particles)return new bt;if(e===jt.imageanchor)return new kt;if(e===jt.geoanchor)return new St;throw new Error("unknown 3d object type ".concat(e))}var Rt={PNG:"image/png",JPEG:"image/jpeg",MP3:"audio/mpeg",AAC:"audio/aac",JAVASCRIPT:"text/javascript",GLB:"model/gltf-binary",MP4:"video/mp4"},Bt={BEHAVIOR:"behavior",IMAGE:"image",GLTF:"gltf",AUDIO:"audio",VIDEO:"video",GEOLOCATION:"geolocation"};function Nt(e){return!!e&&(e.toLowerCase()===Rt.PNG||e.toLowerCase()===Rt.JPEG)}var Ft={plane:"plane",cube:"square",sphere:"circle",model:"cube",asset:"file",assets:"archive",behavior:"superpowers",behavior_script:"superpowers",scene:"globe",bg360:"image",img2d:"image",image:"image",text:"font",audio:"music",video:"video-camera",group:"object-group",particles:"certificate",gltf:"cube",imageanchor:"anchor",geoanchor:"globe",geolocation:"globe",cut:"cut",copy:"copy",paste:"paste",delete:"close"};function Gt(e){return Function('"use strict"; return('+e+")")()}var Ut={SCENE_START:"SCENE_START"},zt=r(9),Ht=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).renderThree=function(e){r.renderer.render(r.scene,r.camera)},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.initThreeJS()}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,"GLTF viewer",i.a.createElement("div",{ref:function(t){return e.sceneContainer=t}}))}},{key:"initThreeJS",value:function(){var e=this,t=this.props.asset;this.scene=new Xe.Scene,this.scene.background=new Xe.Color(0),this.camera=new Xe.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new Xe.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.renderer.vr.enabled=!0,this.sceneContainer.appendChild(this.renderer.domElement),this.vrmanager=new zt.h(this.renderer),window.addEventListener("resize",function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight)},!1),this.renderer.setAnimationLoop(this.renderThree);var r=new Xe.DirectionalLight(16777215,1);r.position.set(1,1,1).normalize(),this.scene.add(r),this.scene.add(new Xe.AmbientLight(16777215,.2)),console.log("rendering the asset",t);var n=new at;console.log("loading the url",t.src),n.load(t.src,function(t){console.log("loaded",t),e.scene.add(t.scene.clone())})}}]),t}(n.Component),Vt=r(18),Wt=(r(58),function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e,r))).updateLocation=function(e){var t=n.props.provider.accessObject(n.props.asset.id),r=Object(Vt.b)({lat:t.latitude,lon:t.longitude});n.marker.setLatLng(r),n.mymap.panTo(r)},n}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement("div",{id:"mapid",ref:function(t){return e.div=t},style:{width:"400px",height:"400px",border:"1px solid black"}})}},{key:"componentDidMount",value:function(){this.mymap=Object(Vt.c)("mapid").setView([this.props.asset.longitude,this.props.asset.latitude],3),Object(Vt.e)("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery \xa9 <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(this.mymap);var e=Object(Vt.a)({className:"map-icon"});this.marker=Object(Vt.d)([this.props.asset.longitude,this.props.asset.latitude],{title:"this is the geo location",icon:e}).addTo(this.mymap),this.props.provider.on(F.PROPERTY_CHANGED,this.updateLocation)}},{key:"componentWillUnmount",value:function(){this.props.provider.off(F.PROPERTY_CHANGED,this.updateLocation)}}]),t}(n.Component)),Kt=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=ie(this.props.provider.getDataGraph(),this.props.asset);return i.a.createElement("div",null,"asset view",i.a.createElement("h3",null,e.type," : ",i.a.createElement("b",null,e.title)),this.renderAsset(e))}},{key:"renderAsset",value:function(e){return e.subtype===Bt.IMAGE?i.a.createElement("img",{src:e.src,alt:e.title}):e.subtype===Bt.AUDIO?i.a.createElement("audio",{src:e.src,controls:!0}):e.subtype===Bt.VIDEO?i.a.createElement("video",{src:e.src,controls:!0,crossOrigin:"anonymous"}):e.subtype===Bt.BEHAVIOR?i.a.createElement("div",null,e.src):e.subtype===Bt.GLTF?i.a.createElement(Ht,{asset:e}):e.subtype===Bt.GEOLOCATION?i.a.createElement(Wt,{asset:e,provider:this.props.provider}):i.a.createElement("div",null,"unknown type")}}]),t}(n.Component);function Yt(e,t,r,n){var i=n.accessObject(n.getDataGraph().createObject({type:Et.ASSET,subtype:Bt.IMAGE,format:t,src:e,width:100,height:100,title:r,parent:0}));n.accessObject(n.getAssetsObject()).insertChildLast(i),n.requestImageCache(e).then(function(e){i.set("width",e.width),i.set("height",e.height)})}function Zt(e,t){R.add("uploading "+e.name),t.uploadFile(e).then(function(r){return R.add("uploaded"),!1===r.success?console.log("there was an error uploading! :("):Yt(z()+r.asset.id,r.asset.mimeType,e.name,t)})}function Qt(e,t){R.add("uploading "+e.name),t.uploadFile(e).then(function(r){if(R.add("uploaded"),!1===r.success)return console.log("there was an error uploading! :(");var n=z()+r.asset.id,i=t.getDataGraph(),a=ie(i,i.createObject({type:Et.ASSET,subtype:Bt.GLTF,format:Rt.GLB,src:n,title:e.name,parent:0}));t.accessObject(t.getAssetsObject()).insertChildLast(a)})}function Jt(e,t,r,n){if(r||(r=e.substring(e.lastIndexOf("/")+1)),!t){var i=r.substring(r.lastIndexOf(".")+1);t="audio/unknown","mp3"===i.toLowerCase()&&(t=Rt.MP3),"aac"===i.toLowerCase()&&(t=Rt.AAC)}var a=n.getDataGraph(),s=ie(a,a.createObject({type:Et.ASSET,subtype:Bt.AUDIO,format:t,src:e,title:r,parent:0}));n.accessObject(n.getAssetsObject()).insertChildLast(s)}var qt=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){h.c.hide()},r.okay=function(){var e,t,n,i,a;h.c.hide(),"remote"===r.state.view?(console.log("adding the url",r.state.url),e=r.state.url,t=r.props.provider,n=e.substring(e.lastIndexOf("/")+1),i=n.substring(n.lastIndexOf(".")+1),a="image/unknown","png"===i.toLowerCase()&&(a=Rt.PNG),"jpg"===i.toLowerCase()&&(a=Rt.JPEG),"jpeg"===i.toLowerCase()&&(a=Rt.JPEG),Yt(e,a,n,t)):(console.log("the file input is",r.fileInput),re(r.fileInput.current.files).forEach(function(e){Zt(e,r.props.provider)}))},r.switchLocal=function(){return r.setState({view:"local"})},r.switchRemote=function(){return r.setState({view:"remote"})},r.selectedFile=function(e){r.setState({fileInput:e.target.value})},r.typedURL=function(e){r.setState({url:e.target.value})},r.state={view:"local",url:""},r.fileInput=i.a.createRef(),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"add image to assets"),i.a.createElement(h.g,{grow:!0},i.a.createElement(S,null,i.a.createElement(M,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),i.a.createElement(M,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?i.a.createElement(h.d,null,i.a.createElement("label",null,"File",i.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):i.a.createElement(h.d,null,i.a.createElement("label",null,"URL",i.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),t}(n.Component),$t=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).redraw=function(){if(r.canvas){var e=r.canvas.getContext("2d"),t=r.props.provider.getPageSize(r.props.page).as(he.PIXEL,1,de);r.canvas.width=t.width,r.canvas.height=t.height,e.fillStyle="white",e.fillRect(0,0,r.canvas.width,r.canvas.height),e.save(),e.scale(r.state.scale,r.state.scale);var n=r.props.provider.getRawGraph(),i=r.props.page;i&&r.drawPage(e,n,i),e.restore()}},r.handleKeypress=function(e){"ArrowRight"===e.key&&r.props.onNext(),"ArrowLeft"===e.key&&r.props.onPrev()},r.state={scale:1},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.canvas.focus(),this.redraw()}},{key:"componentDidUpdate",value:function(e){this.redraw()}},{key:"drawPage",value:function(e,t,r){var n=this;ae(t,r.children).forEach(function(r){return n.drawLayer(e,t,ie(t,r))})}},{key:"drawLayer",value:function(e,t,r){var n=this;ae(t,r.children).forEach(function(r){return n.drawShape(e,t,ie(t,r))})}},{key:"drawShape",value:function(e,t,r){var n=this.props.provider.getShapeDef(r.type);n&&n.draw(e,t,r,D.getSelection()===r.id,this.props.provider)}},{key:"render",value:function(){var e=this;return i.a.createElement("canvas",{tabIndex:-1,width:100,height:100,ref:function(t){return e.canvas=t},style:{width:"100vw"},onClick:this.props.onNext,onKeyDown:this.handleKeypress})}}]),t}(n.Component),Xt=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).docSwapped=function(){return r.setState({pageIndex:0})},r.onNext=function(){var e=r.getPages();r.state.pageIndex===e.length-1&&(r.state.pageIndex=-1),r.setState({pageIndex:r.state.pageIndex+1})},r.onPrev=function(){var e=r.getPages();0===r.state.pageIndex&&(r.state.pageIndex=e.length),r.setState({pageIndex:r.state.pageIndex-1})},r.state={pageIndex:-1},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.props.provider.on(F.DOCUMENT_SWAPPED,this.docSwapped)}},{key:"getPages",value:function(){var e=this.props.provider;return e.accessObject(e.getSceneRoot()).array("children").map(function(t){return e.accessObject(t)}).filter(function(e){return"page"===e.type})}},{key:"render",value:function(){var e=this.props.provider,t=this.getPages();if(this.state.pageIndex<0)return i.a.createElement("div",null,"no pages loaded");var r=t[this.state.pageIndex];return i.a.createElement($t,{page:r,provider:e,onNext:this.onNext,onPrev:this.onPrev})}}]),t}(n.Component),_t=function(){function e(t){Object(o.a)(this,e),this.graph=t}return Object(c.a)(e,[{key:"object",value:function(e){var t=this;if(this.graph.hasObject(e)){var r={};return this.graph.getPropertiesForObject(e).forEach(function(n){r[n]=t.graph.getPropertyValue(e,n)}),r.id=e,r.exists=function(){return!0},r.set=function(n,i){return t.graph.setProperty(e,n,i),r},r.props=function(){var r={};return t.graph.getPropertiesForObject(e).forEach(function(n){r[n]=t.graph.getPropertyValue(e,n)}),r},r.array=function(e){for(var n=r[e],i=t.graph.getArrayLength(n),a=[],s=0;s<i;s++)a.push(t.graph.getElementAt(n,s));return a},r.getChildren=function(){return r.children?r.array("children").map(function(e){return t.object(e)}):[]},r.insertChildLast=function(e){t.graph.setProperty(e.id,"parent",r.id);var n=t.graph.getPropertyValue(r.id,"children"),i=t.graph.getArrayLength(n),a=t.graph.getElementAt(n,i-1);t.graph.insertAfter(n,a,e.id)},r.insertFirstChild=function(e){t.graph.setProperty(e.id,"parent",r.id);var n=t.graph.getPropertyValue(r.id,"children");t.graph.insertAfter(n,null,e.id)},r.child=function(e){return t.object(r.array("children")[e])},r.removeFromParent=function(){var e=t.object(r.parent),n=e.array("children").findIndex(function(e){return e===r.id});n>=0?t.graph.removeElement(e.children,n):console.error("could not find index for child",r,"in children",e.children)},r.clone=function(){var e=r.id,n=t.graph.createObject();return t.graph.getPropertiesForObject(e).forEach(function(r){t.graph.createProperty(n,r,t.graph.getPropertyValue(e,r))}),t.object(n)},r.find=function(e,t){return t||(t=[]),e(r)&&t.push(r),r.children&&r.getChildren().forEach(function(r){r.find(e,t)}),t},r}return{exists:function(){return!1}}}}]),e}(),er=function(e){var t="---";e.value&&e.provider&&(t=e.provider.getDataGraph().getPropertyValue(e.value,"title"));return i.a.createElement("b",null,t)},tr=[{name:"1024 x 768 pixels",value:"1024x768px"},{name:"VGA (640x480)",value:"640x480px"},{name:"A4 paper",value:"210x297mm"},{name:"16:9",value:"300x169mm"},{name:"4:3",value:"225x169mm"}],rr=function(e){var t="---";if(e.value&&e.provider){var r=tr.find(function(t){return t.value===e.value});t=r?r.name:e.value}return i.a.createElement("b",null,t)},nr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).getApp=function(){return"view"===r.mode?i.a.createElement(Xt,{provider:Object(f.a)(Object(f.a)(r))}):i.a.createElement(ir,{provider:Object(f.a)(Object(f.a)(r))})},r.getTitle=function(){return"MetaDoc"},r.getRendererForItem=function(e){if(!r.getDataGraph().getObjectById(e))return i.a.createElement("div",null,"???");var t=r.getDataGraph().getPropertyValue(e,"type"),n=r.getDataGraph().getPropertyValue(e,"title");return Ke[t]?i.a.createElement("div",null,i.a.createElement("i",{className:"fa fa-".concat(Ke[t])})," ",n):i.a.createElement("div",null,n)},r.addShape=function(e){var t=r.getDataGraph(),n=r.getSelectedLayer();if(!n)return console.error("no layer!");se(t,n,e.make(t,n))},r.addRect=function(){return r.addShape(r.getShapeDef("rect"))},r.addCircle=function(){return r.addShape(r.getShapeDef("circle"))},r.addText=function(){return r.addShape(r.getShapeDef("text"))},r.addImage=function(){return r.addShape(r.getShapeDef("image"))},r.addImageAssetFromFile=function(e){r.uploadFile(e).then(function(t){console.log("uploaded file with answer",t);var n=z()+t.id,i=r.getDataGraph(),a=ie(i,i.createObject({type:"asset",subtype:"image",format:e.type,src:n,width:100,height:100,title:e.name,parent:0})),s=ie(i,r.getAssetsObject());oe(i,s,a),r.requestImageCache(n).then(function(e){i.setProperty(a.id,"width",e.width),i.setProperty(a.id,"height",e.height)})})},r.addImageAssetFromURL=function(e){var t=e.substring(e.lastIndexOf("/")+1),n=t.substring(t.lastIndexOf(".")+1),i="image/unknown";"png"===n.toLowerCase()&&(i="image/png"),"jpg"===n.toLowerCase()&&(i="image/jpeg"),"jpeg"===n.toLowerCase()&&(i="image/jpeg");var a=r.getDataGraph(),s=ie(a,a.createObject({type:"asset",subtype:"image",format:i,src:e,width:100,height:100,title:t,parent:0})),o=ie(a,r.getAssetsObject());oe(a,o,s),r.requestImageCache(e).then(function(e){a.setProperty(s.id,"width",e.width),a.setProperty(s.id,"height",e.height)})},r.deleteSelection=function(){var e=r.getDataGraph(),t=r.getSelectedShape();t&&(ce(e,t),D.clearSelection())},r.deleteSelectedAsset=function(){var e=r.getDataGraph();ce(e,ie(e,D.getSelection())),D.clearSelection()},r.cutSelection=function(){var e=r.getDataGraph(),t=D.getSelection();if(t){var n=ie(e,t);D.setClipboard(n.id),ce(e,n),D.clearSelection()}},r.copySelection=function(){var e=r.getDataGraph(),t=D.getSelection();if(t){var n=ie(e,t);D.setClipboard(n.id)}},r.pasteSelection=function(e){if(e.target&&"input"===e.target.getAttribute("type"))return console.log("pasting into an input field. don't intercept");var t=r.getDataGraph(),n=ie(t,D.getClipboard()),i=null;if($e(n.type)&&(i=r.getSelectedLayer()),"layer"===n.type&&(i=r.getSelectedPage()),"page"===n.type&&(i=ie(t,r.getSceneRoot())),!i)return console.error("no parent to ad too! bad obj type?",n.type);var a=function(e,t){var r=t.id,n=e.createObject();return e.getPropertiesForObject(r).forEach(function(t){e.createProperty(n,t,e.getPropertyValue(r,t))}),ie(e,n)}(t,n);t.setProperty(a.id,"parent",i.id),se(t,i,a)},r.exportSVG=function(){var e=r.getSelectedPage(),t=r.renderSVGWrapper(r.renderSVGChildren(e)),n=document.createElement("a");n.href="data:image/svg+xml,"+encodeURIComponent(t),n.download="test.svg",document.body.appendChild(n),n.click()},r.exportPNG=function(){var e=r.getSelectedPage(),t=document.createElement("canvas"),n=t.getContext("2d"),i=r.getRawGraph(),a=r.getPageSize(e).as(he.PIXEL,1,de);t.width=a.width,t.height=a.height,n.fillStyle="white",n.fillRect(0,0,t.width,t.height),e&&r.accessObject(e.id).getChildren().forEach(function(e){e.getChildren().forEach(function(e){var t=r.getShapeDef(e.type);t&&t.draw(n,i,e,!1,Object(f.a)(Object(f.a)(r)))})});var s=document.createElement("a");s.href=t.toDataURL("image/png"),s.download="test.png",document.body.appendChild(s),s.click()},r.newView=function(){return window.open("./?mode=metadoc&doctype=".concat(r.getDocType(),"&doc=").concat(r.getDocId()))},r.openPresentationView=function(){return window.open("./?mode=view&doctype=".concat(r.getDocType(),"&doc=").concat(r.getDocId()))},r.getAssetsObject=function(){return r.getDataGraph().getObjectByProperty("type","assets")},r.showAddImageAssetDialog=function(){return h.c.show(i.a.createElement(qt,{provider:Object(f.a)(Object(f.a)(r))}))},r.accessObject=function(e){return new _t(r.getDataGraph()).object(e)},r.imagecache={},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"getDocType",value:function(){return"metadoc"}},{key:"makeEmptyRoot",value:function(e){var t=ie(e,e.createObject({type:"root",title:"root",pageSize:"640 x 480 px",children:e.createArray(),parent:0})),r=ie(e,e.createObject({type:"page",title:"page 1",children:e.createArray(),parent:0})),n=ie(e,e.createObject({type:"layer",title:"layer 1",children:e.createArray(),parent:0})),i=We.rect.make(e,n),a=ie(e,e.createObject({type:"assets",title:"Assets",children:e.createArray(),parent:0}));se(e,n,i),se(e,r,n),se(e,t,r),oe(e,t,a)}},{key:"setPropertyValue",value:function(e,r,n){if(Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,r,n),r.key===Ve.asset.key){var i=ie(this.getDataGraph(),n);Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"width"},i.width),Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"height"},i.height)}}},{key:"getProperties",value:function(e){var t=this;var r=[];if(!e)return r;var n=this.syncdoc.getPropertiesForObject(e);return n&&n.forEach(function(n){if("type"!==n&&"children"!==n&&"parent"!==n){var i=t.syncdoc.getPropertyValue(e,n);if(Ve[n])return r.push(function(e,t){var r={};return Object.keys(e).forEach(function(t){return r[t]=e[t]}),r.value=t,r}(Ve[n],i));console.log("unknown property",n)}}),r}},{key:"createCustomEditor",value:function(e,t,r,n,a){if(t.key===Ve.fillColor.key)return i.a.createElement(h.d,null,["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"].map(function(e){return i.a.createElement("button",{key:e,onClick:function(){return a(e)},style:{color:e,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})}));if(t.key===Ve.pageSize.key){var s=ie(this.getDataGraph(),e);return i.a.createElement(Q,{def:t,provider:this,obj:e,value:s.pageSize,onChange:a})}return i.a.createElement("i",null,"no custom editor for ",t.key)}},{key:"getValuesForEnum",value:function(e,t){if(e===Ve.asset.key){var r=this.getDataGraph().getPropertyValue(this.getAssetsObject(),"children");return ae(this.getDataGraph(),r)}return e===Ve.fontFamily.key?Object.keys(Qe).map(function(e){return Qe[e]}):e===Ve.verticalAlign.key?Object.keys(Ye).map(function(e){return Ye[e]}):e===Ve.horizontalAlign.key?Object.keys(Ze).map(function(e){return Ze[e]}):e===Ve.pageSize.key?tr.map(function(e){return e.value}):void 0}},{key:"getRendererForEnum",value:function(e,t){return e===Ve.asset.key?er:e===Ve.pageSize.key?rr:void 0}},{key:"getPageSize",value:function(e){var t=this.getSceneRoot(),r=ie(this.getDataGraph(),t);return console.log("parsing",r),function(e){e.value&&(e=e.value);var t=e.trim().match(/(\d+)\s*x\s*(\d+)\s*(px|mm)/);return"px"===t[3]?new fe(parseInt(t[1]),parseInt(t[2]),he.PIXEL):"mm"===t[3]?new fe(parseInt(t[1]),parseInt(t[2]),he.MILLIMETER):new fe(100,100,he.PIXEL)}(r.pageSize)}},{key:"getShapeDef",value:function(e){return We[e]}},{key:"getSelectedRoot",value:function(){return ie(this.getDataGraph(),this.getSceneRoot())}},{key:"getSelectedPage",value:function(){var e=D.getSelection();if(!e)return null;for(;;){var t=this.getDataGraph().getPropertyValue(e,"type");if("root"===t)return null;if("page"===t)return ie(this.getDataGraph(),e);if(!(e=this.getDataGraph().getPropertyValue(e,"parent")))break}}},{key:"getSelectedLayer",value:function(){var e=D.getSelection();if(!e)return null;for(;;){var t=this.getDataGraph().getPropertyValue(e,"type");if("root"===t)return null;if("layer"===t)return ie(this.getDataGraph(),e);if(!(e=this.getDataGraph().getPropertyValue(e,"parent")))break}console.log(ie(this.getDataGraph(),e))}},{key:"getSelectedShape",value:function(){var e=D.getSelection();if(!e)return null;var t=this.getDataGraph().getPropertyValue(e,"type");return We[t]?ie(this.getDataGraph(),e):null}},{key:"calculateContextMenu",value:function(e){var t=ie(this.getDataGraph(),e);return"assets"===t.type?[{title:"Add Image",icon:"image",fun:this.showAddImageAssetDialog}]:"asset"===t.type?[{title:"delete",icon:"close",fun:this.deleteSelectedAsset}]:[{title:"delete",icon:"close",fun:this.deleteSelection},{title:"rect",icon:Ke.rect,fun:this.addRect},{title:"circle",icon:Ke.circle,fun:this.addCircle},{title:"text",icon:Ke.text,fun:this.addText},{title:"image",icon:Ke.image,fun:this.addImage},{title:"cut",icon:Ke.cut,fun:this.cutSelection},{title:"copy",icon:Ke.copy,fun:this.copySelection},{title:"paste",icon:Ke.paste,fun:this.pasteSelection}]}},{key:"renderSVGWrapper",value:function(e){return'<svg id="svg-canvas" viewBox="0 0 1000 1000" \n                xmlns="http://www.w3.org/2000/svg" \n                xmlnsXlink="http://www.w3.org/1999/xlink">\n                '.concat(e,"</svg>")}},{key:"renderSVGChildren",value:function(e){var t=this;return"page"===e.type?ae(this.getDataGraph(),e.children).map(function(e){return"<g>".concat(t.renderSVGChildren(ie(t.getDataGraph(),e)),"</g>")}).join(""):"layer"===e.type?ae(this.getDataGraph(),e.children).map(function(e){return t.renderSVGChildren(ie(t.getDataGraph(),e))}).join(""):We[e.type]?We[e.type].toSVGString(e,this):""}},{key:"canAddChild",value:function(e,t){var r=ie(this.getDataGraph(),e),n=ie(this.getDataGraph(),t);return!("layer"!==r.type||!$e(n.type))||("page"===r.type&&"layer"===n.type||"root"===r.type&&"page"===n.type)}},{key:"canBeSibling",value:function(e,t){var r=ie(this.getDataGraph(),e),n=ie(this.getDataGraph(),t);return"layer"===r.type&&"layer"===n.type||("page"===r.type&&"page"===n.type||!(!$e(r.type)||!$e(n.type)))}},{key:"canAddExternalChild",value:function(e,t){return"assets"===ie(this.getDataGraph(),e).type}},{key:"acceptDrop",value:function(e,t){var r=this;"assets"===ie(this.getDataGraph(),t).type&&re(e.dataTransfer.files).forEach(function(e){return r.addImageAssetFromFile(e)})}},{key:"isImageCached",value:function(e){return!!this.imagecache[e]&&this.imagecache[e].complete}},{key:"requestImageCache",value:function(e){var t=this,r=new Image;return this.imagecache[e]=r,new Promise(function(n,i){r.src=e,r.onload=function(){t.fire(F.STRUCTURE_CHANGED,{provider:t}),n(r)}})}},{key:"getCachedImage",value:function(e){return this.imagecache[e]}}]),t}(Ne),ir=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).canvasSelected=function(e){return D.setSelection(e)},r.showAddPopup=function(e){var t=[{title:"page",icon:Ke.page,fun:function(){return r.addPage()}},{title:"layer",icon:Ke.layer,fun:function(){return r.addLayer()}},{title:"rect",icon:Ke.rect,fun:function(){return r.props.provider.addRect()}},{title:"circle",icon:Ke.circle,fun:function(){return r.props.provider.addCircle()}},{title:"text",icon:Ke.text,fun:function(){return r.props.provider.addText()}},{title:"image",icon:Ke.image,fun:function(){return r.props.provider.addImage()}}];h.f.show(i.a.createElement(j,{actions:t}),e.target)},r.addPage=function(){var e=r.props.provider.getDataGraph(),t=r.props.provider.getSelectedRoot(),n=ie(e,ne(e,{type:"page",title:"new page",parent:t.id,children:e.createArray()}));se(e,t,n)},r.addLayer=function(){var e=r.props.provider.getDataGraph(),t=r.props.provider.getSelectedPage(),n=ie(e,ne(e,{type:"layer",title:"new layer",parent:t.id,children:e.createArray()}));se(e,t,n)},r.zoomIn=function(){return r.setState({zoom:r.state.zoom+1})},r.zoomOut=function(){return r.setState({zoom:r.state.zoom-1})},r.state={connected:!1,zoom:0,mode:"canvas"},r.im=new Fe,r.im.addKeyBinding({id:"save",key:Fe.KEYS.S,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"undo",key:Fe.KEYS.Z,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"redo",key:Fe.KEYS.Z,modifiers:[Fe.MODIFIERS.COMMAND,Fe.MODIFIERS.SHIFT]}),r.im.addListener("save",r.props.provider.save),r.im.addListener("undo",r.props.provider.performUndo),r.im.addListener("redo",r.props.provider.performRedo),r.im.addKeyBinding({id:"cut",key:Fe.KEYS.X,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"copy",key:Fe.KEYS.C,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"paste",key:Fe.KEYS.V,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addListener("cut",r.props.provider.cutSelection),r.im.addListener("copy",r.props.provider.copySelection),r.im.addListener("paste",r.props.provider.pasteSelection),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.im.attachKeyEvents(document),this.props.provider.on("CONNECTED",function(){return e.setState({connected:e.props.provider.isConnected()})}),D.on(A,function(){var t=D.getSelection();if(t&&ie(e.props.provider.getDataGraph(),t).type===Ve.asset.key)return void e.setState({mode:"asset"});e.setState({mode:"canvas"})})}},{key:"render",value:function(){var e=this.props.provider;return i.a.createElement(E,null,i.a.createElement(S,{left:!0,top:!0},i.a.createElement("label",null,e.getTitle())),i.a.createElement(x,{scroll:!0,left:!0,middle:!0},i.a.createElement(pe,{root:e.getSceneRoot(),provider:e})),i.a.createElement(S,{left:!0,bottom:!0},i.a.createElement("button",{className:"fa fa-plus",onClick:this.showAddPopup}),i.a.createElement("button",{className:"fa fa-close",onClick:e.deleteSelection}),i.a.createElement("button",{className:"fa fa-file-image-o",onClick:e.showAddImageAssetDialog})),i.a.createElement(S,{center:!0,top:!0},i.a.createElement("button",{className:"fa fa-save",onClick:e.save}),i.a.createElement("button",{className:"fa fa-download",onClick:e.exportSVG}," SVG"),i.a.createElement("button",{className:"fa fa-download",onClick:e.exportPNG}," PNG"),i.a.createElement("button",{className:"fa fa-undo",onClick:e.performUndo}),i.a.createElement("button",{className:"fa fa-repeat",onClick:e.performRedo}),i.a.createElement("button",{className:"fa fa-search-plus",onClick:this.zoomIn}),i.a.createElement("button",{className:"fa fa-search-minus",onClick:this.zoomOut}),i.a.createElement(C,null),i.a.createElement("button",{className:"fa fa-cut",onClick:e.cutSelection}),i.a.createElement("button",{className:"fa fa-copy",onClick:e.copySelection}),i.a.createElement("button",{className:"fa fa-paste",onClick:e.pasteSelection}),i.a.createElement(C,null),i.a.createElement("button",{className:"fa fa-play",onClick:e.openPresentationView}),i.a.createElement("button",{className:"fa fa-plus",onClick:e.newView}," view"),i.a.createElement("button",{className:"fa fa-superpowers",onClick:e.toggleConnected},this.state.connected?"disconnect":"connect")),i.a.createElement(x,{center:!0,middle:!0,scroll:!0},this.renderCenterPane(this.state.mode)),i.a.createElement(x,{scroll:!0,right:!0},i.a.createElement(_,{provider:e})),i.a.createElement(S,{right:!0,top:!0}),i.a.createElement(S,{right:!0,bottom:!0}))}},{key:"renderCenterPane",value:function(e){if("canvas"===e)return i.a.createElement(ve,{prov:this.props.provider,onSelect:this.canvasSelected,scale:Math.pow(2,this.state.zoom)});var t=D.getSelection();return i.a.createElement(Kt,{provider:this.props.provider,asset:t})}}]),t}(n.Component),ar=r(1),sr=function(e,t){ar.Object3D.call(this),t=void 0!==t?t:document,this.visible=!1;var r=new or;this.add(r);var n=new cr;this.add(n);var i=this;B("camera",e),B("object",void 0),B("enabled",!0),B("axis",null),B("mode","translate"),B("translationSnap",null),B("rotationSnap",null),B("space","world"),B("size",1),B("dragging",!1),B("showX",!0),B("showY",!0),B("showZ",!0);var a={type:"change"},s={type:"mouseDown"},o={type:"mouseUp",mode:i.mode},c={type:"objectChange"},u=new ar.Raycaster,l=new ar.Vector3,p=new ar.Vector3,h=new ar.Quaternion,d={X:new ar.Vector3(1,0,0),Y:new ar.Vector3(0,1,0),Z:new ar.Vector3(0,0,1)},f=new ar.Quaternion,v=new ar.Vector3,y=new ar.Vector3,g=new ar.Vector3,m=new ar.Vector3,b=0,w=new ar.Vector3,k=new ar.Quaternion,O=new ar.Vector3,S=new ar.Vector3,x=new ar.Quaternion,C=new ar.Vector3,M=new ar.Vector3,j=new ar.Quaternion,E=new ar.Vector3,A=new ar.Vector3,P=new ar.Quaternion,D=new ar.Vector3,L=new ar.Vector3,I=new ar.Vector3,T=new ar.Quaternion,R=new ar.Vector3;function B(e,t){var s=t;Object.defineProperty(i,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,n[e]=t,r[e]=t,i.dispatchEvent({type:e+"-changed",value:t}),i.dispatchEvent(a))}}),i[e]=t,n[e]=t,r[e]=t}function N(e){var r=e.changedTouches?e.changedTouches[0]:e,n=t.getBoundingClientRect();return{x:(r.clientX-n.left)/n.width*2-1,y:-(r.clientY-n.top)/n.height*2+1,button:e.button}}function F(e){e.preventDefault()}function G(e){i.enabled&&i.pointerHover(N(e))}function U(e){i.enabled&&(e.preventDefault(),document.addEventListener("mousemove",z,!1),i.pointerHover(N(e)),i.pointerDown(N(e)))}function z(e){i.enabled&&(e.preventDefault(),i.pointerMove(N(e)))}function H(e){i.enabled&&(e.preventDefault(),document.removeEventListener("mousemove",z,!1),i.pointerUp(N(e)))}B("parentQuaternion",x),B("worldPosition",A),B("worldPositionStart",M),B("worldQuaternion",P),B("worldQuaternionStart",j),B("cameraPosition",w),B("cameraQuaternion",k),B("pointStart",y),B("pointEnd",g),B("rotationAxis",m),B("rotationAngle",b),B("eye",L),t.addEventListener("mousedown",U,!1),t.addEventListener("touchstart",U,!1),t.addEventListener("mousemove",G,!1),t.addEventListener("touchmove",G,!1),t.addEventListener("touchmove",z,!1),document.addEventListener("mouseup",H,!1),t.addEventListener("touchend",H,!1),t.addEventListener("touchcancel",H,!1),t.addEventListener("touchleave",H,!1),t.addEventListener("contextmenu",F,!1),this.dispose=function(){t.removeEventListener("mousedown",U),t.removeEventListener("touchstart",U),t.removeEventListener("mousemove",G),t.removeEventListener("touchmove",G),t.removeEventListener("touchmove",z),document.removeEventListener("mouseup",H),t.removeEventListener("touchend",H),t.removeEventListener("touchcancel",H),t.removeEventListener("touchleave",H),t.removeEventListener("contextmenu",F)},this.attach=function(e){this.object=e,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(S,x,C),this.object.matrixWorld.decompose(A,P,D)),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(w,k,O),this.camera instanceof ar.PerspectiveCamera?L.copy(w).sub(A).normalize():this.camera instanceof ar.OrthographicCamera&&L.copy(w).normalize(),ar.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){u.setFromCamera(e,this.camera);var t=u.intersectObjects(r.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)&&(0===e.button||void 0===e.button)&&null!==this.axis){u.setFromCamera(e,this.camera);var t=u.intersectObjects([n],!0)[0]||!1;if(t){var r=this.space;if("scale"===this.mode?r="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(r="world"),"local"===r&&"rotate"===this.mode){var i=this.rotationSnap;"X"===this.axis&&i&&(this.object.rotation.x=Math.round(this.object.rotation.x/i)*i),"Y"===this.axis&&i&&(this.object.rotation.y=Math.round(this.object.rotation.y/i)*i),"Z"===this.axis&&i&&(this.object.rotation.z=Math.round(this.object.rotation.z/i)*i)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),I.copy(this.object.position),T.copy(this.object.quaternion),R.copy(this.object.scale),this.object.matrixWorld.decompose(M,j,E),y.copy(t.point).sub(M),"local"===r&&y.applyQuaternion(j.clone().inverse())}this.dragging=!0,s.mode=this.mode,this.dispatchEvent(s)}},this.pointerMove=function(e){var t=this.axis,r=this.mode,i=this.object,s=this.space;if("scale"===r?s="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(s="world"),void 0!==i&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){u.setFromCamera(e,this.camera);var o=u.intersectObjects([n],!0)[0]||!1;if(!1!==o){if(g.copy(o.point).sub(M),"local"===s&&g.applyQuaternion(j.clone().inverse()),"translate"===r)-1===t.search("X")&&(g.x=y.x),-1===t.search("Y")&&(g.y=y.y),-1===t.search("Z")&&(g.z=y.z),"local"===s?i.position.copy(g).sub(y).applyQuaternion(T):i.position.copy(g).sub(y),i.position.add(I),this.translationSnap&&("local"===s&&(i.position.applyQuaternion(h.copy(T).inverse()),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(T)),"world"===s&&(i.parent&&i.position.add(l.setFromMatrixPosition(i.parent.matrixWorld)),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(l.setFromMatrixPosition(i.parent.matrixWorld))));else if("scale"===r){if(-1!==t.search("XYZ")){var w=g.length()/y.length();g.dot(y)<0&&(w*=-1),l.set(w,w,w)}else l.copy(g).divide(y),-1===t.search("X")&&(l.x=1),-1===t.search("Y")&&(l.y=1),-1===t.search("Z")&&(l.z=1);i.scale.copy(R).multiply(l)}else if("rotate"===r){var k=20/A.distanceTo(l.setFromMatrixPosition(this.camera.matrixWorld)),O="local"===this.space?P:f,S=d[t];"E"===t?(l.copy(g).cross(y),m.copy(L),b=g.angleTo(y)*(l.dot(L)<0?1:-1)):"XYZE"===t?(l.copy(g).sub(y).cross(L).normalize(),m.copy(l),b=g.sub(y).dot(l.cross(L))*k):"X"!==t&&"Y"!==t&&"Z"!==t||(v.copy(S).applyQuaternion(O),m.copy(S),l=S.clone(),p=g.clone().sub(y),"local"===s&&(l.applyQuaternion(O),p.applyQuaternion(j)),b=p.dot(l.cross(L).normalize())*k),this.rotationSnap&&(b=Math.round(b/this.rotationSnap)*this.rotationSnap),this.rotationAngle=b,"local"===s?(i.quaternion.copy(T),i.quaternion.multiply(h.setFromAxisAngle(m,b))):(i.quaternion.copy(h.setFromAxisAngle(m,b)),i.quaternion.multiply(T))}this.dispatchEvent(a),this.dispatchEvent(c)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(o.mode=this.mode,this.dispatchEvent(o)),this.dragging=!1,void 0===e.button&&(this.axis=null))},this.getMode=function(){return i.mode},this.setMode=function(e){i.mode=e},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setSize=function(e){i.size=e},this.setSpace=function(e){i.space=e},this.update=function(){console.warn("TransformControls: update function has been depricated.")}};sr.prototype=Object.assign(Object.create(ar.Object3D.prototype),{constructor:sr,isTransformControls:!0});var or=function(){ar.Object3D.call(this),this.type="TransformControlsGizmo";var e=new ar.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:ar.DoubleSide,fog:!1}),t=new ar.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),r=e.clone();r.opacity=.15;var n=e.clone();n.opacity=.33;var i=e.clone();i.color.set(16711680);var a=e.clone();a.color.set(65280);var s=e.clone();s.color.set(255);var o=e.clone();o.opacity=.25;var c=o.clone();c.color.set(16776960);var u=o.clone();u.color.set(65535);var l=o.clone();l.color.set(16711935),e.clone().color.set(16776960);var p=t.clone();p.color.set(16711680);var h=t.clone();h.color.set(65280);var d=t.clone();d.color.set(255);var f=t.clone();f.color.set(65535);var v=t.clone();v.color.set(16711935);var y=t.clone();y.color.set(16776960);var g=t.clone();g.color.set(7895160);var m=y.clone();m.opacity=.25;var b=new ar.CylinderBufferGeometry(0,.05,.2,12,1,!1),w=new ar.BoxBufferGeometry(.125,.125,.125),k=new ar.BufferGeometry;k.addAttribute("position",new ar.Float32BufferAttribute([0,0,0,1,0,0],3));var O,S=function(e,t){for(var r=new ar.BufferGeometry,n=[],i=0;i<=64*t;++i)n.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return r.addAttribute("position",new ar.Float32BufferAttribute(n,3)),r},x={X:[[new ar.Mesh(b,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new ar.Mesh(b,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new ar.Line(k,p)]],Y:[[new ar.Mesh(b,a),[0,1,0],null,null,"fwd"],[new ar.Mesh(b,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new ar.Line(k,h),null,[0,0,Math.PI/2]]],Z:[[new ar.Mesh(b,s),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new ar.Mesh(b,s),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new ar.Line(k,d),null,[0,-Math.PI/2,0]]],XYZ:[[new ar.Mesh(new ar.OctahedronBufferGeometry(.1,0),o),[0,0,0],[0,0,0]]],XY:[[new ar.Mesh(new ar.PlaneBufferGeometry(.295,.295),c),[.15,.15,0]],[new ar.Line(k,y),[.18,.3,0],null,[.125,1,1]],[new ar.Line(k,y),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new ar.Mesh(new ar.PlaneBufferGeometry(.295,.295),u),[0,.15,.15],[0,Math.PI/2,0]],[new ar.Line(k,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new ar.Line(k,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new ar.Mesh(new ar.PlaneBufferGeometry(.295,.295),l),[.15,0,.15],[-Math.PI/2,0,0]],[new ar.Line(k,v),[.18,0,.3],null,[.125,1,1]],[new ar.Line(k,v),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},C={X:[[new ar.Mesh(new ar.CylinderBufferGeometry(.2,0,1,4,1,!1),r),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new ar.Mesh(new ar.CylinderBufferGeometry(.2,0,1,4,1,!1),r),[0,.6,0]]],Z:[[new ar.Mesh(new ar.CylinderBufferGeometry(.2,0,1,4,1,!1),r),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new ar.Mesh(new ar.OctahedronBufferGeometry(.2,0),r)]],XY:[[new ar.Mesh(new ar.PlaneBufferGeometry(.4,.4),r),[.2,.2,0]]],YZ:[[new ar.Mesh(new ar.PlaneBufferGeometry(.4,.4),r),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new ar.Mesh(new ar.PlaneBufferGeometry(.4,.4),r),[.2,0,.2],[-Math.PI/2,0,0]]]},M={START:[[new ar.Mesh(new ar.OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],END:[[new ar.Mesh(new ar.OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],DELTA:[[new ar.Line((O=new ar.BufferGeometry,O.addAttribute("position",new ar.Float32BufferAttribute([0,0,0,1,1,1],3)),O),n),null,null,null,"helper"]],X:[[new ar.Line(k,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ar.Line(k,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ar.Line(k,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},j={X:[[new ar.Line(S(1,.5),p)],[new ar.Mesh(new ar.OctahedronBufferGeometry(.04,0),i),[0,0,.99],null,[1,3,1]]],Y:[[new ar.Line(S(1,.5),h),null,[0,0,-Math.PI/2]],[new ar.Mesh(new ar.OctahedronBufferGeometry(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new ar.Line(S(1,.5),d),null,[0,Math.PI/2,0]],[new ar.Mesh(new ar.OctahedronBufferGeometry(.04,0),s),[.99,0,0],null,[1,3,1]]],E:[[new ar.Line(S(1.25,1),m),null,[0,Math.PI/2,0]],[new ar.Mesh(new ar.CylinderBufferGeometry(.03,0,.15,4,1,!1),m),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new ar.Mesh(new ar.CylinderBufferGeometry(.03,0,.15,4,1,!1),m),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new ar.Mesh(new ar.CylinderBufferGeometry(.03,0,.15,4,1,!1),m),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new ar.Mesh(new ar.CylinderBufferGeometry(.03,0,.15,4,1,!1),m),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new ar.Line(S(1,1),g),null,[0,Math.PI/2,0]]]},E={AXIS:[[new ar.Line(k,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={X:[[new ar.Mesh(new ar.TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new ar.Mesh(new ar.TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[Math.PI/2,0,0]]],Z:[[new ar.Mesh(new ar.TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[0,0,-Math.PI/2]]],E:[[new ar.Mesh(new ar.TorusBufferGeometry(1.25,.1,2,24),r)]],XYZE:[[new ar.Mesh(new ar.SphereBufferGeometry(.7,10,8),r)]]},P={X:[[new ar.Mesh(w,i),[.8,0,0],[0,0,-Math.PI/2]],[new ar.Line(k,p),null,null,[.8,1,1]]],Y:[[new ar.Mesh(w,a),[0,.8,0]],[new ar.Line(k,h),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new ar.Mesh(w,s),[0,0,.8],[Math.PI/2,0,0]],[new ar.Line(k,d),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new ar.Mesh(w,c),[.85,.85,0],null,[2,2,.2]],[new ar.Line(k,y),[.855,.98,0],null,[.125,1,1]],[new ar.Line(k,y),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new ar.Mesh(w,u),[0,.85,.85],null,[.2,2,2]],[new ar.Line(k,f),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new ar.Line(k,f),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new ar.Mesh(w,l),[.85,0,.85],null,[2,.2,2]],[new ar.Line(k,v),[.855,0,.98],null,[.125,1,1]],[new ar.Line(k,v),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new ar.Mesh(new ar.BoxBufferGeometry(.125,.125,.125),o),[1.1,0,0]]],XYZY:[[new ar.Mesh(new ar.BoxBufferGeometry(.125,.125,.125),o),[0,1.1,0]]],XYZZ:[[new ar.Mesh(new ar.BoxBufferGeometry(.125,.125,.125),o),[0,0,1.1]]]},D={X:[[new ar.Mesh(new ar.CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new ar.Mesh(new ar.CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[0,.5,0]]],Z:[[new ar.Mesh(new ar.CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new ar.Mesh(w,r),[.85,.85,0],null,[3,3,.2]]],YZ:[[new ar.Mesh(w,r),[0,.85,.85],null,[.2,3,3]]],XZ:[[new ar.Mesh(w,r),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new ar.Mesh(new ar.BoxBufferGeometry(.2,.2,.2),r),[1.1,0,0]]],XYZY:[[new ar.Mesh(new ar.BoxBufferGeometry(.2,.2,.2),r),[0,1.1,0]]],XYZZ:[[new ar.Mesh(new ar.BoxBufferGeometry(.2,.2,.2),r),[0,0,1.1]]]},L={X:[[new ar.Line(k,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ar.Line(k,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ar.Line(k,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},I=function(e){var t=new ar.Object3D;for(var r in e)for(var n=e[r].length;n--;){var i=e[r][n][0].clone(),a=e[r][n][1],s=e[r][n][2],o=e[r][n][3],c=e[r][n][4];i.name=r,i.tag=c,a&&i.position.set(a[0],a[1],a[2]),s&&i.rotation.set(s[0],s[1],s[2]),o&&i.scale.set(o[0],o[1],o[2]),i.updateMatrix();var u=i.geometry.clone();u.applyMatrix(i.matrix),i.geometry=u,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t},T=new ar.Vector3(0,0,0),R=new ar.Euler,B=new ar.Vector3(0,1,0),N=new ar.Vector3(0,0,0),F=new ar.Matrix4,G=new ar.Quaternion,U=new ar.Quaternion,z=new ar.Quaternion,H=new ar.Vector3(1,0,0),V=new ar.Vector3(0,1,0),W=new ar.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=I(x)),this.add(this.gizmo.rotate=I(j)),this.add(this.gizmo.scale=I(P)),this.add(this.picker.translate=I(C)),this.add(this.picker.rotate=I(A)),this.add(this.picker.scale=I(D)),this.add(this.helper.translate=I(M)),this.add(this.helper.rotate=I(E)),this.add(this.helper.scale=I(L)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var e=this.space;"scale"===this.mode&&(e="local");var t="local"===e?this.worldQuaternion:z;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var r=[];r=(r=(r=r.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var n=0;n<r.length;n++){var i=r[n];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);var a=this.worldPosition.distanceTo(this.cameraPosition);if(i.scale.set(1,1,1).multiplyScalar(a*this.size/7),"helper"!==i.tag){if(i.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){"X"!==i.name&&"XYZX"!==i.name||Math.abs(B.copy(H).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Y"!==i.name&&"XYZY"!==i.name||Math.abs(B.copy(V).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Z"!==i.name&&"XYZZ"!==i.name||Math.abs(B.copy(W).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XY"===i.name&&Math.abs(B.copy(W).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"YZ"===i.name&&Math.abs(B.copy(H).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XZ"===i.name&&Math.abs(B.copy(V).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),-1!==i.name.search("X")&&(B.copy(H).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.x*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Y")&&(B.copy(V).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.y*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Z")&&(B.copy(W).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.z*=-1:"bwd"===i.tag&&(i.visible=!1))}else"rotate"===this.mode&&(U.copy(t),B.copy(this.eye).applyQuaternion(G.copy(t).inverse()),-1!==i.name.search("E")&&i.quaternion.setFromRotationMatrix(F.lookAt(this.eye,N,V)),"X"===i.name&&(G.setFromAxisAngle(H,Math.atan2(-B.y,B.z)),G.multiplyQuaternions(U,G),i.quaternion.copy(G)),"Y"===i.name&&(G.setFromAxisAngle(V,Math.atan2(B.x,B.z)),G.multiplyQuaternions(U,G),i.quaternion.copy(G)),"Z"===i.name&&(G.setFromAxisAngle(W,Math.atan2(B.y,B.x)),G.multiplyQuaternions(U,G),i.quaternion.copy(G)));i.visible=i.visible&&(-1===i.name.indexOf("X")||this.showX),i.visible=i.visible&&(-1===i.name.indexOf("Y")||this.showY),i.visible=i.visible&&(-1===i.name.indexOf("Z")||this.showZ),i.visible=i.visible&&(-1===i.name.indexOf("E")||this.showX&&this.showY&&this.showZ),i.material._opacity=i.material._opacity||i.material.opacity,i.material._color=i.material._color||i.material.color.clone(),i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled?this.axis&&(i.name===this.axis?(i.material.opacity=1,i.material.color.lerp(new ar.Color(1,1,1),.5)):this.axis.split("").some(function(e){return i.name===e})?(i.material.opacity=1,i.material.color.lerp(new ar.Color(1,1,1),.5)):(i.material.opacity*=.25,i.material.color.lerp(new ar.Color(1,1,1),.5))):(i.material.opacity*=.5,i.material.color.lerp(new ar.Color(1,1,1),.5))}else i.visible=!1,"AXIS"===i.name?(i.position.copy(this.worldPositionStart),i.visible=!!this.axis,"X"===this.axis&&(G.setFromEuler(R.set(0,0,0)),i.quaternion.copy(t).multiply(G),Math.abs(B.copy(H).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"Y"===this.axis&&(G.setFromEuler(R.set(0,0,Math.PI/2)),i.quaternion.copy(t).multiply(G),Math.abs(B.copy(V).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"Z"===this.axis&&(G.setFromEuler(R.set(0,Math.PI/2,0)),i.quaternion.copy(t).multiply(G),Math.abs(B.copy(W).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"XYZE"===this.axis&&(G.setFromEuler(R.set(0,Math.PI/2,0)),B.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(F.lookAt(N,B,V)),i.quaternion.multiply(G),i.visible=this.dragging),"E"===this.axis&&(i.visible=!1)):"START"===i.name?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):"END"===i.name?(i.position.copy(this.worldPosition),i.visible=this.dragging):"DELTA"===i.name?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),T.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),T.applyQuaternion(this.worldQuaternionStart.clone().inverse()),i.scale.copy(T),i.visible=this.dragging):(i.quaternion.copy(t),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=-1!==this.axis.search(i.name)))}ar.Object3D.prototype.updateMatrixWorld.call(this)}};or.prototype=Object.assign(Object.create(ar.Object3D.prototype),{constructor:or,isTransformControlsGizmo:!0});var cr=function(){ar.Mesh.call(this,new ar.PlaneBufferGeometry(1e5,1e5,2,2),new ar.MeshBasicMaterial({visible:!1,wireframe:!0,side:ar.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var e=new ar.Vector3(1,0,0),t=new ar.Vector3(0,1,0),r=new ar.Vector3(0,0,1),n=new ar.Vector3,i=new ar.Vector3,a=new ar.Vector3,s=new ar.Matrix4,o=new ar.Quaternion;this.updateMatrixWorld=function(){var c=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(c="local"),e.set(1,0,0).applyQuaternion("local"===c?this.worldQuaternion:o),t.set(0,1,0).applyQuaternion("local"===c?this.worldQuaternion:o),r.set(0,0,1).applyQuaternion("local"===c?this.worldQuaternion:o),a.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":a.copy(this.eye).cross(e),i.copy(e).cross(a);break;case"Y":a.copy(this.eye).cross(t),i.copy(t).cross(a);break;case"Z":a.copy(this.eye).cross(r),i.copy(r).cross(a);break;case"XY":i.copy(r);break;case"YZ":i.copy(e);break;case"XZ":a.copy(r),i.copy(t);break;case"XYZ":case"E":i.set(0,0,0)}break;case"rotate":default:i.set(0,0,0)}0===i.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(n.set(0,0,0),i,a),this.quaternion.setFromRotationMatrix(s)),ar.Object3D.prototype.updateMatrixWorld.call(this)}};cr.prototype=Object.assign(Object.create(ar.Mesh.prototype),{constructor:cr,isTransformControlsPlane:!0});var ur=sr,lr=0,pr=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create scene w/ missing parent");return ie(e,ne(e,{type:"scene",title:"Scene "+lr++,defaultFloor:!0,parent:t.id,children:e.createArray()}))}},{key:"makeNode",value:function(e){var t=new Xe.Group;return t.name=e.title,this.setDefaultFloor(t,e.defaultFloor),t}},{key:"updateProperty",value:function(e,t,r,n){console.log("update property",e.name,r.name,r.value),r.name===Ct.defaultFloor.key&&(console.log("setting the floor too",r.value),this.setDefaultFloor(e,r.value))}},{key:"setDefaultFloor",value:function(e,t){if(!0===t){var r=new Xe.Mesh(new Xe.PlaneBufferGeometry(100,100,10,10),new Xe.MeshLambertMaterial({color:"blue"}));r.name="defaultFloor",r.rotation.x=-90*Math.PI/180,e.parts={},e.parts.floor=r,e.add(r)}else e.parts&&e.parts.floor&&(e.remove(e.parts.floor),delete e.parts.floor)}},{key:"getFloorPart",value:function(e){return e&&e.parts?e.parts.floor:null}}]),e}(),hr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).add=function(e){r.setState({notification:e,visible:!0}),setTimeout(r.hide,2e3)},r.hide=function(){return r.setState({visible:!1})},r.state={notification:"saved",visible:!1},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentWillMount",value:function(){R.onAdd(this.add)}},{key:"render",value:function(){return i.a.createElement("div",{style:{position:"absolute",bottom:"10px",left:"10px",backgroundColor:"rgba(0,0,0,0.6)",borderRadius:"1em",color:"white",fontSize:"24pt",padding:"1em",display:this.state.visible?"block":"none"}},this.state.notification)}}]),t}(n.Component),dr=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"getCurrentScene",value:function(){throw new Error("getCurrentScene not implemented")}},{key:"getSceneObjects",value:function(e){throw new Error("getSceneObjects not implemented")}},{key:"getBehaviorsForObject",value:function(e){throw new Error("getBehaviorsForObject(obj) not implemented")}},{key:"getThreeObject",value:function(e){throw new Error("getThreeObject(id) not implemented")}},{key:"getParsedBehaviorAsset",value:function(e){throw new Error("getParsedBehaviorAsset(behavior) not implemented")}},{key:"getAllBehaviors",value:function(){throw new Error("getAllBehaviors() not implemented")}},{key:"navigateScene",value:function(e){throw new Error("navigateScene(id) not implemented")}},{key:"playMediaAsset",value:function(e){throw new Error("playMediaAsset(id) not implemented")}},{key:"stopMediaAsset",value:function(e){throw new Error("stopMediaAsset(id) not implemented")}},{key:"getGraphObjectByName",value:function(e){throw new Error("getGraphObjectByName(name) not implemented")}},{key:"getGraphObjectById",value:function(e){throw new Error("getGraphObjectById(id) not implemented")}},{key:"getCamera",value:function(){throw new Error("getCamera() not implemented")}},{key:"getTweenManager",value:function(){throw new Error("getTweenManager() not implemented")}},{key:"startImageRecognizer",value:function(e){throw new Error("startImageRecognizer not implemented")}},{key:"startGeoRecognizer",value:function(e){throw new Error("startGeoRecognizer not implemented")}}]),e}(),fr=function(){function e(t,r){Object(o.a)(this,e),this.sgp=t,this.logger=r,this.running=!1,this.storage={},this.logger=r,this.logger.log("ScriptManager created")}return Object(c.a)(e,[{key:"makeSystemFacade",value:function(e){var t=this,r=this.sgp;return{getCurrentScene:function(){return r.getCurrentScene()},getScene:function(e){return null},getObject:function(e){var t=r.getGraphObjectByName(e);if(!t)throw new Error("object '".concat(e,"' not found"));return r.getThreeObject(t)},getAsset:function(e){var n=r.getGraphObjectByName(e);if(!n)throw new Error("asset '".concat(e,"' not found"));return new vr(t,n)},getObjectById:function(e){return r.getGraphObjectById(e)},navigateScene:function(e){t.fireSceneExit(this.getCurrentScene()),r.navigateScene(e),t.fireSceneEnter(this.getCurrentScene())},playSound:function(e){var n=r.getGraphObjectById(e);t.playAudioAsset(n)},getCamera:function(){return r.getCamera()},setKeyValue:function(e,r){t.storage[e]=r},getKeyValue:function(e,r){return t.storage[e]},hasKeyValue:function(e){return"undefined"!==typeof t.storage[e]},isAR:function(){return!1},sendMessage:function(r,n){var i=e.graphTarget;i&&t.fireMessageAtTarget(r,n,i)},getTweenManager:function(){return r.getTweenManager()},on:function(e,r,n){t.on(e,r,n)},fireEvent:function(e,r,n){t.fireEventFromTarget(e,r,n)},startImageRecognizer:function(e){return r.startImageRecognizer(e)},stopImageRecognizer:function(e){return r.stopImageRecognizer(e)},startGeoRecognizer:function(e){return r.startGeoRecognizer(e)},stopGeoRecognizer:function(e){return r.stopGeoRecognizer(e)}}}},{key:"performClickAction",value:function(e){if(this.running)try{if(!e||!e.exists||!e.exists())return;var t={type:"click",target:this.sgp.getThreeObject(e),graphTarget:e};t.system=this.makeSystemFacade(t);var r=this.sgp.getBehaviorsForObject(e);for(var n in r){var i=r[n];t.props=i.props();var a=this.sgp.getParsedBehaviorAsset(i);a.onClick&&a.onClick(t)}}catch(s){console.error("error in script",s.message),console.info(s),this.stopRunning()}}},{key:"fireSceneExit",value:function(e){var t=this;e||console.error("firing exit for a scene that is null");var r={type:"exit",target:e};r.system=this.makeSystemFacade(r),this.sgp.getBehaviorsForObject(e).forEach(function(e){var n=t.sgp.getParsedBehaviorAsset(e);n.onExit&&n.onExit(r)})}},{key:"fireSceneEnter",value:function(e){var t=this,r={type:"enter",target:e};r.system=this.makeSystemFacade(r),this.sgp.getBehaviorsForObject(e).forEach(function(e){var n=t.sgp.getParsedBehaviorAsset(e);n.onEnter&&n.onEnter(r)})}},{key:"tick",value:function(e,t,r){var n=this;if(this.running){0===this.startTime&&(this.startTime=e);try{var i=this.sgp.getCurrentScene();if(!i)return console.log("no current scene?!");var a={type:"tick",time:e-this.startTime};a.system=this.makeSystemFacade(a),a.system.session=t,a.system.frame=r,this.sgp.getBehaviorsForObject(i).forEach(function(e){a.target=n.sgp.getThreeObject(e.parent),a.graphTarget=e.parent;var t=n.sgp.getParsedBehaviorAsset(e);a.props=e.props(),t.onTick&&t.onTick(a)}),i.find(function(t){if(Lt(t.type)){n.sgp.getBehaviorsForObject(t).forEach(function(e){a.target=n.sgp.getThreeObject(e.parent),a.graphTarget=t;var r=n.sgp.getParsedBehaviorAsset(e);a.props=e.props(),r.onTick&&r.onTick(a)});var r=n.sgp.getThreeObject(t.id);r&&r.update&&r.update(e,a)}})}catch(s){console.error("error in script",s.message),console.info(s),this.stopRunning()}}}},{key:"startRunning",value:function(){var e=this;this.running=!0,this.startTime=0,this.storage={},this.logger.log("ScriptManager starting");try{this.sgp.getAllBehaviors().forEach(function(t){var r={type:"init"};r.system=e.makeSystemFacade(r),r.target=e.sgp.getThreeObject(t.parent),r.graphTarget=t.parent,r.props=t.props();var n=e.sgp.getParsedBehaviorAsset(t);n.init&&n.init(r)});var t=this.sgp.getCurrentScene();t&&this.sgp.getSceneObjects(t).forEach(function(t){var r={type:"init"};r.system=e.makeSystemFacade(r);var n=e.sgp.getThreeObject(t.id);e.logger.log("calling init on ",t.type,t.id),n.init&&n.init(r)})}catch(r){console.error("error in script",r.message),console.info(r),this.stopRunning()}}},{key:"stopRunning",value:function(){var e=this;try{this.running=!1,this.storage={},this.destroyListeners();var t=this.sgp.getCurrentScene();t&&this.sgp.getSceneObjects(t).forEach(function(t){var r={type:"stop"};r.system=e.makeSystemFacade(r);var n=e.sgp.getThreeObject(t.id);n.stop&&n.stop(r)})}catch(r){console.log("error stopping scripts",r.message),console.info(r)}console.log("script manager stopping")}},{key:"isRunning",value:function(){return this.running}},{key:"fireMessageAtTarget",value:function(e,t,r){var n=this,i={type:"message",name:e,message:t,time:Date.now(),target:this.sgp.getThreeObject(r),graphTarget:r};i.system=this.makeSystemFacade(i),this.sgp.getBehaviorsForObject(r).forEach(function(e){i.props=e.props();var t=n.sgp.getParsedBehaviorAsset(e);t.onMessage&&t.onMessage(i)})}},{key:"destroyListeners",value:function(){this.listeners={}}},{key:"on",value:function(e,t,r){this.listeners||(this.listeners={}),this.listeners[e.id]||(this.listeners[e.id]={}),this.listeners[e.id][t]||(this.listeners[e.id][t]=[]),this.listeners[e.id][t].push(r)}},{key:"fireEventFromTarget",value:function(e,t,r){this.listeners&&this.listeners[e.id]&&this.listeners[e.id][t]&&this.listeners[e.id][t].forEach(function(e){return e(r)})}}]),e}(),vr=function(){function e(t,r){Object(o.a)(this,e),this.manager=t,this.obj=r}return Object(c.a)(e,[{key:"play",value:function(){this.manager.sgp.playMediaAsset(this.obj)}},{key:"stop",value:function(){this.manager.sgp.stopMediaAsset(this.obj)}}]),e}(),yr=function(){function e(){Object(o.a)(this,e),this.running=!1}return Object(c.a)(e,[{key:"update",value:function(e){throw new Error("update not implemented")}},{key:"start",value:function(){this.running=!0}},{key:"isAlive",value:function(){return this.running}},{key:"kill",value:function(){this.running=!1}}]),e}(),gr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="wait",r.duration=e,r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){e/=1e3,this.startTime||(this.startTime=e),(e-this.startTime)/this.duration>=1&&(this.running=!1)}}]),t}(yr),mr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="action",r.fn=e,r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){var e=this.fn();return this.running=!1,e}}]),t}(yr),br=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="forever",r.fn=e,r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){this.running=!0,this.startTime=Date.now()/1e3}},{key:"update",value:function(e){var t=e/1e3-this.startTime;this.fn(t)}}]),t}(yr),wr={SINGLE:"single",COMPOUND:"compound"},kr={LINEAR:"linear",ELASTIC:"elastic"};function Or(e,t,r){return(t-e)*r+e}var Sr=function(e){function t(e){var r;if(Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="prop",r.target=e.target,r.duration=e.duration,"undefined"===typeof r.duration)throw new Error("duration is missing");if(r.property=e.property,"undefined"===typeof r.property)throw new Error("property is missing");return r.propertyType=e.propertyType||wr.SINGLE,r.from=e.from,r.to=e.to,r.lerp_type=e.lerpType||kr.LINEAR,r.loop=e.loop,"undefined"===typeof r.loop&&(r.loop=1),r.loopCount=0,r.reversed=!1,r.autoReverse=e.autoReverse,"undefined"===typeof r.autoReverse&&(r.autoReverse=!1),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){e/=1e3,this.startTime||(this.startTime=e);var t=(e-this.startTime)/this.duration;if(t>1&&(t=1),this.setPropertyValue(this.from,this.to,t),1===t){if(this.loopCount++,this.autoReverse&&(this.reversed=!this.reversed),-1!==this.loop&&this.loopCount>=this.loop)return void(this.running=!1);this.startTime=e}}},{key:"setPropertyValue",value:function(e,t,r,n,i){var a=this;this.propertyType===wr.SINGLE&&(this.target[this.property]=this.lerp(this.from,this.to,this.reversed?1-r:r)),this.propertyType===wr.COMPOUND&&Object.keys(this.from).forEach(function(e){a.target[a.property][e]=a.lerp(a.from[e],a.to[e],a.reversed?1-r:r)})}},{key:"lerp",value:function(e,t,r){return this.lerp_type===kr.LINEAR?Or(e,t,r):this.lerp_type===kr.ELASTIC?Or(e,t,function(e){return Math.pow(2,-10*e)*Math.sin((e-.075)*(2*Math.PI)/.3)+1}(r)):(console.log("invalid LERP_TYPE"),e)}}]),t}(yr),xr=function(e){function t(e){var r;if(Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="clip",r.target=e.target,r.name=e.name,r.loop=e.loop,r.autoReverse=e.autoReverse,"undefined"===typeof r.autoReverse&&(r.autoReverse=!1),"undefined"===typeof r.loop&&(r.loop=1),"undefined"===typeof r.name)throw new Error("name is missing");return r.speed=e.speed,"undefined"===typeof r.speed&&(r.speed=1),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){this.running=!0,this.mixer=new Xe.AnimationMixer(this.target.scene),this.action=this.mixer.clipAction(Xe.AnimationClip.findByName(this.target.animations,this.name)),1===this.loop&&this.action.setLoop(Xe.LoopOnce,1),-1===this.loop&&this.action.setLoop(this.autoReverse?Xe.LoopPingPong:Xe.LoopRepeat,1/0),this.loop>1&&this.action.setLoop(Xe.LoopRepeat,this.loop),this.action.play(),this.action.setEffectiveTimeScale(this.speed),this.startTime=Date.now()/1e3,this.prevTime=this.startTime}},{key:"update",value:function(e){var t=e/1e3-this.prevTime;this.mixer.update(t),this.prevTime=e/1e3}},{key:"kill",value:function(){this.action.stop(),this.running=!1}}]),t}(yr),Cr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).subs=[],e}return Object(p.a)(t,e),Object(c.a)(t,[{key:"and",value:function(e){return e instanceof yr?this.subs.push(e):this.subs.push(new mr(e)),this}},{key:"start",value:function(){return this.running=!0,this.subs.forEach(function(e){return e.start()}),this}},{key:"update",value:function(e){this.subs.forEach(function(t){t.isAlive()&&t.update(e)})}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(e){return!0===e.isAlive()})}}]),t}(yr),Mr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).subs=[],e.n=-1,e}return Object(p.a)(t,e),Object(c.a)(t,[{key:"then",value:function(e){return e instanceof yr?this.subs.push(e):this.subs.push(new mr(e)),this}},{key:"wait",value:function(e){return this.subs.push(new gr(e)),this}},{key:"start",value:function(){return this.running=!0,this._startNext(),this}},{key:"_startNext",value:function(){if(this.n=this.n+1,this.n>this.subs.length-1)return this.running=!1,this.n=-1,null;var e=this.subs[this.n],t=e.start();return e.isAlive()?e:t?(console.log("the next swapped itself",t),this.subs[this.n]=t,this.n=this.n-1,this._startNext()):this._startNext()}},{key:"update",value:function(e){var t=this.subs[this.n];t.update(e),t.isAlive()||this._startNext()}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(e){return!0===e.isAlive()})}}]),t}(yr),jr=function(){function e(){Object(o.a)(this,e),this.subs=[]}return Object(c.a)(e,[{key:"parallel",value:function(){var e=new Cr;return this.subs.push(e),e}},{key:"sequence",value:function(){var e=new Mr;return this.subs.push(e),e}},{key:"action",value:function(e){var t=new mr(e);return this.subs.push(t),t}},{key:"prop",value:function(e){var t=new Sr(e);return this.subs.push(t),t}},{key:"isAlive",value:function(){return this.subs.find(function(e){return!0===e.isAlive()})}},{key:"update",value:function(e){var t=Date.now();this.subs.forEach(function(e){e.isAlive()&&e.update(t)})}},{key:"forever",value:function(e){var t=new br(e);return this.subs.push(t),t}},{key:"clip",value:function(e){var t=new xr(e);return this.subs.push(t),t}},{key:"wait",value:function(e){var t=new gr(e);return this.subs.push(t),t}}]),e}(),Er=document.Cesium,Ar=document.XRGeospatialAnchor,Pr=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"getContext",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.device=0,this.session=0,this.xrCanvas=0,this.xrContext=0,this.canvas=t,this.context=0,this.xrCanvas=document.createElement("canvas"),this.xrContext=this.xrCanvas.getContext("xrpresent"),this._anchoredNodes=new Map,new Promise(function(t,r){navigator.xr.requestDevice().then(function(n){e.device=n,e.device.requestSession({outputContext:e.xrContext,alignEUS:!0,geolocation:!0,worldSensing:!0}).then(function(r){e.session=r,e.canvas||(e.canvas=document.createElement("canvas")),e.context||(e.context=e.canvas.getContext("webgl",{compatibleXRDevice:e.device})),e.session.baseLayer=new window.XRWebGLLayer(e.session,e.context),t(e.context)}).catch(function(e){console.error("Session setup error",e),r()})}).catch(function(e){console.error("Error",e),r()})})}},{key:"setAnimationLoop",value:function(e){var t=this;e?(this.session.requestFrameOfReference("head-model").then(function(e){t.headFrameOfReference=e}).catch(function(e){console.error("Error finding head frame of reference",e)}),this.session.requestFrameOfReference("eye-level").then(function(e){t.eyeLevelFrameOfReference=e}).catch(function(e){console.error("Error finding eye frame of reference",e)}),this.userAnimationCallback=e,this.__handleAnimationFrame=this._handleAnimationFrame.bind(this),this.session.requestAnimationFrame(this.__handleAnimationFrame)):console.error("Supply a callback")}},{key:"_handleAnimationFrame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.session&&!this.session.ended&&(this.session.requestAnimationFrame(this.__handleAnimationFrame),this.headFrameOfReference&&this.eyeLevelFrameOfReference)){var r=t.getDevicePose(this.eyeLevelFrameOfReference);if(r){var n=!0,i=!1,a=void 0;try{for(var s,o=t.views[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var c=s.value;this.userAnimationCallback(this.session.baseLayer.getViewport(c),c.projectionMatrix,r.getViewMatrix(c),e,t);break}}catch(u){i=!0,a=u}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}}else console.log("No pose")}}},{key:"addAnchoredNode",value:function(e,t,r){var n=this;return e&&e.uid?(this._anchoredNodes.set(e.uid,{anchor:e,node:t}),t.anchor=e,t.matrixAutoUpdate=!1,t.matrix.fromArray(e.modelMatrix),t.updateMatrixWorld(!0),e.addEventListener("update",function(e){return n._handleAnchorUpdate(e,r)}),e.addEventListener("removed",function(e){return n._handleAnchorDelete(e,r)}),r.log("done adding anchored node"),t):(console.error("not a valid anchor",e),void r.error("not a valid anchor ".concat(m(e))))}},{key:"addImageAnchoredNode",value:function(e,t,r){var n=this;if(r.log("addImageAnchoredNode"),e.image&&e.node)if(this.session){var i,a=e.callback,s=e.imageRealworldWidth||1,o=(e.object,e.node),c=Object(je.a)(Array(10)).map(function(e){return(~~(36*Math.random())).toString(36)}).join(""),u=document.createElement("canvas"),l=u.getContext("2d");u.width=t.width,u.height=t.height,r.log("looking for image ".concat(m(t)," ").concat(t.src)),l.drawImage(t,0,0);try{i=l.getImageData(0,0,t.width,t.height)}catch(p){throw r.log("error drawing image ".concat(m(p))),r.log("name ".concat(p.name)),r.log("name ".concat(p.message)),r.log("local url is "+document.documentURI),r.log("image url from "+t.src),R.add("error drawing image",p.toString()),new Error("foo")}r.log("calling createDetectionImage with image width and height ".concat(t.width," ").concat(t.height)),this.session.nonStandard_createDetectionImage(c,i.data,t.width,t.height,s).then(function(){r.log("created a createdetectionimage"),n.session.nonStandard_activateDetectionImage(c).then(function(t){r.log("started activate detection image"),o.anchorName=c,n.addAnchoredNode(t,o,r),a&&a(e)}).catch(function(e){r.error("error activating detection image: ".concat(e))})}).catch(function(e){r.error("error creating detection image: ".concat(e))})}else r.log("no session");else r.log("missing image or threejs node")}},{key:"addGeoAnchoredNode",value:function(e){var t=this;if(console.log("adding a geo recognizer"),e.node)if(this.session){e.callback,e.object;var r=e.node;if(e.latitude||e.longitude)if(e.useAltitude||e.altitude){var n=new Er.Cartographic(e.longitude*Math.PI/180,e.latitude*Math.PI/180,e.altitude);console.log("XRGeoAnchor: Placing an object at specified lla and specified altitude"),console.log(n),Ar.createGeoAnchor(n).then(function(e){t.addAnchoredNode(e,r)})}else Ar.getDeviceElevation().then(function(n){var i=new Er.Cartographic(e.longitude*Math.PI/180,e.latitude*Math.PI/180,n);console.log("XRGeoAnchor: Placing an object at specified lla and your altitude"),console.log(i),Ar.createGeoAnchor(i).then(function(e){t.addAnchoredNode(e,r)})});else Ar.getDeviceCartographic().then(function(e){Ar.getDeviceElevation().then(function(n){var i=new Er.Cartographic(e.longitude,e.latitude,n);console.log("XRGeoAnchor: Placing an object at your lla"),console.log(i),Ar.createGeoAnchor(i).then(function(e){t.addAnchoredNode(e,r)})})})}else console.error("no session");else console.error("Missing threejs node")}},{key:"_handleAnchorDelete",value:function(e,t){t.log("delete anchor");var r=e.source,n=this._anchoredNodes.get(r.uid);if(n){n.node;this._anchoredNodes.delete(r.uid)}}},{key:"_handleAnchorUpdate",value:function(e,t){t.log("anchor update");var r=e.source,n=this._anchoredNodes.get(r.uid);if(n){var i=n.node;i.matrixAutoUpdate=!1,i.matrix.fromArray(r.modelMatrix),i.updateMatrixWorld(!0)}}}],[{key:"supportsARKit",value:function(){return navigator.xr&&navigator.xr._mozillaXRViewer?(console.log("*** Found mozilla xr viewer"),!0):(console.log("*** Did not find WebXR"),!1)}}]),e}(),Dr=r(19),Lr=Dr.SET_PROPERTY,Ir=Dr.INSERT_ELEMENT,Tr=Dr.DELETE_ELEMENT,Rr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).canvas=e,r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"getAllBehaviors",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(e){return e.type===Et.BEHAVIOR})}},{key:"getParsedBehaviorAsset",value:function(e){var t=this.canvas.props.provider,r=t.accessObject(e.behavior);return t.getCachedBehaviorAsset(r.id)}},{key:"getGraphObjectById",value:function(e){return this.canvas.props.provider.accessObject(e)}},{key:"getGraphObjectByName",value:function(e){var t=this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(t){return t.title===e});return!t||t.length<1?null:t[0]}},{key:"navigateScene",value:function(e){D.setSelection(e)}},{key:"getCurrentScene",value:function(){return this.canvas.props.provider.getSelectedSceneObject()}},{key:"getSceneObjects",value:function(e){return e.getChildren().filter(function(e){return Pt(e.type)})}},{key:"getThreeObject",value:function(e){return e.id?this.canvas.findNode(e.id):this.canvas.findNode(e)}},{key:"getBehaviorsForObject",value:function(e){return e.getChildren().filter(function(e){return e.type===Et.BEHAVIOR})}},{key:"getCamera",value:function(){return this.canvas.camera}},{key:"playMediaAsset",value:function(e){if(e.subtype===Bt.AUDIO){var t=new Xe.Audio(this.canvas.audioListener);(new Xe.AudioLoader).load(e.src,function(e){t.setBuffer(e),t.setLoop(!1),t.setVolume(.5),t.play()}),this.canvas.playing_audio[e.id]=t}if(e.subtype===Bt.VIDEO){var r=this.canvas.props.provider.videocache;r[e.src]&&r[e.src].play()}}},{key:"stopAudioAsset",value:function(e){this.canvas.playing_audio[e.id]&&(this.canvas.playing_audio[e.id].stop(),delete this.canvas.playing_audio[e.id])}},{key:"getTweenManager",value:function(){return this.canvas.tweenManager}},{key:"startImageRecognizer",value:function(e){return this.canvas.startImageRecognizer(e)}},{key:"stopImageRecognizer",value:function(e){return this.canvas.stopImageRecognizer(e)}},{key:"startGeoRecognizer",value:function(e){return this.canvas.startGeoRecognizer(e)}},{key:"stopGeoRecognizer",value:function(e){return this.canvas.stopGeoRecognizer(e)}}]),t}(dr),Br=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).moveCameraForward=function(){r.camera.position.z+=-.5},r.moveCameraBackward=function(){r.camera.position.z+=.5},r.handleKeyPress=function(e){"ArrowUp"===e.key&&(r.camera.position.z-=.5),"ArrowDown"===e.key&&(r.camera.position.z+=.5),"a"===e.key&&(r.camera.position.x-=.5),"d"===e.key&&(r.camera.position.x+=.5),"ArrowLeft"===e.key&&(r.camera.rotation.y+=.1),"ArrowRight"===e.key&&(r.camera.rotation.y-=.1)},r.pauseQueue=function(e){r.props.provider.pauseQueue()},r.unpauseQueue=function(e){r.props.provider.unpauseQueue()},r.transformChanged=function(e){var t=D.getSelection();if(t){var n=r.props.provider.accessObject(t);if(!Pt(n.type))return;if(n.type===jt.bg360)return;var i=r.findNode(t);if(!i)return;var a=r.props.provider;a.quick_setPropertyValue(t,"tx",i.position.x),a.quick_setPropertyValue(t,"ty",i.position.y),a.quick_setPropertyValue(t,"tz",i.position.z)}},r.docSwapped=function(e){r.scenes.forEach(function(e){return r.scene.remove(e)}),r.scenes=[],r.obj_node_map={},r.setState({scene:-1});var t=r.props.provider.getDocGraph();r.rebuildNode(t,"")},r.selectionChanged=function(){r.controls.detach();var e=D.getSelection();if(e){var t=r.props.provider.accessObject(e);if(t.type===Et.SCENE)return r.setCurrentSceneWrapper(r.findNode(e));if(Pt(t.type)){var n=r.props.provider.findSceneObjectParent(t);r.setCurrentSceneWrapper(r.findNode(n.id));var i=r.findNode(e);if(!i)return;r.controls.attach(i)}else console.log("selected something not an object or scene")}},r.windowResized=function(){r.canvas&&(r.camera.aspect=r.canvas.width/r.canvas.height,r.camera.updateProjectionMatrix(),r.renderer.setSize(r.canvas.width,r.canvas.height))},r.clickedCanvas=function(e){r.canvas.focus();var t=r.canvas.getBoundingClientRect(),n={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1};r.raycaster.setFromCamera(n,r.camera);var i=r.raycaster.intersectObjects(r.getCurrentSceneWrapper().children,!0);if(i&&i.length>=1){var a=i[0].object;r.state.running?r.scriptManager.performClickAction(r.props.provider.accessObject(a.userData.graphid)):D.setSelection(a.userData.graphid)}else D.clearSelection()},r.obj_node_map={},r.previewUpdateNodes=[],r.scenes=[],r.state={scene:-1,running:e.running},r.playing_audio=[],r.scriptManager=new fr(new Rr(Object(f.a)(Object(f.a)(r))),r.props.provider.pubnub.getLogger()),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"rebuildNode",value:function(e,t){var r=this;if(e.type===Et.SCENE){var n=(new pr).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,n),this.addSceneWrapper(n),this.setCurrentSceneWrapper(n)}if(Pt(e.type)){var i=Tt(e.type).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,i),this.findNode(e.parent).add(i)}e.children&&e.children.forEach(function(e){r.rebuildNode(e,t+"   ")})}},{key:"componentDidMount",value:function(){var e=this,t=this.canvas;this.props.provider.pubnub.getLogger().log("mounting VRCanvas"),Pr.supportsARKit()?(this.xr=new Pr,this.xr.getContext(t).then(function(r){e.setupRenderer(t,r),e.xr.setAnimationLoop(e.animationLoopWithCamera.bind(e))}).catch(function(e){console.error("Error",e)})):(this.setupRenderer(t,0),this.renderer.setAnimationLoop(this.animationLoop.bind(this)))}},{key:"componentWillUnmount",value:function(){this.controls.removeEventListener("change",this.transformChanged),this.controls.removeEventListener("mouseDown",this.pauseQueue),this.controls.removeEventListener("mouseUp",this.unpauseQueue),this.props.provider.off(F.DOCUMENT_SWAPPED,this.docSwapped),D.off(A,this.selectionChanged),window.removeEventListener("resize",this.windowResized)}},{key:"setupRenderer",value:function(e,t){var r=this;this.scene=new Xe.Scene,this.camera=new Xe.PerspectiveCamera(70,e.width/e.height,.1,50),this.renderer=new Xe.WebGLRenderer({antialias:!1,canvas:e,context:t}),this.renderer.setSize(e.width,e.height),this.renderer.gammaOutput=!0,this.audioListener=new Xe.AudioListener,this.camera.add(this.audioListener),this.xr||(this.scene.background=new Xe.Color(0)),this.camera.matrixAutoUpdate=!1,this.scene.add(this.camera),this.controls=new ur(this.camera,this.renderer.domElement),this.controls.addEventListener("change",this.transformChanged),this.controls.addEventListener("mouseDown",this.pauseQueue),this.controls.addEventListener("mouseUp",this.unpauseQueue),this.scene.add(this.controls),this.raycaster=new Xe.Raycaster;var n=new Xe.DirectionalLight(16777215,1);n.position.set(1,1,1).normalize(),this.scene.add(n),this.scene.add(new Xe.AmbientLight(16777215,.4)),this.tweenManager=new jr,this.props.provider.onRawChange(function(e){return r.updateScene(e)}),this.props.provider.on(F.DOCUMENT_SWAPPED,this.docSwapped),D.on(A,this.selectionChanged),window.addEventListener("resize",this.windowResized,!1),this.docSwapped()}},{key:"animationLoop",value:function(e,t){var r=null;this.xr&&(r=this.xr.session),this.state.running&&this.scriptManager.tick(e,r,t),this.tweenManager&&this.tweenManager.update(e),this.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),this.renderer.render(this.scene,this.camera)}},{key:"animationLoopWithCamera",value:function(e,t,r,n,i){this.scene&&this.camera&&(this.camera.matrix.fromArray(r),this.camera.matrixWorldNeedsUpdate=!0,this.camera.updateMatrixWorld(),this.camera.projectionMatrix.fromArray(t),this.animationLoop(n,i))}},{key:"insertNodeMapping",value:function(e,t){if("string"!==typeof e)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[e]=t,t.userData.graphid=e,t.previewUpdate&&this.previewUpdateNodes.push(t)}},{key:"removeNodeMapping",value:function(e,t){delete this.obj_node_map[e],delete t.userData.graphid,this.previewUpdateNodes=this.previewUpdateNodes.filter(function(e){return e!==t})}},{key:"findNode",value:function(e){return this.obj_node_map[e]||console.warn("could not find node for id",e),this.obj_node_map[e]}},{key:"updateScene",value:function(e){var t=this.props.provider;if(e.type!==Ir)if(e.type!==Lr)if(e.type!==Tr)   ;else{this.controls.detach();var r=this.findNode(e.value);r&&(this.removeNodeMapping(e.value,r),Pt(t.accessObject(e.value).type)&&r.parent.remove(r))}else{if("parent"===e.name)return;var n=this.findNode(e.object);if(n){var i=t.accessObject(e.object);if("scene"===i.type)return void(new pr).updateProperty(n,i,e,this.props.provider);if(Pt(i.type))return Tt(i.type).updateProperty(n,i,e,this.props.provider)}else console.log("could not find the node for object id:",e)}else{var a=e.value,s=t.accessObject(e.value);if(s.type===Et.SCENE)return this.populateNode(a);if(Pt(s.type))return this.populateNode(a);if(s.type===Et.ASSET)return;if(s.type===Et.ASSETS_LIST)return;if(s.type===Et.BEHAVIORS_LIST)return;console.warn("unknown object type",s)}}},{key:"shouldComponentUpdate",value:function(e,t,r){return"running"in e&&e.running!==this.props.running&&(this.setState({running:e.running}),!1===e.running?(this.scriptManager.stopRunning(),this.resetSceneGraph(),this.stopImageRecognizer(),this.stopGeoRecognizer()):(this.startRecognizer(),this.scriptManager.startRunning()),!1)}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("canvas",{ref:function(t){return e.canvas=t},width:600,height:400,onClick:this.clickedCanvas,className:"editable-canvas",onKeyDown:this.handleKeyPress,tabIndex:0}),i.a.createElement("br",null),i.a.createElement("button",{onClick:this.moveCameraForward},"forward"),i.a.createElement("button",{onClick:this.moveCameraBackward},"backward"),i.a.createElement(hr,null))}},{key:"populateNode",value:function(e){var t=this.props.provider.accessObject(e);if(Pt(t.type)){var r=Tt(t.type).makeNode(t,this.props.provider);return this.insertNodeMapping(e,r),this.findNode(t.parent).add(r),r}if(t.type===Et.SCENE){var n=(new pr).makeNode(t,this.props.provider);return this.insertNodeMapping(e,n),this.addSceneWrapper(n),this.setCurrentSceneWrapper(n),n}console.warn("cannot populate node for type",t.type)}},{key:"addSceneWrapper",value:function(e){this.scenes.push(e),this.scene.add(e)}},{key:"setCurrentSceneWrapper",value:function(e){this.scenes.forEach(function(t){t.visible=t===e})}},{key:"dumpScenes",value:function(){var e=this;this.scenes.forEach(function(t){console.log("scene"),e.dump(t,"")})}},{key:"dump",value:function(e,t){var r=this;console.log(t+"",e.type,e.id,"vis",e.visible),"Mesh"===e.type&&console.log(t+"  ",e.geometry.type),e.children&&e.children.forEach(function(e){return r.dump(e,t+"  ")})}},{key:"getCurrentSceneWrapper",value:function(){return this.scenes.find(function(e){return e.visible})}},{key:"resetSceneGraph",value:function(){var e=this;Object.keys(this.obj_node_map).forEach(function(t){var r=e.props.provider.accessObject(t),n=e.obj_node_map[t];if("scene"!==r.type&&Pt(r.type)){var i=Tt(r.type);i.reset&&i.reset(n,r,e.props.provider.getDataGraph())}})}},{key:"startRecognizer",value:function(){}},{key:"startImageRecognizer",value:function(e){var t=this,r=this.props.provider.pubnub.getLogger();return new Promise(function(t,n){var i=new Image;i.crossOrigin="Anonymous",i.src=e.image.src,r.log("Loading image",i.src),i.onload=function(){t(i)}}).then(function(n){r.log("got the image",m(n)),t.xr&&t.xr.session?t.xr.addImageAnchoredNode(e,n,r):r.log("XR is not active?")})}},{key:"stopImageRecognizer",value:function(){console.log("WE NEED TO STOP ALL image recognizers here")}},{key:"startGeoRecognizer",value:function(e){var t=this.provider.pubnub.getLogger();this.xr&&this.xr.session?this.xr.addGeoAnchoredNode(e):t.log("XR is not active?")}},{key:"stopGeoRecognizer",value:function(){console.log("WE NEED TO STOP ALL geo recognizers here")}}]),t}(n.Component),Nr=(r(60),function(e,t,r){return e.addEventListener(t,r)}),Fr=function(e,t,r){return e.removeEventListener(t,r)},Gr=function(e){return e*Math.PI/180},Ur=function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).startHover=function(){return n.arrow.material.color.set(16777215)},n.endHover=function(){return n.arrow.material.color.set(16776960)},n.beginDrag=function(e){n.startPoint=n.parent.position.clone(),n.startPoint.copy(e.intersection.point),n.parent.target.parent.worldToLocal(n.startPoint),n.oldFilter=n.parent.pointer.intersectionFilter,n.parent.pointer.intersectionFilter=function(e){return e.userData.draggable},n.startPosition=n.parent.target.position.clone(),n.plane.visible=!0,Nr(n.plane,zt.d,n.updateDrag),Nr(n.plane,zt.f,n.endDrag)},n.updateDrag=function(e){n.endPoint=e.intersection.point.clone(),n.parent.target.parent.worldToLocal(n.endPoint),"X"===n.axis&&(n.endPoint.y=n.startPoint.y,n.endPoint.z=n.startPoint.z),"Y"===n.axis&&(n.endPoint.x=n.startPoint.x,n.endPoint.z=n.startPoint.z),"Z"===n.axis&&(n.endPoint.x=n.startPoint.x,n.endPoint.y=n.startPoint.y);var t=n.endPoint.clone().sub(n.startPoint),r=n.startPosition.clone().add(t);n.parent.target.position.copy(r),n.parent.position.copy(r)},n.endDrag=function(e){Fr(n.plane,zt.d,n.updateDrag),Fr(n.plane,zt.f,n.endDrag),n.parent.pointer.intersectionFilter=n.oldFilter,n.plane.visible=!1,n.parent.dispatchEvent({type:"change",start:n.startPosition.clone(),end:n.parent.position.clone()})},n.axis=e,n.control=r,n.makePlane(),n.makeArrow(),n.makeInputGrabber(),n}return Object(p.a)(t,e),Object(c.a)(t,[{key:"makePlane",value:function(){this.plane=new Xe.Mesh(new Xe.PlaneBufferGeometry(100,100,100,100),new Xe.MeshBasicMaterial({visible:!0,wireframe:!0,side:Xe.DoubleSide})),"Z"===this.axis&&(this.plane.rotation.y=Gr(90)),this.plane.userData.draggable=!0,this.plane.visible=!1,this.add(this.plane)}},{key:"makeArrow",value:function(){this.arrow=new Xe.Mesh(new Xe.CylinderBufferGeometry(.02,.02,4),new Xe.MeshLambertMaterial({color:"yellow"})),"X"===this.axis&&(this.arrow.rotation.z=Gr(90)),"Y"===this.axis&&(this.arrow.rotation.z=Gr(180)),"Z"===this.axis&&(this.arrow.rotation.x=Gr(90)),this.add(this.arrow)}},{key:"makeInputGrabber",value:function(){this.input=new Xe.Mesh(new Xe.CylinderBufferGeometry(.1,.1,4),new Xe.MeshLambertMaterial({color:"green",visible:!1})),"X"===this.axis&&(this.input.rotation.z=Gr(90)),"Y"===this.axis&&(this.input.rotation.z=Gr(180)),"Z"===this.axis&&(this.input.rotation.x=Gr(90)),this.input.userData.clickable=!0,this.add(this.input)}},{key:"attach",value:function(){Nr(this.input,zt.b,this.startHover),Nr(this.input,zt.c,this.endHover),Nr(this.input,zt.e,this.beginDrag)}},{key:"detach",value:function(){Fr(this.input,zt.b,this.startHover),Fr(this.input,zt.c,this.endHover),Fr(this.input,zt.e,this.beginDrag)}}]),t}(Xe.Group),zr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).handles=[],e.handles.push(new Ur("X",Object(f.a)(Object(f.a)(e)))),e.handles.push(new Ur("Y",Object(f.a)(Object(f.a)(e)))),e.handles.push(new Ur("Z",Object(f.a)(Object(f.a)(e)))),e.handles.forEach(function(t){return e.add(t)}),e.visible=!1,e}return Object(p.a)(t,e),Object(c.a)(t,[{key:"attach",value:function(e,t){this.target=e,this.pointer=t,this.position.copy(e.position),this.visible=!0,this.handles.forEach(function(e){return e.attach()})}},{key:"detach",value:function(){this.target=null,this.pointer=null,this.visible=!1,this.handles.forEach(function(e){return e.attach()})}}]),t}(Xe.Group),Hr=function(e,t,r){return e.addEventListener(t,r)},Vr=function(e){function t(e,r){var n;if(Object(o.a)(this,t),n=Object(u.a)(this,Object(l.a)(t).call(this)),!e)throw new Error("cannot pass empty scene to Panel2D()");if(!r)throw new Error("cannot pass empty camera to Panel2D()");n.type="panel2d",n.listeners={},n.scene=e,n.camera=r,n.canvas=document.createElement("canvas"),n.canvas.width=256,n.canvas.height=512,n.canvasTexture=new Xe.CanvasTexture(n.canvas),n.redrawHandler=function(e){return n.redraw()};var i=n.canvas.getContext("2d");i.fillStyle="red",i.fillRect(0,0,n.canvas.width,n.canvas.height),n.mesh=new Xe.Mesh(new Xe.PlaneGeometry(1,2),new Xe.MeshBasicMaterial({color:"white",map:n.canvasTexture})),n.mesh.userData.clickable=!0,n.comps=[],n.add(n.mesh);var a=null;return Hr(n.mesh,zt.d,function(e){var t=e.intersection.uv,r=new Xe.Vector2(256*t.x,512-512*t.y);a&&!a.contains(r)&&(a.fire(zt.c),a=null);var i=n.findAt(r);a!==i&&(a&&a.fire(zt.c),a=null),i&&i.fire(zt.b),a=i}),Hr(n.mesh,zt.a,function(e){var t=e.intersection.uv,r=new Xe.Vector2(256*t.x,512-512*t.y),i=n.findAt(r);i&&i.fire(zt.a)}),n.header=new Xe.Mesh(new Xe.BoxGeometry(1,.1,.1),new Xe.MeshBasicMaterial({color:"goldenrod"})),n.header.userData.clickable=!0,n.header.position.set(0,1.1,0),n.add(n.header),Hr(n.header,zt.b,function(e){return n.header.material.color.set("yellow")}),Hr(n.header,zt.c,function(e){return n.header.material.color.set("goldenrod")}),Hr(n.header,zt.e,function(e){return n.startDrag()}),n}return Object(p.a)(t,e),Object(c.a)(t,[{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"findAt",value:function(e){for(var t=0;t<this.comps.length;t++){var r=this.comps[t],n=r.findAt({x:e.x-r.x,y:e.y-r.y});if(n)return n}return null}},{key:"add",value:function(e){e instanceof Xe.Object3D?Object(d.a)(Object(l.a)(t.prototype),"add",this).call(this,e):(this.comps.push(e),Hr(e,"changed",this.redrawHandler))}},{key:"redraw",value:function(){var e=this.canvas.getContext("2d");e.fillStyle="white",e.fillRect(0,0,this.canvas.width,this.canvas.height),this.comps.forEach(function(t){return t.draw(e)}),this.canvasTexture.needsUpdate=!0}},{key:"startDrag",value:function(){var e=this;this.header.userData.clickable=!1,this.mesh.userData.clickable=!1,this.dragSphere=new Xe.Mesh(new Xe.SphereGeometry(4,32,32),new Xe.MeshLambertMaterial({color:"green",wireframe:!0,side:Xe.BackSide})),this.dragSphere.userData.clickable=!0,this.scene.add(this.dragSphere),Hr(this.dragSphere,zt.d,function(t){return e.moveDrag(t)}),Hr(this.dragSphere,zt.f,function(t){return e.endDrag(t)})}},{key:"endDrag",value:function(){this.scene.remove(this.dragSphere),this.dragSphere.userData.clickable=!1,this.header.userData.clickable=!0,this.mesh.userData.clickable=!0}},{key:"moveDrag",value:function(e){this.position.copy(e.point),this.position.add(new Xe.Vector3(0,-1,0)),this.lookAt(this.camera.position)}}]),t}(Xe.Object3D),Wr=function(){function e(){Object(o.a)(this,e),this.listeners={}}return Object(c.a)(e,[{key:"set",value:function(e,t){return this[e]=t,this.fire("changed",{type:"changed",target:this}),this}},{key:"get",value:function(e){return this[e]}},{key:"addEventListener",value:function(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),this}},{key:"on",value:function(e,t){return this.addEventListener(e,t),this}},{key:"setAll",value:function(e){var t=this;return Object.keys(e).forEach(function(r){return t.set(r,e[r])}),this}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}}]),e}(),Kr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).type="button",e.text="foo",e.x=0,e.y=0,e.fsize=20,e.w=e.text.length*e.fsize,e.h=20,e.normalBg="white",e.hoverBg="red",e.bg=e.normalBg,e.on(zt.b,function(){e.bg=e.hoverBg,e.fire("changed",{type:"changed",target:Object(f.a)(Object(f.a)(e))})}),e.on(zt.c,function(){e.bg=e.normalBg,e.fire("changed",{type:"changed",target:Object(f.a)(Object(f.a)(e))})}),e}return Object(p.a)(t,e),Object(c.a)(t,[{key:"draw",value:function(e){e.font="".concat(this.fsize,"px sans-serif");var t=e.measureText(this.text);this.w=5+t.width+5,this.h=0+this.fsize+4,e.fillStyle=this.bg,e.fillRect(this.x,this.y,this.w,this.h),e.fillStyle="black",e.fillText(this.text,this.x+3,this.y+this.fsize-2),e.strokeStyle="black",e.strokeRect(this.x,this.y,this.w,this.h)}},{key:"contains",value:function(e){return!(e.x<this.x)&&(!(e.x>this.x+this.w)&&(!(e.y<this.y)&&!(e.y>this.y+this.h)))}},{key:"findAt",value:function(e){return e.x<0?null:e.x>0+this.w?null:e.y<0?null:e.y>0+this.h?null:this}},{key:"set",value:function(e,r){Object(d.a)(Object(l.a)(t.prototype),"set",this).call(this,e,r),"normalBg"===e&&(this.bg=this.normalBg)}}]),t}(Wr),Yr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).type="group",e.x=0,e.y=0,e.w=100,e.h=100,e.bg="gray",e.visible=!0,e.comps=[],e.padding=5,e.border=1,e.layout=function(e){console.log("not laying out anything")},e}return Object(p.a)(t,e),Object(c.a)(t,[{key:"draw",value:function(e){this.visible&&(this.layout(this),e.fillStyle=this.bg,e.fillRect(this.x,this.y,this.w,this.h),this.border>0&&(e.strokeStyle="black",e.strokeRect(this.x,this.y,this.w,this.h)),e.save(),e.translate(this.x+this.padding,this.y+this.padding),this.comps.forEach(function(t){return t.draw(e)}),e.restore())}},{key:"contains",value:function(e){return!(e.x<this.x)&&(!(e.x>this.x+this.w)&&(!(e.y<this.y)&&!(e.y>this.y+this.h)))}},{key:"findAt",value:function(e){if(!this.visible)return null;for(var t=0;t<this.comps.length;t++){var r=this.comps[t],n=r.findAt({x:e.x-r.x-5,y:e.y-r.y-5});if(n)return n}return null}},{key:"childSet",value:function(e,t){return this.childProps[e]=t,this.comps.forEach(function(r){return r.set(e,t)}),this}},{key:"add",value:function(e){return this.comps.push(e),this.fire("changed",{type:"changed",target:this}),this}}]),t}(Wr),Zr=function(e){return Math.PI/180*e},Qr=new Xe.Vector3(0,1,0),Jr=function(){function e(t,r){var n=this;Object(o.a)(this,e),this.stagePos=t,this.stageRot=r,this.states={touchpad:!1},this.listeners={},this.keystates={ArrowLeft:{current:!1,previous:!1},ArrowRight:{current:!1,previous:!1},ArrowUp:{current:!1,previous:!1},ArrowDown:{current:!1,previous:!1}},this.dir=new Xe.Vector3(0,0,1),document.addEventListener("keydown",function(e){n.keystates[e.key]&&(n.keystates[e.key].current=!0)}),document.addEventListener("keyup",function(e){n.keystates[e.key]&&(n.keystates[e.key].current=!1)})}return Object(c.a)(e,[{key:"addEventListener",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"_fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"updateKeys",value:function(){var e=this;!1===this.keystates.ArrowLeft.current&&!0===this.keystates.ArrowLeft.previous&&this.rotateLeft(),!1===this.keystates.ArrowRight.current&&!0===this.keystates.ArrowRight.previous&&this.rotateRight(),!1===this.keystates.ArrowUp.current&&!0===this.keystates.ArrowUp.previous&&this.moveForward(),!1===this.keystates.ArrowDown.current&&!0===this.keystates.ArrowDown.previous&&this.moveBackward(),Object.keys(this.keystates).forEach(function(t){e.keystates[t].previous=e.keystates[t].current})}},{key:"rotateLeft",value:function(){this.dir.applyAxisAngle(Qr,Zr(30)),this.stageRot.rotation.y-=Zr(30)}},{key:"rotateRight",value:function(){this.dir.applyAxisAngle(Qr,-Zr(30)),this.stageRot.rotation.y+=Zr(30)}},{key:"moveForward",value:function(){this.stagePos.position.add(this.dir),this._fire("move",this.stagePos.position)}},{key:"moveBackward",value:function(){this.stagePos.position.sub(this.dir),this._fire("move",this.stagePos.position)}},{key:"update",value:function(){this.scanGamepads(),this.updateKeys()}},{key:"scanGamepads",value:function(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++){var r=e[t];if(r&&("Daydream Controller"===r.id||"Gear VR Controller"===r.id||"Oculus Go Controller"===r.id||"OpenVR Gamepad"===r.id||r.id.startsWith("Oculus Touch")||r.id.startsWith("Spatial Controller"))){if(r.buttons.length<2)return;var n=r.buttons[0];if(n.pressed&&r.axes&&2===r.axes.length){var i=r.axes[0]<-.5,a=r.axes[0]>.5,s=r.axes[1]<-.5,o=r.axes[1]>.5;s&&!1===this.states.touchpad&&!0===n.pressed&&this.moveForward(),o&&!1===this.states.touchpad&&!0===n.pressed&&this.moveBackward(),i&&!1===this.states.touchpad&&!0===n.pressed&&this.rotateLeft(),a&&!1===this.states.touchpad&&!0===n.pressed&&this.rotateRight()}r.buttons[1].pressed&&console.log("trigger"),!1===this.states.touchpad&&!0===n.pressed&&console.log("pressed"),!0===this.states.touchpad&&!1===n.pressed&&console.log("released"),this.states.touchpad=n.pressed}}}}]),e}();function qr(e){var t=e.accessObject(e.getSceneRoot()),r=(new pr).make(e.getDataGraph(),t);t.insertFirstChild(r),D.setSelection(r.id)}function $r(e){D.isEmpty()||(e.accessObject(D.getSelection()).removeFromParent(),D.clearSelection())}var Xr=r(19),_r=Xr.SET_PROPERTY,en=Xr.CREATE_OBJECT,tn=Xr.INSERT_ELEMENT,rn=Xr.DELETE_ELEMENT,nn=function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).editor=e,n.provider=r,n}return Object(p.a)(t,e),Object(c.a)(t,[{key:"getCurrentScene",value:function(){return this.provider.accessObject(this.editor.currentScene)}},{key:"getSceneObjects",value:function(e){return e.getChildren().filter(function(e){return Pt(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.getChildren().filter(function(e){return e.type===Et.BEHAVIOR})}},{key:"getThreeObject",value:function(e){return this.editor.findNode(e)}},{key:"getParsedBehaviorAsset",value:function(e){var t=this.provider.accessObject(e.behavior);return this.provider.getCachedBehaviorAsset(t.id)}},{key:"getAllBehaviors",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(e){return e.type===Et.BEHAVIOR})}},{key:"getGraphObjectByName",value:function(e){var t=this.provider.accessObject(this.provider.getSceneRoot()).find(function(t){return t.title===e});return!t||t.length<1?null:t[0]}},{key:"navigateScene",value:function(e){return this.editor.swapScene(e)}},{key:"playAudioAsset",value:function(e){var t=new Xe.Audio(this.editor.audioListener);(new Xe.AudioLoader).load(e.src,function(e){t.setBuffer(e),t.setLoop(!1),t.setVolume(.5),t.play()}),this.editor.playing_audio[e.id]=t}},{key:"stopAudioAsset",value:function(e){this.editor.playing_audio[e.id]&&(this.editor.playing_audio[e.id].stop(),delete this.editor.playing_audio[e.id])}},{key:"getGraphObjectById",value:function(e){return this.provider.accessObject(e)}},{key:"startImageRecognizer",value:function(e){var t=this,r=this.provider.pubnub.getLogger();return new Promise(function(t,n){var i=new Image;i.crossOrigin="Anonymous",i.src=e.image.src,r.log("Loading image",i.src),i.onload=function(){t(i)}}).then(function(n){r.log("got the image",m(n)),t.xr&&t.xr.session?t.xr.addImageAnchoredNode(e,n,r):r.log("XR is not active?")})}},{key:"stopImageRecognizer",value:function(e){console.log("WE NEED TO STOP ALL image recognizers here")}},{key:"startGeoRecognizer",value:function(e){var t=this.provider.pubnub.getLogger();this.xr&&this.xr.session?this.xr.addGeoAnchoredNode(e):t.log("XR is not active?")}},{key:"stopGeoRecognizer",value:function(){console.log("WE NEED TO STOP ALL geo recognizers here")}}]),t}(dr),an=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).standardViewClickHandler=function(e){r.scriptManager.isRunning()?r.scriptManager.performClickAction(r.props.provider.accessObject(e.target.userData.graphid)):D.setSelection(e.target.userData.graphid)},r.obj_node_map={},r.previewUpdateNodes=[],r.playing_audio=[];var n=y({});if(!n.doc)throw new Error("doc not specified");return r.logger=new Le(n.doc),r.scriptManager=new fr(new nn(Object(f.a)(Object(f.a)(r)),r.props.provider),r.logger),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"shouldComponentUpdate",value:function(e,t,r){return!1}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("div",{id:"overlay"},i.a.createElement("div",{id:"inner"},i.a.createElement("h1",null,"Application Name"),i.a.createElement("div",{id:"loading-indicator"},i.a.createElement("label",null,"loading"),i.a.createElement("progress",{max:"100",value:"0",id:"progress"})),i.a.createElement("button",{id:"enter-button",disabled:!0},"VR not supported, play anyway"))),i.a.createElement("div",{ref:function(t){return e.wrapper=t}}),i.a.createElement(h.b,null))}},{key:"componentDidMount",value:function(){this.sceneWrappers={},this.initScene(),this.renderer.setAnimationLoop(this.render3.bind(this))}},{key:"render3",value:function(e){this.tweenManager&&this.tweenManager.update(e),this.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),this.pointer&&this.pointer.tick(e),this.stats&&this.stats.update(e),this.controller&&this.controller.update(e),this.scriptManager.isRunning()&&this.scriptManager.tick(e),this.renderer.render(this.scene,this.camera)}},{key:"initScene",value:function(){var e=this,t=function(e){return document.querySelector(e)},r=function(e,t,r){return e.addEventListener(t,r)},n=this.wrapper;this.tweenManager=new jr,this.scene=new Xe.Scene,this.stageRot=new Xe.Group,this.scene.add(this.stageRot),this.stagePos=new Xe.Group,this.stageRot.add(this.stagePos),this.camera=new Xe.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new Xe.WebGLRenderer({antialias:!0});var i=this.renderer;i.setPixelRatio(window.devicePixelRatio),i.setSize(window.innerWidth,window.innerHeight),i.gammaOutput=!0,i.vr.enabled=!0,n.appendChild(i.domElement),this.vrmanager=new zt.h(i),this.audioListener=new Xe.AudioListener,this.camera.add(this.audioListener),this.initContent(),window.addEventListener("resize",function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight)},!1),r(t("#enter-button"),"click",function(){t("#overlay").style.display="none"}),this.vrmanager.addEventListener(zt.j,function(){console.log("VR detected"),t("#enter-button").removeAttribute("disabled",!1),t("#enter-button").innerText="enter vr",r(t("#enter-button"),"click",function(){return e.vrmanager.enterVR()})});t("#loading-indicator").style.display="none",t("#enter-button").style.display="block",t("#enter-button").removeAttribute("disabled"),this.props.provider.onRawChange(this.updateSceneOp.bind(this)),this.props.provider.on(F.DOCUMENT_SWAPPED,this.documentSwapped.bind(this)),D.on(A,this.selectionChanged.bind(this)),r(this.pointer,zt.a,function(){return D.clearSelection()}),this.controller=new Jr(this.stagePos,this.stageRot),this.loadScene()}},{key:"selectionChanged",value:function(){var e=D.getSelection();if(null===e&&this.controls)return this.controls.detach(this.selectedNode);var t=this.findNode(e);this.selectedNode!==t&&this.controls&&this.controls.detach(this.selectedNode),this.selectedNode=t,this.selectedNode&&this.controls&&this.controls.attach(this.selectedNode,this.pointer)}},{key:"initContent",value:function(){var e=this;this.xr||(this.scene.background=new Xe.Color(0));var t=new Xe.DirectionalLight(16777215,1);t.position.set(1,1,1).normalize(),this.scene.add(t),this.scene.add(new Xe.AmbientLight(16777215,.2)),this.stats=new zt.i({renderer:this.renderer}),this.props.editable&&this.camera.add(this.stats),this.scene.add(this.camera),this.camera.matrixAutoUpdate=!1,this.pointer=new zt.g(this,{intersectionFilter:function(e){return e.userData.clickable},cameraFollowMouse:!1,mouseSimulatesController:!1,enableLaser:!0,laserLength:20});var r=new Xe.Mesh(new Xe.CylinderBufferGeometry(.1,.1,1),new Xe.MeshLambertMaterial({color:"aqua"}));if(r.position.z=-.5,r.rotation.x=-90*Math.PI/180,this.pointer.controller1.add(r),this.props.editable&&(this.controls=new zr,this.controls.name="Controls",g(this.controls,"change",function(t){var r=D.getSelection();if(r){var n=e.findNode(r),i=e.props.provider;i.quick_setPropertyValue(r,"tx",n.position.x),i.quick_setPropertyValue(r,"ty",n.position.y),i.quick_setPropertyValue(r,"tz",n.position.z)}})),this.props.editable){this.tools=new Vr(this.scene,this.camera),this.tools.position.set(-1,0,-3),this.scene.add(this.tools),this.tools.add((new Kr).setAll({x:5,y:5,text:"add box"}).on(zt.a,function(){var t=e.props.provider.accessObject(e.currentScene);e.props.provider.add3DObject(jt.cube,t)})),this.tools.add((new Kr).setAll({x:5,y:35,text:"add sphere"}).on(zt.a,function(){var t=e.props.provider.accessObject(e.currentScene);e.props.provider.add3DObject(jt.sphere,t)})),this.tools.add((new Kr).setAll({x:5,y:65,text:"delete"}).on(zt.a,function(){$r(e.props.provider)})),this.tools.add((new Kr).setAll({x:5,y:95,text:"save"}).on(zt.a,this.props.provider.save));var n=(new Kr).setAll({x:5,y:125,text:"run"}).on(zt.a,function(){e.scriptManager.isRunning()?(n.set("text","run"),e.scriptManager.stopRunning()):(n.set("text","stop"),e.scriptManager.startRunning())});this.tools.add(n);var i=(new Yr).setAll({x:5,y:155,w:235,h:35,layout:function(e){var t=0;e.comps.forEach(function(r){r.x=t,r.y=0,t+=r.w+e.padding})}});Mt.forEach(function(t){i.add((new Kr).setAll({text:" ",normalBg:t}).on(zt.a,function(){return e.props.provider.setColor(t)}))}),this.tools.add(i),this.tools.redraw()}}},{key:"updateSceneOp",value:function(e){if(e.type===en&&e.defaults&&"scene"===e.defaults.type){var t=this.findNode(e.id);if(t)   ;else{var r=this.props.provider.accessObject(e.id);t=(new pr).makeNode(r,this.props.provider),this.insertNodeMapping(e.id,t),this.sceneWrappers[e.id]=t,this.stagePos.add(t),this.swapScene(e.id)}}if(e.type!==tn)if(e.type!==_r)if(e.type!==rn)   ;else{var n=this.props.provider.accessObject(e.value);if(Pt(n.type)){var i=this.findNode(n.id);this.findNode(n.parent).remove(i)}}else{var a=this.props.provider.accessObject(e.object);if("asset"===a.type)return;if("assets"===a.type)return;var s=this.findNode(e.object);if(s){if("parent"===e.name)return;if("scene"===a.type)return(new pr).updateProperty(s,a,e,this.props.provider);if(Pt(a.type))return Tt(a.type).updateProperty(s,a,e,this.props.provider)}else console.log("could not find the node for object id:",e),console.log("objects are",this.obj_node_map)}else{var o=this.props.provider.accessObject(e.value);if("scene"===o.type)return;if(Pt(o.type)){var c=Tt(o.type).makeNode(o,this.props.provider);return g(c,zt.a,this.standardViewClickHandler),this.insertNodeMapping(o.id,c),void this.findNode(o.parent).add(c)}if(o.type===Et.ASSETS_LIST)return;if(o.type===Et.ASSET)return;if(o.type===Et.BEHAVIORS_LIST)return;if(o.type===Et.BEHAVIOR)return;if(o.type===Et.BEHAVIOR_SCRIPT)return;console.warn("unknown object type",o)}}},{key:"documentSwapped",value:function(){var e=this;console.log("totally new document!"),Object.keys(this.sceneWrappers).forEach(function(t){var r=e.sceneWrappers[t];e.controls&&r.remove(e.controls),e.stagePos.remove(r)}),this.sceneWrappers={},this.obj_node_map={};var t=this.props.provider.getDocGraph();console.log("we are rebuilding using this graph",t),this.rebuildNode(t,"")}},{key:"rebuildNode",value:function(e,t){var r=this;if(console.log(t,"rebuilding",e.type),e.type===Et.SCENE){var n=(new pr).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,n),this.sceneWrappers[e.id]=n,this.stagePos.add(n),this.swapScene(e.id)}if(Pt(e.type)){var i=Tt(e.type).makeNode(e,this.props.provider);g(i,zt.a,this.standardViewClickHandler),this.insertNodeMapping(e.id,i),this.findNode(e.parent).add(i)}e.children&&e.children.forEach(function(e){r.rebuildNode(e,t+"   ")})}},{key:"swapScene",value:function(e){var t=this;this.currentScene=e,console.log("swapping to the scene",e),Object.keys(this.sceneWrappers).forEach(function(r){var n=t.sceneWrappers[r];n.visible=r===e,t.controls&&n.remove(t.controls)}),this.controls&&this.sceneWrappers[e].add(this.controls),this.sceneWrappers[e].position.x=0,this.sceneWrappers[e].position.z=0}},{key:"loadScene",value:function(){}},{key:"insertNodeMapping",value:function(e,t){if("string"!==typeof e)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[e]=t,t.previewUpdate&&this.previewUpdateNodes.push(t),t.userData.graphid=e}},{key:"findNode",value:function(e){return this.obj_node_map[e]||console.warn("could not find node for id",e),this.obj_node_map[e]}}]),t}(n.Component),sn=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){h.c.hide()},r.okay=function(){h.c.hide(),re(r.fileinput.files).forEach(function(e){console.log("got the file",e)})},r.selectedFile=function(e){console.log("selected a file",e.target)},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,null,i.a.createElement("h3",null,"add GLTF file assets"),i.a.createElement("p",null,"chose ",i.a.createElement("b",null,"the directory")," containing the GLTF file"),i.a.createElement("input",{type:"file",ref:function(t){return e.fileinput=t},onChange:this.selectedFile,multiple:!0,webkitdirectory:"true"}),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(n.Component),on=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){h.c.hide()},r.okay=function(){h.c.hide(),re(r.fileinput.files).forEach(function(e){Qt(e,r.props.provider)})},r.selectedFile=function(e){console.log("selected a file",e.target)},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,null,i.a.createElement("h3",null,"add GLB to assets"),i.a.createElement("p",null,"choose a GLB file"),i.a.createElement("input",{type:"file",ref:function(t){return e.fileinput=t},onChange:this.selectedFile,multiple:!0}),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(n.Component),cn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){h.c.hide()},r.okay=function(){h.c.hide(),"remote"===r.state.view?(console.log("adding the url",r.state.url),Jt(r.state.url,r.props.provider)):(console.log("the file input is",r.fileInput),re(r.fileInput.current.files).forEach(function(e){!function(e,t){R.add("uploading"),t.uploadFile(e).then(function(r){if(R.add("uploaded"),console.log("uploaded file with answer",r),!1===r.success)return console.log("there was an error uploading! :(");var n=z()+r.asset.id,i=t.getDataGraph(),a=ie(i,i.createObject({type:Et.ASSET,subtype:Bt.AUDIO,format:r.asset.mimeType,src:n,title:e.name,parent:0}));t.accessObject(t.getAssetsObject()).insertChildLast(a)})}(e,r.props.provider)}))},r.switchLocal=function(){return r.setState({view:"local"})},r.switchRemote=function(){return r.setState({view:"remote"})},r.selectedFile=function(e){console.log("selected a file",e.target),r.setState({fileInput:e.target.value})},r.typedURL=function(e){r.setState({url:e.target.value})},r.state={view:"local",url:""},r.fileInput=i.a.createRef(),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"add image to assets"),i.a.createElement(h.g,{grow:!0},i.a.createElement(S,null,i.a.createElement(M,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),i.a.createElement(M,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?i.a.createElement(h.d,null,i.a.createElement("label",null,"File",i.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):i.a.createElement(h.d,null,i.a.createElement("label",null,"URL",i.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),t}(n.Component),un=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){r.props.provider.loadDocList().then(function(e){return r.setState({docList:e})})},r.dismiss=function(){h.c.hide()},r.state={docList:[]},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"generateDocUrl",value:function(e){var t=Object.assign({},this.props.provider.options,{mode:"edit",switcher:!1,doc:e.id});return"./?".concat(k(t))}},{key:"deleteDoc",value:function(e){var t=this;return this.props.provider.removeDoc(e).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"Open document"),i.a.createElement(h.g,{scroll:!0,style:{maxHeight:"60vh"}},i.a.createElement("ul",null,this.state.docList.map(function(t,r){return i.a.createElement("li",{key:r},i.a.createElement("b",null,t.title),i.a.createElement("a",{className:"button",href:e.generateDocUrl(t)},"open"),e.renderDeleteButton(t))}))),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.dismiss},"dismiss"))))}},{key:"renderDeleteButton",value:function(e){var t=this;return N.supportsDocDelete()?i.a.createElement("button",{onClick:function(){return t.deleteDoc(e)}},"delete"):""}}]),t}(n.Component),ln=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){r.props.provider.loadAssetList().then(function(e){r.props.filter&&(e=e.filter(r.props.filter)),r.setState({assetList:e})})},r.okay=function(){h.c.hide()},r.state={assetList:[]},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addAsset",value:function(e){return h.c.hide(),Nt(e.mimeType)?(e.url||(e.url="".concat(z()).concat(e.id)),Yt(e.url,e.mimeType,e.title,this.props.provider)):!(t=e.mimeType)||t.toLowerCase()!==Rt.MP3&&t.toLowerCase()!==Rt.AAC?function(e){return!!e&&e.toLowerCase()===Rt.MP4}(e.mimeType)?(e.url||(e.url="".concat(z()).concat(e.id)),function(e,t,r,n){r||(r=e.substring(e.lastIndexOf("/")+1));var i=n.getDataGraph(),a=ie(i,i.createObject({type:Et.ASSET,subtype:Bt.VIDEO,format:t,src:e,title:r,parent:0}));n.accessObject(n.getAssetsObject()).insertChildLast(a)}(e.url,e.mimeType,e.title,this.props.provider)):function(e){return!!e&&e.toLowerCase()===Rt.GLB}(e.mimeType)?(e.url||(e.url="".concat(z()).concat(e.id)),r=e.url,n=e.mimeType,i=e.title,a=this.props.provider,s=a.getDataGraph(),o=ie(s,s.createObject({type:Et.ASSET,subtype:Bt.GLTF,format:n,src:r,title:i,parent:0})),void a.accessObject(a.getAssetsObject()).insertChildLast(o)):void console.log("can't add this type"):(e.url||(e.url="".concat(z()).concat(e.id)),Jt(e.url,e.mimeType,e.title,this.props.provider));var t,r,n,i,a,s,o}},{key:"deleteAsset",value:function(e){var t=this;return this.props.provider.removeAssetSource(e).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"Add Asset"),i.a.createElement(h.g,{scroll:!0,style:{maxHeight:"60vh"}},i.a.createElement("ul",null,this.state.assetList.map(function(t,r){return i.a.createElement("li",{key:r},i.a.createElement("b",null,t.title," "),i.a.createElement("i",null," ",t.mimeType),i.a.createElement("button",{onClick:function(){return e.addAsset(t)}},"add"),e.renderDeleteButton(t))}))),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.okay},"close"))))}},{key:"renderDeleteButton",value:function(e){var t=this;return N.supportsAssetUpload()?i.a.createElement("button",{onClick:function(){return t.deleteAsset(e)}},"delete"):""}}]),t}(n.Component),pn=r(40),hn=r.n(pn),dn=(r(70),r(72),function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).swap=function(){var e=r.props.provider.accessObject(D.getSelection());e.exists()&&e.type===Et.BEHAVIOR_SCRIPT&&r.refresh()},r.changeText=function(e){return r.setState({text:e})},r.save=function(e){r.props.provider.updateBehaviorAssetContents(r.state.id,r.state.text)},r.refresh=function(){var e=D.getSelection(),t=r.props.provider.accessObject(e);console.log("id",e,t.exists(),t.type),t.exists()&&t.type===Et.BEHAVIOR_SCRIPT&&r.props.provider.fetchBehaviorAssetContents(e).then(function(t){r.setState({id:e,text:t})})},r.state={id:null,text:"empty"},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refresh(),this.props.provider.on(F.PROPERTY_CHANGED,this.refresh),D.on(A,this.swap)}},{key:"componentWillUnmount",value:function(){this.props.provider.off(F.PROPERTY_CHANGED,this.refresh),D.off(A,this.swap)}},{key:"render",value:function(){return null===this.state.id?i.a.createElement("div",null,"loading"):i.a.createElement(hn.a,{mode:"javascript",theme:"github",name:"UNIQUE_ID_OF_DIV",value:this.state.text,onChange:this.changeText,onBlur:this.save,showGutter:!0,width:"100%",height:"100%"})}}]),t}(n.Component)),fn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){r.props.provider.loadScriptList().then(function(e){r.setState({scripts:e})})},r.okay=function(){h.c.hide()},r.state={scripts:[]},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addScript",value:function(e){h.c.hide(),e.url||(e.url="".concat(H()).concat(e.name));var t=this.props.provider.addBehaviorAssetFromURL(e);this.props.onAdd&&this.props.onAdd(t)}},{key:"deleteScript",value:function(e){var t=this;return this.props.provider.removeBehaviorAssetSource(e.name).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"Choose Behavior Script"),i.a.createElement(h.g,{scroll:!0,style:{maxHeight:"60vh"}},i.a.createElement("ul",{className:"behaviors-list"},this.state.scripts.map(function(t,r){return i.a.createElement(h.d,{key:t.name},i.a.createElement(h.g,null,i.a.createElement("div",null,i.a.createElement("i",null,t.name)," -  ",i.a.createElement("b",null,t.title)),i.a.createElement("p",null,t.description)),i.a.createElement(C,null),i.a.createElement("button",{onClick:function(){return e.addScript(t)}},"add"),e.renderDeleteButton(t))}))),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.okay},"close"))))}},{key:"renderDeleteButton",value:function(e){var t=this;return N.supportsScriptEdit()?i.a.createElement("button",{onClick:function(){return t.deleteScript(e)}},"delete"):""}}]),t}(n.Component),vn="\n/*\n #title untitled behavior\n #description does something\n*/\n({\n  // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    init: function() {\n        //called when the program starts\n    },\n    onClick: function(e) {\n        //called when object is clicked on\n        //e.system.navigateScene(e.props.scene)\n    }\n})\n",yn="\n/*\n #title scene script\n #description does something\n*/\n({\n    // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    init: function() {\n        //called when the program starts\n    },\n    onEnter: function() {\n        //called when entering a scene\n    },\n    onExit: function() {\n        //called when exiting a scene\n    },\n})\n",gn=r(41),mn=r.n(gn),bn=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.canvas&&this.redraw()}},{key:"componentWillReceiveProps",value:function(e){this.canvas&&this.redraw()}},{key:"redraw",value:function(){mn.a.toCanvas(this.canvas,this.props.url,{width:this.props.width,height:this.props.height})}},{key:"render",value:function(){var e=this,t={};return this.props.style&&Object.assign(t,this.props.style),i.a.createElement("canvas",{width:this.props.width,height:this.props.height,ref:function(t){return e.canvas=t},style:t})}}]),t}(n.Component),wn=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).okay=function(){h.c.hide()},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=document.documentURI;this.props.url&&(e=this.props.url);var t=e.replace("https","wxrv");return t=t.replace("http","wxrv"),i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,this.props.text?this.props.text:"Scan"),i.a.createElement(h.g,{grow:!0},i.a.createElement("label",null,i.a.createElement("a",{href:e},e)),i.a.createElement(bn,{url:t,width:160,height:160})),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.okay},"dismiss"))))}}]),t}(n.Component),kn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){h.c.hide()},r.okay=function(){h.c.hide(),N.doPasswordLogin(r.state.field)},r.state={field:""},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"login with the password from your env file"),i.a.createElement("label",null,"password"),i.a.createElement("input",{type:"text",value:this.state.field,onChange:function(t){e.setState({field:t.target.value})}}),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(n.Component),On=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){h.c.hide()},r.okay=function(){h.c.hide(),console.log("opening window with the data",r.state.data),N.login(r.state.data)},r.state={data:null},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;console.log("opening dialog"),N.getJSON(G.BASE+"auth/github/login").then(function(t){console.log("got the data",t),e.setState({data:t})})}},{key:"render",value:function(){return i.a.createElement(h.a,{visible:!0},i.a.createElement(h.g,{grow:!0},i.a.createElement("h3",null,"Github Auth"),i.a.createElement("p",null,"To log into MrEd you need a github account. Press the button below to log into github and approve MrEd's access. The app will only use Github for authentication. It does not have access to any of your projects or code."),i.a.createElement("button",{onClick:this.okay},"Open Github"),i.a.createElement(h.d,null,i.a.createElement("button",{onClick:this.cancel},"cancel"))))}}]),t}(n.Component),Sn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).getApp=function(){return"edit"===r.mode?i.a.createElement(xn,{provider:Object(f.a)(Object(f.a)(r))}):"vredit"===r.mode?i.a.createElement(an,{provider:Object(f.a)(Object(f.a)(r)),editable:!0}):"embed-view"===r.mode?i.a.createElement(an,{provider:Object(f.a)(Object(f.a)(r)),editable:!1}):"vrview"===r.mode?i.a.createElement(an,{provider:Object(f.a)(Object(f.a)(r)),editable:!1}):void console.log("no mode!")},r.getTitle=function(){return"MrEd"},r.getDocTitle=function(){return r.accessObject(r.getSceneRoot()).title},r.docLoaded=function(){r.accessObject(r.getBehaviorsObject()).getChildren().filter(function(e){return e.type===Et.BEHAVIOR_SCRIPT}).forEach(function(e){r.fetchBehaviorAssetContents(e.id).then(function(t){try{var n=Gt(t);n.text=t,r.setCachedBehaviorAsset(e.id,n)}catch(i){console.error(i)}})})},r.getRendererForItem=function(e){var t=r.accessObject(e);return t.exists()?t.type===Et.ASSET?i.a.createElement("div",null,i.a.createElement("i",{className:"fa fa-".concat(Ft[t.subtype])})," ",t.title):Ft[t.type]?i.a.createElement("div",null,i.a.createElement("i",{className:"fa fa-".concat(Ft[t.type])})," ",t.title):i.a.createElement("div",null,t.title):i.a.createElement("div",null,"???")},r.getAssetsObject=function(){return r.getDataGraph().getObjectByProperty("type",Et.ASSETS_LIST)},r.getBehaviorsObject=function(){return r.getDataGraph().getObjectByProperty("type",Et.BEHAVIORS_LIST)},r.editIn2D=function(){r.save().then(function(){var e=Object.assign({},r.options,{mode:"edit",switcher:!1}),t=document.location,n="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(k(e));h.c.show(i.a.createElement(wn,{text:"Edit in 2D",url:n}))})},r.editInVR=function(){r.save().then(function(){var e=Object.assign({},r.options,{mode:"vredit",switcher:!1}),t=document.location,n="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(k(e));h.c.show(i.a.createElement(wn,{text:"Edit in AR/VR",url:n}))})},r.viewInVR=function(){r.save().then(function(){var e=Object.assign({},r.options,{mode:"play",switcher:!1}),t=document.location,n="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(k(e));h.c.show(i.a.createElement(wn,{text:"View in AR/VR",url:n}))})},r.add3DObject=function(e,t){var n=Tt(e).make(r.getDataGraph(),t);t.insertFirstChild(n),D.setSelection(n.id),R.add("added "+e)},r.cutSelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}if(!D.isEmpty()){var t=r.accessObject(D.getSelection());D.setClipboard(t.id),t.removeFromParent(),D.clearSelection()}},r.copySelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}if(!D.isEmpty()){var t=r.accessObject(D.getSelection());D.setClipboard(t.id)}},r.pasteSelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}var t=r.accessObject(D.getClipboard()),n=null;if(Pt(t.type)&&(n=r.getSelectedSceneObject().id),"scene"===t.type&&(n=r.accessObject(r.getSceneRoot())),!n)return console.error("no parent to ad too! bad obj type?",t.type);n.insertChildLast(t.clone())},r.setColor=function(e){D.isEmpty()||r.accessObject(D.getSelection()).set("color",e)},r.showAddImageAssetDialog=function(){return h.c.show(i.a.createElement(qt,{provider:Object(f.a)(Object(f.a)(r))}))},r.showAddAudioAssetDialog=function(){return h.c.show(i.a.createElement(cn,{provider:Object(f.a)(Object(f.a)(r))}))},r.showAddGLTFAssetDialog=function(){return h.c.show(i.a.createElement(sn,{provider:Object(f.a)(Object(f.a)(r))}))},r.showAddGLBAssetDialog=function(){return h.c.show(i.a.createElement(on,{provider:Object(f.a)(Object(f.a)(r))}))},r.showOpenDocumentDialog=function(){return h.c.show(i.a.createElement(un,{provider:Object(f.a)(Object(f.a)(r))}))},r.showOpenAssetDialog=function(){return h.c.show(i.a.createElement(ln,{provider:Object(f.a)(Object(f.a)(r))}))},r.showAddServerImageDialog=function(){return h.c.show(i.a.createElement(ln,{provider:Object(f.a)(Object(f.a)(r)),filter:function(e){return Nt(e.mimeType)}}))},r.showOpenBehaviorDialog=function(){return h.c.show(i.a.createElement(fn,{provider:Object(f.a)(Object(f.a)(r))}))},r.showAddGeoLocationAssetDialog=function(){var e,t,n,i;e={latitude:0,longitude:0,altitude:0,useAltitude:!1},t="new geo location",n=Object(f.a)(Object(f.a)(r)),i=n.accessObject(n.getDataGraph().createObject({type:Et.ASSET,subtype:Bt.GEOLOCATION,title:t,latitude:e.latitude,longitude:e.longitude,altitude:e.altitude,useAltitude:e.useAltitude,parent:0})),n.accessObject(n.getAssetsObject()).insertChildLast(i)},r.showPasswordDialog=function(){return h.c.show(i.a.createElement(kn,{provider:Object(f.a)(Object(f.a)(r))}))},r.showGithubDialog=function(){return h.c.show(i.a.createElement(On,{provider:Object(f.a)(Object(f.a)(r))}))},r.accessObject=function(e){return new _t(r.getDataGraph()).object(e)},r.addBehaviorAssetFromURL=function(e){var t=r.getDataGraph(),n=ie(t,t.createObject({type:Et.BEHAVIOR_SCRIPT,title:e.title,description:e.description,src:e.url,parent:0}));return r.accessObject(r.getBehaviorsObject()).insertChildLast(n),D.setSelection(n.id),n},r.addCustomBehaviorAsset=function(e){var t=Math.floor(1e8*Math.random()),n="behavior_".concat(t,".js"),i="".concat(H()).concat(n),a=e||vn;return console.log("posting it to",i),N.fetch(i,{method:"POST",body:a}).then(function(e){return e.json()}).then(function(e){console.log("got back the answer",e);var t=r.getDataGraph(),n=ie(t,t.createObject({type:Et.BEHAVIOR_SCRIPT,title:e.script.title,description:e.script.description,src:i,parent:0}));return r.accessObject(r.getBehaviorsObject()).insertChildLast(n),D.setSelection(n.id),n}).catch(function(e){return console.error(e)})},r.addSceneScript=function(e){r.addCustomBehaviorAsset(yn).then(function(t){return r.addBehaviorToObject(t,e)})},r.addBehaviorToObject=function(e,t){return r.fetchBehaviorAssetContents(e.id).then(function(n){try{var i={type:Et.BEHAVIOR,title:e.title,description:e.description,parent:0,behavior:e.id},a=Gt(n);r.setCachedBehaviorAsset(e.id,a),a.properties&&Object.keys(a.properties).forEach(function(e){i[e]=a.properties[e].value});var s=r.getDataGraph(),o=ie(s,s.createObject(i));return r.accessObject(t).insertChildLast(o),o}catch(c){console.error(c)}})},r.imagecache={},r.videocache={},r.behaviorCache={},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"getDocType",value:function(){return"vr"}},{key:"makeEmptyRoot",value:function(e){var t=ie(e,e.createObject({type:Et.ROOT,title:"Untitled Project",defaultScene:0,children:e.createArray()})),r=(new pr).make(e,t),n=(new tt).make(e,r),i=ie(e,e.createObject({type:Et.ASSETS_LIST,title:"Assets",children:e.createArray(),parent:0})),a=ie(e,e.createObject({type:Et.BEHAVIORS_LIST,title:"Behaviors",children:e.createArray(),parent:0}));se(e,t,r),se(e,r,n),oe(e,t,a),oe(e,t,i)}},{key:"getProperties",value:function(e){var t=this;var r=[];if(!e)return r;r.push({key:"id",name:"ID",type:$.STRING,value:e,locked:!0});var n=this.accessObject(e);if(n.type===Et.BEHAVIOR){var i=this.getCachedBehaviorPropDefs(n.behavior);i?Object.keys(i).forEach(function(e){var t=i[e],a={key:e,name:e,type:t.type,value:n[e]};t.hints&&(a.hints=t.hints),r.push(a)}):console.warn("Missing prop defs for behavior object"),r.push({key:"behavior",name:"Script",type:$.STRING,value:n.behavior,locked:!0,custom:!0})}var a=this.syncdoc.getPropertiesForObject(e);return a&&a.forEach(function(i){if("type"!==i&&"children"!==i&&"parent"!==i){var a=t.syncdoc.getPropertyValue(e,i);if(Ct[i]){var s=function(e,t){var r={};return Object.keys(e).forEach(function(t){return r[t]=e[t]}),r.value=t,r}(Ct[i],a);return n.type===Et.BEHAVIOR_SCRIPT&&("title"!==i&&"description"!==i||(s.locked=!0)),r.push(s)}}}),Pt(n.type)&&r.push({key:"scale",name:"Scale",type:$.GROUP,group:["sx","sy","sz"],custom:!0}),r}},{key:"setPropertyValue",value:function(e,r,n){if("scale"===r.key)return Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"sx"},n.sx),Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"sy"},n.sy),void Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"sz"},n.sz);if(Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,r,n),r.key===Ct.asset.key){var i=this.accessObject(n);if(i.subtype===Bt.IMAGE){var a=i.height/i.width*this.accessObject(e).width;Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"height"},a)}i.subtype===Bt.GLTF&&console.log("adjusting to a gtlf")}}},{key:"getValuesForEnum",value:function(e,t,r){var n=this.accessObject(t);if(n.exists()&&n.type===Et.BEHAVIOR&&r.hasHints()){var i=r.getHints();if("node"===i.type)return this.accessObject(this.getSceneRoot()).find(function(e){return e.type===i.nodeType}).map(function(e){return e.id});if("audio"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===Bt.AUDIO}).map(function(e){return e.id});if("video"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===Bt.VIDEO}).map(function(e){return e.id})}if(e===Ct.asset.key){var a=this.accessObject(this.getAssetsObject()).getChildren();if(jn(n.type)&&En(n.type))return a.filter(function(e){return e.subtype===Bt.VIDEO||e.subtype===Bt.IMAGE}).map(function(e){return e.id});if(En(n.type))return a.filter(function(e){return e.subtype===Bt.VIDEO}).map(function(e){return e.id});if(n.type===jt.model)return a.filter(function(e){return e.subtype===Bt.GLTF}).map(function(e){return e.id});if(jn(n.type))return a.filter(function(e){return e.subtype===Bt.IMAGE}).map(function(e){return e.id})}if(e===Ct.horizontalAlign.key)return Object.keys(At).map(function(e){return At[e]});if(e===Ct.defaultScene.key)return this.accessObject(this.getSceneRoot()).getChildren().filter(function(e){return e.type===Et.SCENE}).map(function(e){return e.id});if(e===Ct.texture.key){var s=this.accessObject(this.getAssetsObject()).getChildren();return s=s.filter(function(e){return e.subtype===Bt.IMAGE}).map(function(e){return e.id})}if(e===Ct.targetImage.key){var o=this.accessObject(this.getAssetsObject()).getChildren();return o=o.filter(function(e){return e.subtype===Bt.IMAGE}).map(function(e){return e.id})}if(e===Ct.targetGeoLocation.key){var c=this.accessObject(this.getAssetsObject()).getChildren();return c=c.filter(function(e){return e.subtype===Bt.GEOLOCATION}).map(function(e){return e.id})}return e===Ct.recType.key?Object.keys(Ut):void 0}},{key:"getRendererForEnum",value:function(e,t){var r=this.accessObject(t);if(r.exists()&&r.type===Et.BEHAVIOR)return Cn;switch(e){case Ct.asset.key:case Ct.defaultScene.key:case Ct.texture.key:case Ct.targetImage.key:case Ct.targetGeoLocation.key:return Cn;default:return null}}},{key:"getSelectedSceneObject",value:function(){var e=D.getSelection();if(null===e)return this.getFirstSceneObject();var t=this.accessObject(e);return t.type===Et.SCENE?t:Pt(t.type)?this.findSceneObjectParent(t):t.type===Et.BEHAVIOR?this.findSceneObjectParent(t):null}},{key:"getFirstSceneObject",value:function(){return this.accessObject(this.getSceneRoot()).getChildren()[0]}},{key:"findSceneObjectParent",value:function(e){return null===e?null:e.exists()?e.type===Et.SCENE?e:(e=this.accessObject(e.parent),this.findSceneObjectParent(e)):null}},{key:"quick_setPropertyValue",value:function(e,t,r){var n=this.getDataGraph().getPropertyValue(e,t),i=this.cmd.setProperty(e,t,r);i.prevValue=n,i.value!==i.prevValue&&(this.getRawGraph().process(i),this.fire(F.PROPERTY_CHANGED,{provider:this,child:e,propKey:t,oldValue:n,newValue:r}))}},{key:"calculateContextMenu",value:function(e){var t=this,r=[],n=this.accessObject(e);return It(n.type)&&r.push({title:"delete",icon:Ft.delete,fun:function(){return $r(t)}}),n.type===Et.ASSETS_LIST&&r.push({title:"existing asset on server",icon:Ft.assets,fun:function(){return t.showOpenAssetDialog()}}),Dt(n.type)&&(r.push({divider:!0}),Object.keys(jt).forEach(function(e){return r.push({title:e,icon:Ft[e],fun:function(){return t.add3DObject(e,n)}})})),n.type===Et.ROOT&&r.push({title:"scene",icon:Ft.scene,fun:function(){return qr(t)}}),Lt(n.type)&&(r.push({divider:!0}),this.accessObject(this.getBehaviorsObject()).getChildren().filter(function(e){return e.type===Et.BEHAVIOR_SCRIPT}).forEach(function(n){r.push({title:n.title,icon:Ft.behavior_script,fun:function(){return t.addBehaviorToObject(n,e)}})}),N.isLoggedIn()&&r.push({title:"Add Behavior from server",icon:Ft.behavior_script,fun:function(){h.c.show(i.a.createElement(fn,{provider:t,onAdd:function(r){t.addBehaviorToObject(r,e).then(function(e){D.setSelection(e.id)})}}))}})),n.type===Et.SCENE&&(r.push({divider:!0}),N.scriptEditingSupported&&r.push({title:"Add Scene script",icon:Ft.behavior,fun:function(){return t.addSceneScript(e)}})),n.type===Et.BEHAVIOR&&(r.push({divider:!0}),r.push({title:"view code",icon:Ft.behavior,fun:function(){return D.setSelection(n.behavior)}})),It(n.type)&&(r.push({divider:!0}),r.push({title:"cut",icon:Ft.cut,fun:this.cutSelection}),r.push({title:"copy",icon:Ft.copy,fun:this.copySelection}),r.push({title:"paste",icon:Ft.paste,fun:this.pasteSelection})),r}},{key:"canBeMoved",value:function(e){var t=this.accessObject(e);return t.type!==Et.ROOT&&(t.type!==Et.BEHAVIORS_LIST&&t.type!==Et.ASSETS_LIST)}},{key:"canAddChild",value:function(e,t){var r=this.accessObject(e),n=this.accessObject(t);return r.type===Et.ROOT&&n.type===Et.SCENE||(!(r.type!==Et.SCENE||!Pt(n.type))||!(!Dt(r.type)||!Pt(n.type)))}},{key:"canBeSibling",value:function(e,t){var r=this.accessObject(e),n=this.accessObject(t);return r.type===Et.SCENE&&n.type===Et.SCENE||!(!Pt(r.type)||!Pt(n.type))}},{key:"canAddExternalChild",value:function(e,t){return this.accessObject(e).type===Et.ASSETS_LIST}},{key:"acceptDrop",value:function(e,t){var r=this;this.accessObject(t).type===Et.ASSETS_LIST&&re(e.dataTransfer.files).forEach(function(e){return Nt(e.type)?Zt(e,r):function(e){if(!e)return!1;if(console.log("looking at the file",e,"type",e.type,"type"),!e.type||""===e.type||0===e.type.length){if(console.log("no mimetype. check extension"),e.name.toLowerCase().indexOf(".gltf")>0)return!0;if(e.name.toLowerCase().indexOf(".glb")>0)return!0}return"image/gltf"===e.type.toLowerCase()}(e)?Qt(e,r):void 0})}},{key:"requestImageCache",value:function(e){var t=this,r=new Image;return this.imagecache[e]=r,new Promise(function(n,i){r.src=e,r.onload=function(){t.fire(F.STRUCTURE_CHANGED,{provider:t}),n(r)}})}},{key:"createCustomEditor",value:function(e,t,r,n,a){return t.key===Ct.color.key||t.key===Ct.backgroundColor.key||t.key===Ct.borderColor.key||t.key===Ct.textColor.key||t.key===Ct.startColor.key||t.key===Ct.endColor.key?i.a.createElement(h.d,null,Mt.map(function(e){return i.a.createElement("button",{key:e,onClick:function(){return a(e)},style:{color:e,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})})):"scale"===t.key?i.a.createElement(Mn,{def:t,item:e,onChange:a,provider:this}):"behavior"===t.key?i.a.createElement("button",{onClick:function(){return D.setSelection(n)}},"view code"):i.a.createElement("i",null,"no custom editor for ",t.key)}},{key:"loadDocList",value:function(){return N.getJSON("".concat(U(),"list"))}},{key:"removeDoc",value:function(e){return N.fetch("".concat(U(),"delete/").concat(e.id),{method:"POST",body:e.id}).then(function(e){return e.json()})}},{key:"loadAssetList",value:function(){return N.getJSON("".concat(z(),"list"))}},{key:"removeAssetSource",value:function(e){return N.fetch("".concat(z(),"delete/").concat(e.id),{method:"POST",body:e.id}).then(function(e){return e.json()})}},{key:"loadScriptList",value:function(){return N.getJSON("".concat(H(),"list"))}},{key:"removeBehaviorAssetSource",value:function(e){var t="".concat(H(),"delete/").concat(e);return console.log("removing",t),N.fetch(t,{method:"POST",body:e}).then(function(e){return e.json()})}},{key:"fetchBehaviorAssetContents",value:function(e){var t=this.accessObject(e);return N.fetch(t.src,{method:"GET"}).then(function(e){return e.text()})}},{key:"updateBehaviorAssetContents",value:function(e,t){if(N.supportsScriptEdit()){var r=Gt(t);r.text=t,this.setCachedBehaviorAsset(e,r);var n=this.accessObject(e);return N.fetch(n.src,{method:"POST",body:t}).then(function(e){return e.json()}).then(function(e){n.set("title",e.script.title),n.set("description",e.script.description)})}}},{key:"getCachedBehaviorPropDefs",value:function(e){return this.behaviorCache[e]?this.behaviorCache[e].properties:(console.error("no parsed behavior in the cache",e),null)}},{key:"getCachedBehaviorAsset",value:function(e){return this.behaviorCache[e]}},{key:"setCachedBehaviorAsset",value:function(e,t){this.behaviorCache[e]=t}}]),t}(Ne),xn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).selectionChanged=function(){if(!D.isEmpty()){var e=r.props.provider.accessObject(D.getSelection());if(e.type===Et.BEHAVIOR_SCRIPT)return r.setState({mode:"script"});if(e.type===Ct.asset.key)return r.setState({mode:"asset"})}r.setState({mode:"canvas"})},r.toggleRunning=function(){r.setState({running:!r.state.running})},r.state={mode:"canvas",user:null,running:!1,connected:!1},r.im=new Fe,r.im.addKeyBinding({id:"save",key:Fe.KEYS.S,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"undo",key:Fe.KEYS.Z,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"redo",key:Fe.KEYS.Z,modifiers:[Fe.MODIFIERS.COMMAND,Fe.MODIFIERS.SHIFT]}),r.im.addListener("save",r.props.provider.save),r.im.addListener("undo",r.props.provider.performUndo),r.im.addListener("redo",r.props.provider.performRedo),r.im.addKeyBinding({id:"cut",key:Fe.KEYS.X,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"copy",key:Fe.KEYS.C,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"paste",key:Fe.KEYS.V,modifiers:[Fe.MODIFIERS.COMMAND]}),r.im.addListener("cut",r.props.provider.cutSelection),r.im.addListener("copy",r.props.provider.copySelection),r.im.addListener("paste",r.props.provider.pasteSelection),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.im.attachKeyEvents(document),D.on(A,this.selectionChanged),N.on(B,function(){return e.setState({user:N.getUsername()})}),N.on("CONNECTED",function(){return e.setState({connected:!0})}),N.isConnected()&&this.setState({connected:!0})}},{key:"componentWillUnmount",value:function(){D.off(A,this.selectionChanged)}},{key:"render",value:function(){if(!1===this.state.connected)return i.a.createElement("div",null,i.a.createElement("h1",null,"connecting to server"));var e=this.props.provider,t=i.a.createElement("div",null,"doc id: ",i.a.createElement("b",null,e.getDocId()));return i.a.createElement(E,{bottomText:t},i.a.createElement(S,{left:!0,top:!0},i.a.createElement("label",null,e.getTitle())),i.a.createElement(x,{scroll:!0,left:!0,middle:!0},i.a.createElement(pe,{root:e.getSceneRoot(),provider:e})),i.a.createElement(S,{left:!0,bottom:!0},i.a.createElement("button",{className:"fa fa-cube",onClick:function(t){return function(e,t){var r=t.getSelectedSceneObject(),n=Object.keys(jt).map(function(e){return{title:e,icon:Ft[e],fun:function(){return t.add3DObject(e,r)}}});h.f.show(i.a.createElement(j,{actions:n}),e.target)}(t,e)}}),i.a.createElement("button",{className:"fa fa-globe",onClick:function(t){return qr(e)}}),i.a.createElement("button",{className:"fa fa-archive",onClick:function(t){return function(e,t){var r=[];N.supportsAssetUpload()?r=r.concat([{title:"image",icon:Ft.image,fun:function(){return t.showAddImageAssetDialog()}},{title:"server image",icon:Ft.image,fun:function(){return t.showAddServerImageDialog()}},{divider:!0},{title:"GLTF model",icon:Ft.model,fun:function(){return t.showAddGLTFAssetDialog()}},{title:"GLB model",icon:Ft.model,fun:function(){return t.showAddGLBAssetDialog()}},{divider:!0},{title:"audio file",icon:Ft.audio,fun:function(){return t.showAddAudioAssetDialog()}},{title:"existing asset on server",icon:Ft.assets,fun:function(){return t.showOpenAssetDialog()}}]):r.push({title:"add asset from glitch",icon:Ft.assets,fun:function(){return t.showOpenAssetDialog()}}),r.push({title:"geo location",icon:Ft.geoanchor,fun:function(){return t.showAddGeoLocationAssetDialog()}}),h.f.show(i.a.createElement(j,{actions:r}),e.target)}(t,e)}}),i.a.createElement("button",{className:"fa fa-superpowers",onClick:function(t){return function(e,t){var r=[{title:"Add Behavior from Server",icon:Ft.behavior_script,fun:function(){return t.showOpenBehaviorDialog()}}];N.supportsScriptEdit()&&r.push({title:"custom behavior",icon:Ft.behavior_script,fun:function(){return t.addCustomBehaviorAsset()}}),h.f.show(i.a.createElement(j,{actions:r}),e.target)}(t,e)}})),i.a.createElement(S,{center:!0,top:!0},i.a.createElement("button",{className:"fa fa-file",onClick:function(){return t=e,r=Object.assign({},t.options,{mode:"edit",switcher:!1,doc:t.genID("doc")}),void(document.location="./?".concat(k(r)));var t,r},title:"new project"}),i.a.createElement("button",{className:"fa fa-save",onClick:function(){return e.save()},title:"save project"}),i.a.createElement("button",{onClick:function(){return e.editIn2D()}},"2D Edit"),i.a.createElement("button",{onClick:function(){return e.viewInVR()}},"XR View"),i.a.createElement(C,null),i.a.createElement(An,{onClick:this.toggleRunning,active:this.state.running}),i.a.createElement(C,null),i.a.createElement("button",{className:"fa fa-cut",onClick:e.cutSelection}),i.a.createElement("button",{className:"fa fa-copy",onClick:e.copySelection}),i.a.createElement("button",{className:"fa fa-paste",onClick:e.pasteSelection}),i.a.createElement("button",{className:"fa fa-undo",onClick:e.performUndo}),i.a.createElement("button",{className:"fa fa-repeat",onClick:e.performRedo})),i.a.createElement(x,{center:!0,middle:!0,scroll:!0,transparent:!0},this.renderCenterPane(this.state.mode)),i.a.createElement(x,{scroll:!0,right:!0},i.a.createElement(_,{provider:e})),i.a.createElement(S,{right:!0,top:!0},this.renderLoginButton()),i.a.createElement(S,{right:!0,bottom:!0}),i.a.createElement(h.b,null),i.a.createElement(h.e,null))}},{key:"renderCenterPane",value:function(e){return"script"===e?i.a.createElement(dn,{provider:this.props.provider}):"canvas"===e?i.a.createElement(Br,{provider:this.props.provider,running:this.state.running}):i.a.createElement(Kt,{provider:this.props.provider,asset:D.getSelection()})}},{key:"renderLoginButton",value:function(){var e=this,t=[];return N.supportsAuth()&&(N.isLoggedIn()?t.push(i.a.createElement("button",{key:"logout",className:"fa fa-user",onClick:N.logout,title:"logout"},"logout")):t.push(i.a.createElement("button",{key:"login",className:"fa fa-user",onClick:function(){N.supportsPassword()?e.props.provider.showPasswordDialog():e.props.provider.showGithubDialog()},title:"login"}))),N.supportsDocList()&&t.push(i.a.createElement("button",{key:"open",className:"fa fa-folder-open",onClick:this.props.provider.showOpenDocumentDialog,title:"open"})),t}}]),t}(n.Component),Cn=function(e){var t="---";return e.value&&e.provider&&(t=e.provider.accessObject(e.value).title),i.a.createElement("b",null,t)},Mn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).syncChanged=function(e){return r.setState({sync:!r.state.sync})},r.changed=function(e,t){var n=r.props.provider.accessObject(r.props.item),i={sx:n.sx,sy:n.sy,sz:n.sz},a=parseFloat(e.target.value);i[t]=a,r.state.sync&&(i.sx=a,i.sy=a,i.sz=a),r.props.onChange(i)},r.state={sync:!1},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this,t=this.props.provider.accessObject(this.props.item);return i.a.createElement(h.d,{className:"scale-editor"},i.a.createElement("input",{type:"checkbox",checked:this.state.sync,onChange:this.syncChanged}),i.a.createElement("input",{type:"number",value:t.sx,onChange:function(t){return e.changed(t,"sx")},step:.1}),i.a.createElement("input",{type:"number",value:t.sy,onChange:function(t){return e.changed(t,"sy")},step:.1}),i.a.createElement("input",{type:"number",value:t.sz,onChange:function(t){return e.changed(t,"sz")},step:.1}))}}]),t}(n.Component);function jn(e){return e===jt.plane||e===jt.bg360||e===jt.img2d}function En(e){return e===jt.plane||e===jt.bg360||e===jt.img2d}var An=function(e){var t=e.active?"run-button active fa fa-stop":"run-button fa fa-play";return i.a.createElement("button",{onClick:e.onClick,className:t})};function Pn(e){e.find=function(t,r){return r||(r=[]),t(e)&&r.push(e),e.children&&e.children.forEach(function(e){e.find(t,r)}),r},e.exists=function(){return!0}}var Dn=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).renderThreeWithCamera=function(e,t,n,i,a){r.scene&&r.camera&&(r.camera.matrix.fromArray(n),r.camera.matrixWorldNeedsUpdate=!0,r.camera.updateMatrixWorld(),r.camera.projectionMatrix.fromArray(t),r.renderThree(i,a))},r.renderThree=function(e,t){r.tweenManager&&r.tweenManager.update(e),r.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),r.pointer&&r.pointer.tick(e),r.stats&&r.stats.update(e),r.controller&&r.controller.update(e);var n=null;r.xr&&(n=r.xr.session),r.scriptManager.tick(e,n,t),r.renderer.render(r.scene,r.camera)};var n=y({});if(!n.doc)throw new Error("doc not specified");return new W(e.options),r.obj_map={},r.three_map={},r.title_map={},r.previewUpdateNodes=[],r.current_scene=null,r.root=null,r.behavior_map={},r.behavior_assets={},r.pendingAssets=[],r.logger=new Le(n.doc),r.scriptManager=new fr(new Ln(Object(f.a)(Object(f.a)(r))),r.logger),r.provider={accessObject:function(e){return r.obj_map[e]?r.obj_map[e]:{exists:function(){return!1}}}},r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.logger.log("mounted ImmersivePlayer");var t=this.canvas;Pr.supportsARKit()?(this.xr=new Pr,this.xr.getContext(t).then(function(r){e.initThreeJS(t,r),e.xr.setAnimationLoop(e.renderThreeWithCamera.bind(e)),e.startScene()}).catch(function(e){console.error("Error",e)})):(this.initThreeJS(t,0),this.renderer.setAnimationLoop(this.renderThree.bind(this)),this.startScene())}},{key:"startScene",value:function(){var e=this,t=y({});N.getJSON(U()+t.doc).then(function(t){if(e.root=t.graph,e.logger.log("loaded payload",e.root),e.buildRoot(e.root),e.logger.log(e.root),e.root.defaultScene){var r=e.root.children.find(function(t){return t.id===e.root.defaultScene});e.setCurrentScene(r)}else{var n=e.root.children[0];e.setCurrentScene(n)}Promise.all(e.pendingAssets).then(function(){e.logger.log("all assets loaded now. starting script manager"),e.scriptManager.startRunning()})})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("canvas",{ref:function(t){return e.canvas=t},width:600,height:400}))}},{key:"buildRoot",value:function(e){var t=this;e.children.forEach(function(e){if(e.type===Et.ASSETS_LIST)return t.initAssets(e)}),e.children.forEach(function(e){return Pn(e),e.type===Et.SCENE?t.initObject(e):e.type===Et.BEHAVIORS_LIST?t.initBehaviors(e):void 0})}},{key:"initObject",value:function(e){var t=this;Pn(e),this.obj_map[e.id]=e,e.title&&(this.title_map[e.title]=e);var r=null;if(e.type===Et.SCENE){var n=(new pr).makeNode(e,this.provider);this.three_map[e.id]=n,this.scenes.add(n),n.visible=!1,r=n}return e.props=function(){return e},Pt(e.type)&&((r=Tt(e.type).makeNode(e,this.provider)).previewUpdate&&this.previewUpdateNodes.push(r),this.three_map[e.id]=r,g(r,"click",function(){t.scriptManager.performClickAction(e)})),e.type===Et.BEHAVIOR&&(this.behavior_map[e.id]=e),e.children&&e.children.forEach(function(e){var n=t.initObject(e);n&&r.add(n)}),r}},{key:"initThreeJS",value:function(e,t){var r=this;this.tweenManager=new jr,this.scene=new Xe.Scene,this.camera=new Xe.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new Xe.WebGLRenderer({antialias:!0,canvas:e,context:t}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.renderer.vr.enabled=!0,this.vrmanager=new zt.h(this.renderer),this.audioListener=new Xe.AudioListener,this.camera.add(this.audioListener),this.xr||(this.scene.background=new Xe.Color(0)),this.camera.matrixAutoUpdate=!1,this.scene.add(this.camera),window.addEventListener("resize",function(){r.camera.aspect=window.innerWidth/window.innerHeight,r.camera.updateProjectionMatrix(),r.renderer.setSize(window.innerWidth,window.innerHeight)},!1);var n=new Xe.DirectionalLight(16777215,1);n.position.set(1,1,1).normalize(),this.scene.add(n),this.scene.add(new Xe.AmbientLight(16777215,.2)),this.scenes=new Xe.Group,this.scene.add(this.scenes),this.pointer=new zt.g(this,{intersectionFilter:function(e){return e.userData.clickable},cameraFollowMouse:!1,mouseSimulatesController:!1,enableLaser:!0,laserLength:20})}},{key:"initAssets",value:function(e){var t=this;e.children.forEach(function(e){t.logger.log("loading asset",e),Pn(e),t.obj_map[e.id]=e})}},{key:"initBehaviors",value:function(e){var t=this;e.children.forEach(function(e){if(Pn(e),t.obj_map[e.id]=e,e.type===Et.BEHAVIOR_SCRIPT){t.logger.log("loading behavior",e);var r=N.fetch(e.src,{method:"GET"}).then(function(e){return e.text()}).then(function(r){var n=Gt(r);return n.text=r,t.behavior_assets[e.id]=n,r});t.pendingAssets.push(r)}})}},{key:"setCurrentScene",value:function(e){this.scenes.children.forEach(function(e){return e.visible=!1}),this.three_map[e.id]&&(this.three_map[e.id].visible=!0),this.current_scene=e}}]),t}(n.Component),Ln=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).player=e,r.logger=r.player.logger,r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"getCurrentScene",value:function(){return this.player.current_scene}},{key:"getBehaviorsForObject",value:function(e){return e.children?e.children.filter(function(e){return e.type===Et.BEHAVIOR}):[]}},{key:"getSceneObjects",value:function(e){return e.children.filter(function(e){return Pt(e.type)})}},{key:"getThreeObject",value:function(e){return this.player.three_map[e]}},{key:"getParsedBehaviorAsset",value:function(e){return this.player.behavior_assets[e.behavior]}},{key:"getAllBehaviors",value:function(){var e=this;return Object.keys(this.player.behavior_map).map(function(t){return e.player.behavior_map[t]})}},{key:"navigateScene",value:function(e){console.log("navigating to ",e);var t=this.obj_map[e];if(!t)return console.warn("couldn't find scene for",e);this.setCurrentScene(t)}},{key:"playAudioAsset",value:function(e){console.log("trying to play",e);var t=new Xe.Audio(this.player.audioListener);(new Xe.AudioLoader).load(e.src,function(e){t.setBuffer(e),t.setLoop(!1),t.setVolume(.5),t.play()})}},{key:"getGraphObjectByName",value:function(e){return this.player.title_map[e]}},{key:"getGraphObjectById",value:function(e){return this.player.obj_map[e]}},{key:"startImageRecognizer",value:function(e){var t=this;return this.logger.log("PRETENDING to START THE IMAGE RECOGNIZER"),new Promise(function(r,n){var i=new Image;i.crossOrigin="Anonymous",i.src=e.image.src,t.logger.log("Loading image",i.src),i.onload=function(){r(i)}}).then(function(r){t.logger.log("got the image",m(r)),t.player.xr&&t.player.xr.session?t.player.xr.addImageAnchoredNode(e,r,t.logger):t.logger.log("XR is not active?")})}},{key:"startGeoRecognizer",value:function(e){this.player.xr&&this.player.xr.session?this.player.xr.addGeoAnchoredNode(e):this.logger.log("XR is not active?")}},{key:"stopGeoRecognizer",value:function(){console.log("WE NEED TO STOP ALL geo recognizers here")}}]),t}(dr),In=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).showProviderList=function(e){h.f.show(i.a.createElement(h.g,null,r.providers.map(function(e){return i.a.createElement("button",{key:e,onClick:function(){return r.openNewProvider(e)}},e)})),e.target)},r.state={switcher:!1},r.providers=["vr","metadoc"];var n=r.props.options.switcher;return"undefined"===typeof n||!0!==n&&"true"!==n||(r.state.switcher=!0),r}return Object(p.a)(t,e),Object(c.a)(t,[{key:"getApp",value:function(){var e=this.props.options.doctype||"vr";return"vr"===e?"play"===this.props.options.mode?(console.log("doing play instead"),i.a.createElement(Dn,{options:this.props.options})):(this.provider=new Sn(this.props.options),this.provider.getApp()):"metadoc"===e?(this.provider=new nr(this.props.options),this.provider.getApp()):void 0}},{key:"openNewProvider",value:function(e){h.f.hide(),window.open("./?mode=edit&doctype=".concat(e))}},{key:"render",value:function(){return this.state.switcher?i.a.createElement(h.g,{fill:!0},i.a.createElement("button",{style:{position:"absolute",zIndex:10},onClick:this.showProviderList},i.a.createElement("img",{src:"icon.png",alt:"switch apps",height:"20",style:{padding:"0em"}})),i.a.createElement("div",{style:{position:"relative",flex:"1"}},this.getApp()),i.a.createElement(h.b,null),i.a.createElement(h.e,null)):this.getApp()}}]),t}(n.Component),Tn=y({mode:"edit"});console.log("options is",Tn),s.a.render(i.a.createElement(In,{options:Tn}),document.getElementById("root"))}},[[43,2,1]]]);
//# sourceMappingURL=main.315b3c92.chunk.js.map